<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ø°Ù‡Ø¨ â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-sync.js"></script>
<style>
.chart-wrap { position:relative; width:100%; height:280px; }
.chart-wrap canvas { width:100% !important; height:100% !important; }
</style>
</head>
<body>
<script>initPage('gold');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ¥‡ Ø§Ù„Ø°Ù‡Ø¨</h1>
      <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ø§Ù„Ø°Ù‡Ø¨</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="kpi-grid cols-4" id="goldKPIs"></div>

  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ«Ù…Ø§Ø± Ø°Ù‡Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ø§Ù„Ù†ÙˆØ¹</label>
        <select id="g-type">
          <option value="Ø³Ø¨ÙŠÙƒØ©">Ø³Ø¨ÙŠÙƒØ©</option>
          <option value="Ø¹Ù…Ù„Ø©">Ø¹Ù…Ù„Ø©</option>
          <option value="Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª">Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª</option>
          <option value="Ø£ÙˆÙ†ØµØ§Øª">Ø£ÙˆÙ†ØµØ§Øª</option>
          <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ø§Ù„ÙˆØ²Ù†</label>
        <input id="g-weight" type="number" step="0.01" placeholder="50">
      </div>
      <div class="form-group">
        <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
        <select id="g-unit">
          <option value="Ø¬Ø±Ø§Ù…">Ø¬Ø±Ø§Ù…</option>
          <option value="ÙƒÙŠÙ„Ùˆ">ÙƒÙŠÙ„Ùˆ</option>
          <option value="Ø£ÙˆÙ†ØµØ©">Ø£ÙˆÙ†ØµØ©</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù„Ù„Ø¬Ø±Ø§Ù…/Ø±.Ø³)</label>
        <input id="g-purchase-price" type="number" step="0.01" placeholder="280">
      </div>
      <div class="form-group">
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</label>
        <input id="g-purchase-date" type="date">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„Ø¬Ø±Ø§Ù…/Ø±.Ø³)</label>
        <input id="g-current-price" type="number" step="0.01" placeholder="310">
      </div>
    </div>
    <div class="form-group">
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="g-notes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
    </div>
    <button class="btn btn-primary" onclick="addGold()">â• Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ“Š Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</div>
      <div class="chart-wrap"><canvas id="byTypeChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“ˆ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</div>
      <div class="chart-wrap"><canvas id="pnlChart"></canvas></div>
    </div>
  </div>

  <div class="toolbar">
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="applySearch(this.value)">
    <span id="trCount" style="color:var(--text3);font-size:13px"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØ²Ù†</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
          <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
          <th>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th><th>%</th>
          <th>ØªØ¹Ø¯ÙŠÙ„</th><th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="goldBody"></tbody>
    </table>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gold = [];
let filtered = [];
let searchQ = '';
let chartType = null, chartPnL = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  gold = APP.gold;
  filtered = [...gold];
  renderKPIs();
  renderTable();
  renderCharts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKPIs() {
  const totalValue = gold.reduce((s, g) => {
    const weightInGrams = g.unit === 'ÙƒÙŠÙ„Ùˆ' ? g.weight * 1000 : g.weight;
    return s + weightInGrams * (parseFloat(g.current_price) || 0);
  }, 0);

  const totalCost = gold.reduce((s, g) => {
    const weightInGrams = g.unit === 'ÙƒÙŠÙ„Ùˆ' ? g.weight * 1000 : g.weight;
    return s + weightInGrams * (parseFloat(g.purchase_price) || 0);
  }, 0);

  const totalPnL = totalValue - totalCost;

  const totalWeight = gold.reduce((s, g) => {
    const weightInGrams = g.unit === 'ÙƒÙŠÙ„Ùˆ' ? g.weight * 1000 : g.weight;
    return s + weightInGrams;
  }, 0);

  const kpis = [
    { label:'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©',  value:H.fmt(totalValue, 0) + ' Ø±.Ø³',     icon:'ğŸ’°' },
    { label:'Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©', value:H.fmt(totalCost, 0) + ' Ø±.Ø³',      icon:'ğŸ“¥' },
    { label:'Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©',     value:H.fmt(totalPnL, 0) + ' Ø±.Ø³',       icon:'ğŸ“Š', color:H.colorClass(totalPnL) },
    { label:'Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',    value:H.fmt(totalWeight, 2) + ' Ø¬Ø±Ø§Ù…',   icon:'âš–ï¸' }
  ];

  document.getElementById('goldKPIs').innerHTML = kpis.map(k => `
    <div class="kpi-card">
      <div class="kpi-icon">${k.icon}</div>
      <div class="kpi-value ${k.color || ''}">${k.value}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Add Gold
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addGold() {
  const type = document.getElementById('g-type').value;
  const weight = parseFloat(document.getElementById('g-weight').value) || 0;
  const unit = document.getElementById('g-unit').value;
  const purchase_price = parseFloat(document.getElementById('g-purchase-price').value) || 0;
  const purchase_date = document.getElementById('g-purchase-date').value;
  const current_price = parseFloat(document.getElementById('g-current-price').value) || 0;
  const notes = document.getElementById('g-notes').value.trim();

  if (!weight || !purchase_price) {
    toast('âš ï¸ Ø§Ù„ÙˆØ²Ù† ÙˆØ³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†', 'warn');
    return;
  }

  const newGold = {
    id: Date.now(),
    type,
    weight,
    unit,
    purchase_price,
    purchase_date: purchase_date || H.today(),
    current_price,
    notes
  };

  gold.push(newGold);

  // Clear
  document.getElementById('g-weight').value = '';
  document.getElementById('g-purchase-price').value = '';
  document.getElementById('g-purchase-date').value = '';
  document.getElementById('g-current-price').value = '';
  document.getElementById('g-notes').value = '';

  saveAll();
  init();
  toast('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const tbody = document.getElementById('goldBody');

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:40px;color:var(--text3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ø°Ù‡Ø¨</td></tr>';
    updateCount();
    return;
  }

  tbody.innerHTML = filtered.map(g => {
    const weightInGrams = g.unit === 'ÙƒÙŠÙ„Ùˆ' ? g.weight * 1000 : g.weight;
    const value = weightInGrams * (parseFloat(g.current_price) || 0);
    const cost = weightInGrams * (parseFloat(g.purchase_price) || 0);
    const pnl = value - cost;
    const pct = cost > 0 ? (pnl / cost * 100) : 0;

    return `
      <tr>
        <td><strong>${g.type}</strong></td>
        <td>${H.fmt(g.weight, 2)}</td>
        <td>${g.unit}</td>
        <td>${H.fmt(g.purchase_price, 2)}</td>
        <td>${H.fmt(g.current_price, 2)}</td>
        <td>${H.fmt(value, 2)}</td>
        <td>${H.fmt(cost, 2)}</td>
        <td style="${H.colorStyle(pnl)}">${H.fmt(pnl, 2)}</td>
        <td style="${H.colorStyle(pct)}">${H.pct(pct)}</td>
        <td><button class="btn btn-ghost btn-xs" onclick="editGold(${g.id})">âœï¸</button></td>
        <td><button class="btn btn-danger btn-xs" onclick="deleteGold(${g.id})">ğŸ—‘ï¸</button></td>
      </tr>
    `;
  }).join('');

  updateCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Edit/Delete
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editGold(id) {
  const g = gold.find(gd => gd.id === id);
  if (!g) return;

  const newPrice = prompt('Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ø¬Ø±Ø§Ù…):', g.current_price);
  if (newPrice === null || isNaN(newPrice)) return;

  g.current_price = parseFloat(newPrice);

  saveAll();
  init();
  toast('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

function deleteGold(id) {
  if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ØŸ')) return;

  gold = gold.filter(g => g.id !== id);

  saveAll();
  init();
  toast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Search
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applySearch(q) {
  searchQ = q.trim().toLowerCase();
  filtered = searchQ
    ? gold.filter(g =>
        (g.type || '').toLowerCase().includes(searchQ) ||
        (g.unit || '').toLowerCase().includes(searchQ)
      )
    : [...gold];
  renderTable();
}

function updateCount() {
  document.getElementById('trCount').textContent =
    `${filtered.length} Ù…Ù† ${gold.length} Ø§Ø³ØªØ«Ù…Ø§Ø±`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Charts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts() {
  if (!gold.length) {
    document.querySelector('#byTypeChart').parentElement.innerHTML = '<p style="text-align:center;color:var(--text3);padding:60px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    document.querySelector('#pnlChart').parentElement.innerHTML = '<p style="text-align:center;color:var(--text3);padding:60px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    return;
  }

  // By Type
  const byType = {};
  gold.forEach(g => {
    const type = g.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const weightInGrams = g.unit === 'ÙƒÙŠÙ„Ùˆ' ? g.weight * 1000 : g.weight;
    byType[type] = (byType[type] || 0) + weightInGrams;
  });

  const typeData = Object.entries(byType).sort((a,b) => b[1] - a[1]);

  const ctx1 = document.getElementById('byTypeChart').getContext('2d');
  if (chartType) chartType.destroy();
  chartType = new Chart(ctx1, {
    type: 'doughnut',
    data: {
      labels: typeData.map(t => t[0]),
      datasets: [{
        data: typeData.map(t => t[1]),
        backgroundColor: ['#6366f1','#8b5cf6','#ec4899','#f59e0b','#10b981'],
        borderWidth: 2,
        borderColor: 'var(--card)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { color: 'var(--text)', font: { size: 11 } } },
        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${H.fmt(ctx.parsed, 2)} Ø¬Ø±Ø§Ù…` } }
      }
    }
  });

  // PnL
  const pnlData = gold.map(g => {
    const weightInGrams = g.unit === 'ÙƒÙŠÙ„Ùˆ' ? g.weight * 1000 : g.weight;
    const value = weightInGrams * (parseFloat(g.current_price) || 0);
    const cost = weightInGrams * (parseFloat(g.purchase_price) || 0);
    const pnl = value - cost;
    return { type: g.type, pnl };
  }).sort((a,b) => b.pnl - a.pnl);

  const ctx2 = document.getElementById('pnlChart').getContext('2d');
  if (chartPnL) chartPnL.destroy();
  chartPnL = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: pnlData.map(d => d.type),
      datasets: [{
        label: 'Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© (Ø±.Ø³)',
        data: pnlData.map(d => d.pnl),
        backgroundColor: pnlData.map(d => d.pnl >= 0 ? '#10b981' : '#ef4444'),
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { ticks: { color: 'var(--text3)' }, grid: { color: 'var(--border)' } },
        x: { ticks: { color: 'var(--text3)' }, grid: { display: false } }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAll() {
  Store.save('gold_v1', gold);
  toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  dataSync.emit('gold');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sync
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
dataSync.onDataChanged('gold', init);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Run
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>

</body>
</html>
