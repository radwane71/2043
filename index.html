<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>2043 — دخول</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<style>
.login-container {
  display:flex; align-items:center; justify-content:center;
  min-height:100vh; padding:20px; background:var(--bg);
}
.login-card {
  background:var(--card); border:1px solid var(--border);
  border-radius:20px; padding:48px 40px; width:100%; max-width:420px;
  box-shadow:0 8px 32px rgba(0,0,0,.3); text-align:center;
}
.login-logo { font-size:64px; font-weight:900; color:var(--accent); margin-bottom:12px; }
.login-subtitle { font-size:15px; color:var(--text3); margin-bottom:36px; }
.pin-input {
  width:100%; padding:16px; font-size:24px; text-align:center;
  background:var(--bg2); border:2px solid var(--border);
  border-radius:12px; color:var(--text); font-weight:700;
  letter-spacing:8px; outline:none; transition:all .2s;
  font-family:inherit; margin-bottom:20px;
}
.pin-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(99,102,241,.1); }
.login-btn {
  width:100%; padding:16px; font-size:16px; font-weight:700;
  background:var(--accent); color:#fff; border:none;
  border-radius:12px; cursor:pointer; transition:all .2s;
  font-family:inherit;
}
.login-btn:hover { background:var(--accent-hover); transform:translateY(-2px); }
.login-btn:active { transform:translateY(0); }
.error-msg {
  background:rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.3);
  color:var(--red); padding:12px; border-radius:8px;
  font-size:13px; margin-top:16px; display:none;
}
.setup-mode { display:none; }
.first-time { font-size:13px; color:var(--text3); margin-top:24px; }
</style>
</head>
<body>

<div class="login-container">
  <div class="login-card">
    <div class="login-logo">◈</div>
    <h1 style="margin:0 0 8px; font-size:28px">2043</h1>
    <p class="login-subtitle" id="subtitle">محفظتك المالية الشاملة</p>

    <!-- Login Mode -->
    <div id="loginMode">
      <input 
        type="password" 
        class="pin-input" 
        id="pinInput" 
        placeholder="••••"
        maxlength="4"
        inputmode="numeric"
        autocomplete="off">
      <button class="login-btn" onclick="handleLogin()">دخول</button>
      <div class="error-msg" id="errorMsg"></div>
    </div>

    <!-- Setup Mode -->
    <div id="setupMode" class="setup-mode">
      <input 
        type="password" 
        class="pin-input" 
        id="setupPin1" 
        placeholder="••••"
        maxlength="4"
        inputmode="numeric"
        autocomplete="off">
      <input 
        type="password" 
        class="pin-input" 
        id="setupPin2" 
        placeholder="تأكيد ••••"
        maxlength="4"
        inputmode="numeric"
        autocomplete="off"
        style="margin-top:12px">
      <button class="login-btn" onclick="handleSetup()">إنشاء</button>
      <div class="error-msg" id="setupError"></div>
    </div>

    <p class="first-time" id="firstTimeMsg"></p>
  </div>
</div>

<script>
// ══════════════════════════════════════════════
//  Init
// ══════════════════════════════════════════════
window.addEventListener('DOMContentLoaded', () => {
  if (AUTH.isLoggedIn()) {
    window.location.href = 'dashboard.html';
    return;
  }

  const isSetup = AUTH.isSetup();
  
  if (!isSetup) {
    // أول مرة — وضع الإعداد
    document.getElementById('subtitle').textContent = 'أهلاً بك! أنشئ رمز دخول';
    document.getElementById('loginMode').style.display = 'none';
    document.getElementById('setupMode').style.display = 'block';
  } else {
    // وضع الدخول العادي
    document.getElementById('firstTimeMsg').innerHTML = 
      '<span style="color:var(--text3)">نسيت الرمز؟</span> <a href="#" onclick="resetApp(); return false" style="color:var(--accent); text-decoration:none; font-weight:600">إعادة تعيين</a>';
  }

  // Enter key support
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      if (!isSetup) handleSetup();
      else handleLogin();
    }
  });
});

// ══════════════════════════════════════════════
//  Login
// ══════════════════════════════════════════════
function handleLogin() {
  const pin = document.getElementById('pinInput').value.trim();
  const errorEl = document.getElementById('errorMsg');

  if (!pin || pin.length < 4) {
    showError(errorEl, 'الرجاء إدخال رمز مكون من 4 أرقام');
    return;
  }

  if (AUTH.login(pin)) {
    window.location.href = 'dashboard.html';
  } else {
    showError(errorEl, '❌ رمز الدخول غير صحيح');
    document.getElementById('pinInput').value = '';
    document.getElementById('pinInput').focus();
  }
}

// ══════════════════════════════════════════════
//  Setup
// ══════════════════════════════════════════════
function handleSetup() {
  const pin1 = document.getElementById('setupPin1').value.trim();
  const pin2 = document.getElementById('setupPin2').value.trim();
  const errorEl = document.getElementById('setupError');

  if (!pin1 || pin1.length < 4) {
    showError(errorEl, 'الرمز يجب أن يكون 4 أرقام على الأقل');
    return;
  }

  if (pin1 !== pin2) {
    showError(errorEl, 'الرمزان غير متطابقان');
    return;
  }

  AUTH.setup(pin1);
  toast('✅ تم إنشاء حسابك بنجاح', 'success');
  setTimeout(() => { window.location.href = 'dashboard.html'; }, 1200);
}

// ══════════════════════════════════════════════
//  Reset App
// ══════════════════════════════════════════════
function resetApp() {
  if (!confirm('⚠️ سيتم حذف جميع البيانات ورمز الدخول. هل أنت متأكد؟')) return;
  if (!confirm('⚠️ تأكيد نهائي: لا يمكن التراجع عن هذا الإجراء!')) return;
  
  localStorage.clear();
  sessionStorage.clear();
  toast('تم إعادة التعيين بنجاح', 'success');
  setTimeout(() => { window.location.reload(); }, 1000);
}

// ══════════════════════════════════════════════
//  Helpers
// ══════════════════════════════════════════════
function showError(el, msg) {
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}
</script>

</body>
</html>
