<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<style>
.chart-wrap {
  position:relative; width:100%; height:260px; overflow:hidden;
}
.chart-wrap canvas {
  position:absolute !important; top:0 !important; left:0 !important;
  width:100% !important; height:100% !important;
}
.progress-bar-wrap {
  background:var(--border); border-radius:4px; height:6px;
  overflow:hidden; margin-top:8px;
}
.progress-bar {
  height:100%; border-radius:4px;
  background:linear-gradient(90deg,var(--accent),var(--purple));
  transition:width 0.8s ease;
}
.stock-row-mini {
  display:flex; align-items:center; justify-content:space-between;
  padding:9px 0; border-bottom:1px solid var(--border); font-size:13px;
}
.stock-row-mini:last-child { border-bottom:none; }
.stock-row-mini .name   { font-weight:600; }
.stock-row-mini .ticker { color:var(--text3); font-size:11px; }
.rule-item {
  display:flex; align-items:flex-start; gap:10px;
  padding:10px 0; border-bottom:1px solid var(--border);
  font-size:13px; color:var(--text2);
}
.rule-item:last-child { border-bottom:none; }
.rule-item .rule-icon { flex-shrink:0; margin-top:1px; }

/* â”€â”€ Signals â”€â”€ */
.signal-item {
  display:flex; align-items:flex-start; gap:10px;
  padding:9px 12px; border-radius:8px; margin-bottom:7px;
  font-size:13px; border:1px solid;
}
.signal-item.buy  { background:rgba(34,197,94,.08);  border-color:rgba(34,197,94,.25);  }
.signal-item.sell { background:rgba(245,158,11,.08); border-color:rgba(245,158,11,.25); }

/* â”€â”€ Geo â”€â”€ */
.geo-bar-row {
  display:flex; align-items:center; gap:10px;
  margin-bottom:10px; font-size:13px;
}
.geo-bar-bg {
  flex:1; height:10px; background:var(--border);
  border-radius:5px; overflow:hidden;
}
.geo-bar-fill {
  height:100%; border-radius:5px;
}
</style>
</head>
<body>
<script>initPage('dashboard');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
      <p id="lastUpdate">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: â€”</p>
    </div>
    <div class="page-header-right">
      <span id="headerDate" style="color:var(--text3);font-size:13px"></span>
    </div>
  </div>

  <!-- KPI rows -->
  <div class="kpi-grid cols-4" id="kpiRow1"></div>
  <div class="kpi-grid cols-4" id="kpiRow2"></div>

  <!-- Signals row -->
  <div class="chart-grid cols-2" style="margin-bottom:0">
    <div class="chart-card">
      <div class="chart-title">ğŸŸ¢ Ø£Ø³Ù‡Ù… ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ØªØ¬Ù…ÙŠØ¹</div>
      <div id="buySignals"></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸŸ¡ Ø£Ø³Ù‡Ù… ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ØªØ®ÙÙŠÙ</div>
      <div id="sellSignals"></div>
    </div>
  </div>

  <!-- Charts row 1 -->
  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ¥§ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</div>
      <div class="chart-wrap"><canvas id="sectorChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“Š Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù‡Ø¯Ù</div>
      <div class="chart-wrap"><canvas id="allocChart"></canvas></div>
    </div>
  </div>

  <!-- Charts row 2 -->
  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ’° Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³Ù‡Ù…</div>
      <div class="chart-wrap"><canvas id="divChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸŒ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</div>
      <div id="geoBox" style="padding:8px 0"></div>
    </div>
  </div>

  <!-- Charts row 3 -->
  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ“ˆ ØªÙ‚Ø¯Ù… Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù</div>
      <div style="padding:12px 0" id="goalProgress"></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ† Ø£ÙØ¶Ù„ ÙˆØ£Ø³ÙˆØ£ Ø§Ù„Ø£Ø³Ù‡Ù… Ø£Ø¯Ø§Ø¡Ù‹</div>
      <div id="topStocks"></div>
    </div>
  </div>

  <!-- Rules -->
  <div class="chart-card">
    <div class="chart-title">ğŸ“– Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</div>
    <div id="rulesBox" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0 24px"></div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const portfolio    = Store.load('portfolio_v1',    APP.portfolio);
const settings     = APP.settings;
const divs         = Store.load('dividends_v1',    APP.dividends);
const transactions = Store.load('transactions_v1', APP.transactions);

const TICKER_MAP = {};
TICKERS.forEach(t => { TICKER_MAP[t.code] = t; });

// â”€â”€ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© Ù…Ù† current_price
const totalMkt = portfolio.reduce((s,p) => s + p.qty * p.current_price, 0);

// â”€â”€ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø´Ø±Ø§Ø¡ - Ø¨ÙŠØ¹ + Ø¹Ù…ÙˆÙ„Ø© + Ø¶Ø±ÙŠØ¨Ø©)
const totalBought = transactions
  .filter(t => t.status === 'Buy')
  .reduce((s,t) => s + (t.total_cost || 0), 0);
const totalSold = transactions
  .filter(t => t.status === 'Sell')
  .reduce((s,t) => s + (t.total_cost || 0), 0);
const netCost = totalBought - totalSold;

// â”€â”€ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª
const totalDiv = divs.reduce((s,d) => s + d.amount, 0);

// â”€â”€ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ù‚ÙŠØ© = Ù‚ÙŠÙ…Ø© Ø³ÙˆÙ‚ÙŠØ© - ØµØ§ÙÙŠ ØªÙƒÙ„ÙØ©
const paperPL    = totalMkt - netCost;
const paperPLPct = netCost > 0 ? paperPL / netCost : 0;

// â”€â”€ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„ = Ø±/Ø® ÙˆØ±Ù‚ÙŠØ© + ØªÙˆØ²ÙŠØ¹Ø§Øª
const totalReturn    = paperPL + totalDiv;
const totalReturnPct = netCost > 0 ? totalReturn / netCost : 0;

// â”€â”€ Ø¹Ø§Ø¦Ø¯ Ø¢Ø®Ø± 12 Ø´Ù‡Ø±
const now    = new Date();
const ago12  = new Date(now); ago12.setMonth(ago12.getMonth() - 12);
const ago6   = new Date(now); ago6.setMonth(ago6.getMonth() - 6);

const div12m   = divs.filter(d => d.date && new Date(d.date) >= ago12).reduce((s,d)=>s+d.amount,0);
const div6m    = divs.filter(d => d.date && new Date(d.date) >= ago6 ).reduce((s,d)=>s+d.amount,0);
const yield12m = netCost > 0 ? div12m / netCost * 100 : 0;
const yield6m  = netCost > 0 ? div6m  / netCost * 100 : 0;

// â”€â”€ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ù…Ù† TICKER_MAP
const sectors = [...new Set(portfolio.map(p => {
  const info = TICKER_MAP[p.ticker];
  return info?.sector || p.sector || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
}))].length;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Header
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('headerDate').textContent = new Date().toLocaleDateString('ar-SA',{
  weekday:'long', year:'numeric', month:'long', day:'numeric'
});
document.getElementById('lastUpdate').textContent =
  `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${APP.netWorth?.lastUpdated || 'â€”'}`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPI Row 1 â€” Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø§Ù„ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('kpiRow1').innerHTML = `
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ’¹</div>
    <div class="kpi-label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</div>
    <div class="kpi-value accent">${H.fmt(totalMkt)}</div>
    <div class="kpi-sub">ØµØ§ÙÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©: ${H.fmt(netCost)}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ“ˆ</div>
    <div class="kpi-label">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„</div>
    <div class="kpi-value ${totalReturn>=0?'pos':'neg'}">${totalReturn>=0?'+':''}${H.fmt(totalReturn)}</div>
    <div class="kpi-sub">Ø±/Ø® + ØªÙˆØ²ÙŠØ¹Ø§Øª â€¢ ${H.pct(totalReturnPct)}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ—“ï¸</div>
    <div class="kpi-label">Ø¹Ø§Ø¦Ø¯ Ø¢Ø®Ø± 12 Ø´Ù‡Ø±</div>
    <div class="kpi-value ${yield12m >= settings.targetYield*100 ? 'pos':'warn'}">${H.fmt(yield12m,2)}%</div>
    <div class="kpi-sub">${H.fmt(div12m)} SAR ØªÙˆØ²ÙŠØ¹Ø§Øª</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ“…</div>
    <div class="kpi-label">Ø¹Ø§Ø¦Ø¯ Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±</div>
    <div class="kpi-value">${H.fmt(yield6m,2)}%</div>
    <div class="kpi-sub">${H.fmt(div6m)} SAR ØªÙˆØ²ÙŠØ¹Ø§Øª</div>
  </div>`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPI Row 2 â€” Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const toAccum  = portfolio.filter(p => p.decision.includes('ØªØ¬Ù…ÙŠØ¹')).length;
const toReduce = portfolio.filter(p => p.decision.includes('ØªØ®ÙÙŠÙ')).length;

document.getElementById('kpiRow2').innerHTML = `
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ¦</div>
    <div class="kpi-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙƒØ²</div>
    <div class="kpi-value">${portfolio.length}</div>
    <div class="kpi-sub">Ù…Ù† ${settings.minPositions}â€“${settings.maxPositions} Ù…Ø³ØªÙ‡Ø¯Ù</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ—‚ï¸</div>
    <div class="kpi-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</div>
    <div class="kpi-value">${sectors}</div>
    <div class="kpi-sub">ØªÙ†ÙˆÙŠØ¹ Ù‚Ø·Ø§Ø¹ÙŠ</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ’°</div>
    <div class="kpi-label">Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</div>
    <div class="kpi-value pos">${H.fmt(totalDiv)}</div>
    <div class="kpi-sub">YOC ${H.fmt(div12m/netCost*100,2)}%</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ¯</div>
    <div class="kpi-label">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
    <div class="kpi-value warn">${H.fmt(settings.targetYield*100,1)}%</div>
    <div class="kpi-sub">ÙØ¬ÙˆØ© ${H.fmt(settings.targetYield*100 - yield12m,2)}%</div>
  </div>`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Signals â€” ØªØ¬Ù…ÙŠØ¹ / ØªØ®ÙÙŠÙ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const buyList = portfolio.filter(p =>
  p.decision.includes('ØªØ¬Ù…ÙŠØ¹') && p.current_price <= p.buy_zone_max
);
const sellList = portfolio.filter(p =>
  p.decision.includes('ØªØ®ÙÙŠÙ') && p.current_price >= p.sell_zone_low
);

document.getElementById('buySignals').innerHTML = buyList.length
  ? buyList.map(p => `
      <div class="signal-item buy">
        <span>ğŸŸ¢</span>
        <div>
          <strong>${p.stock}</strong>
          <span style="color:var(--text3);font-size:12px"> â€¢ ${p.ticker}</span><br>
          <span style="font-size:12px;color:var(--text2)">
            Ø§Ù„Ø³Ø¹Ø± <strong>${H.fmt(p.current_price)}</strong> â† Ù…Ù†Ø·Ù‚Ø© Ø´Ø±Ø§Ø¡ Ø£Ù‚Ù„ Ù…Ù† ${H.fmt(p.buy_zone_max)}
          </span>
        </div>
      </div>`).join('')
  : '<p style="color:var(--text3);font-size:13px;padding:8px 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ØªØ¬Ù…ÙŠØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹</p>';

document.getElementById('sellSignals').innerHTML = sellList.length
  ? sellList.map(p => `
      <div class="signal-item sell">
        <span>ğŸŸ¡</span>
        <div>
          <strong>${p.stock}</strong>
          <span style="color:var(--text3);font-size:12px"> â€¢ ${p.ticker}</span><br>
          <span style="font-size:12px;color:var(--text2)">
            Ø§Ù„Ø³Ø¹Ø± <strong>${H.fmt(p.current_price)}</strong> â† Ù…Ù†Ø·Ù‚Ø© ØªØ®ÙÙŠÙ Ù…Ù† ${H.fmt(p.sell_zone_low)}
          </span>
        </div>
      </div>`).join('')
  : '<p style="color:var(--text3);font-size:13px;padding:8px 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ØªØ®ÙÙŠÙ Ø­Ø§Ù„ÙŠØ§Ù‹</p>';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sector Doughnut
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sectorMap = {};
portfolio.forEach(p => {
  const info   = TICKER_MAP[p.ticker];
  const sector = info?.sector || p.sector || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  sectorMap[sector] = (sectorMap[sector]||0) + p.qty * p.current_price;
});

const COLORS = [
  '#4f8ef7','#22c55e','#f59e0b','#ef4444','#a78bfa',
  '#06b6d4','#f97316','#84cc16','#ec4899','#14b8a6','#8b5cf6','#fb923c'
];

new Chart(document.getElementById('sectorChart'),{
  type:'doughnut',
  data:{
    labels: Object.keys(sectorMap),
    datasets:[{ data:Object.values(sectorMap), backgroundColor:COLORS,
      borderColor:'#131722', borderWidth:2 }]
  },
  options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{ position:'right', labels:{color:'#94a3b8',font:{size:11},padding:10,boxWidth:12} },
      tooltip:{ callbacks:{ label:ctx=>` ${H.fmt(ctx.raw)} SAR (${(ctx.raw/totalMkt*100).toFixed(1)}%)` } }
    }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Allocation Bar + ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const allocData = portfolio
  .map(p => ({
    name:   p.ticker,
    stock:  p.stock,
    goal:   p.goal_alloc * 100,
    actual: p.qty * p.current_price / totalMkt * 100,
  }))
  .sort((a,b) => b.goal - a.goal)
  .slice(0,12);

// ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù > 5%
const overAlloc = allocData.filter(d => d.goal > 0 && (d.actual - d.goal) > 5);
const allocWarnings = overAlloc.map(d =>
  `âš ï¸ <strong>${d.stock}</strong>: ÙØ¹Ù„ÙŠ ${d.actual.toFixed(1)}% Ù…Ù‚Ø§Ø¨Ù„ Ù‡Ø¯Ù ${d.goal.toFixed(1)}% (ØªØ¬Ø§ÙˆØ² +${(d.actual-d.goal).toFixed(1)}%)`
).join('<br>');

new Chart(document.getElementById('allocChart'),{
  type:'bar',
  data:{
    labels: allocData.map(d => {
      const over = d.goal > 0 && (d.actual - d.goal) > 5;
      return (over ? 'âš  ' : '') + d.name;
    }),
    datasets:[
      { label:'Ø§Ù„Ù‡Ø¯Ù %',  data:allocData.map(d=>d.goal),
        backgroundColor:'rgba(79,142,247,0.6)', borderRadius:3, maxBarThickness:22 },
      { label:'Ø§Ù„ÙØ¹Ù„ÙŠ %', data:allocData.map(d=>d.actual),
        backgroundColor: allocData.map(d =>
          (d.goal > 0 && (d.actual - d.goal) > 5)
            ? 'rgba(239,68,68,0.7)'
            : 'rgba(34,197,94,0.6)'
        ),
        borderRadius:3, maxBarThickness:22 },
    ]
  },
  options:{
    responsive:true, maintainAspectRatio:false,
    barPercentage:0.65, categoryPercentage:0.75,
    plugins:{
      legend:{ labels:{color:'#94a3b8',font:{size:11}} },
      tooltip:{ callbacks:{
        afterBody: (items) => {
          const d = allocData[items[0].dataIndex];
          if (d.goal > 0 && (d.actual - d.goal) > 5)
            return `âš  ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù‡Ø¯Ù Ø¨Ù€ ${(d.actual-d.goal).toFixed(1)}%`;
          return '';
        }
      }}
    },
    scales:{
      x:{ ticks:{color:'#64748b',font:{size:9},maxRotation:45}, grid:{color:'#1e2340'} },
      y:{ ticks:{color:'#64748b',callback:v=>v+'%'}, grid:{color:'#1e2340'} }
    }
  }
});

// ØªÙ†Ø¨ÙŠÙ‡ Ù†ØµÙŠ ØªØ­Øª Ø§Ù„Ø´Ø§Ø±Øª
if (overAlloc.length) {
  const warn = document.createElement('div');
  warn.style.cssText = 'margin-top:10px;padding:10px 14px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.3);border-radius:8px;font-size:12px;color:var(--red);line-height:1.8';
  warn.innerHTML = allocWarnings;
  document.getElementById('allocChart').closest('.chart-card').appendChild(warn);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Dividends Bar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const divMap = {};
divs.forEach(d => { divMap[d.stock] = (divMap[d.stock]||0) + d.amount; });
const divSorted = Object.entries(divMap).sort((a,b)=>b[1]-a[1]);

new Chart(document.getElementById('divChart'),{
  type:'bar',
  data:{
    labels: divSorted.map(d=>d[0]),
    datasets:[{ label:'SAR', data:divSorted.map(d=>d[1]),
      backgroundColor:'rgba(79,142,247,0.65)', borderRadius:4, maxBarThickness:32 }]
  },
  options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{display:false} },
    scales:{
      x:{ ticks:{color:'#64748b',font:{size:10}}, grid:{color:'#1e2340'} },
      y:{ ticks:{color:'#64748b'}, grid:{color:'#1e2340'} }
    }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Geographic Focus
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ÙƒÙ„ Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø³Ø¹ÙˆØ¯ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹
const geoData = [
  { label:'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© â€” Ù…Ø­Ù„ÙŠ',   pct: 100, color:'#4f8ef7' },
];

// Ù„Ùˆ Ø£Ø¶ÙØª Ø£Ø³Ù‡Ù… Ø¯ÙˆÙ„ÙŠØ© Ù„Ø§Ø­Ù‚Ø§Ù‹ â€” Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§
// const geoData = [
//   { label:'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©',  pct: 85, color:'#4f8ef7' },
//   { label:'ğŸ‡ºğŸ‡¸ Ø£Ù…Ø±ÙŠÙƒØ§',    pct: 10, color:'#22c55e' },
//   { label:'ğŸŒ Ø¢Ø®Ø±Ù‰',       pct:  5, color:'#f59e0b' },
// ];

document.getElementById('geoBox').innerHTML = `
  ${geoData.map(g => `
    <div class="geo-bar-row">
      <span style="min-width:180px;font-size:13px">${g.label}</span>
      <div class="geo-bar-bg">
        <div class="geo-bar-fill" style="width:${g.pct}%;background:${g.color}"></div>
      </div>
      <span style="min-width:40px;text-align:left;font-weight:700;color:${g.color}">${g.pct}%</span>
    </div>`).join('')}
  <p style="font-size:11px;color:var(--text3);margin-top:10px">
    ğŸ—ºï¸ ØªØ±ÙƒÙŠØ² Ø¬ØºØ±Ø§ÙÙŠ: <strong>100% Ù…Ø­Ù„ÙŠ</strong> â€” Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (ØªØ¯Ø§ÙˆÙ„)
  </p>`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Goal Progress
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const progressPct = Math.min(totalMkt / settings.targetCapital * 100, 100);
const yearsLeft   = settings.retirementYear - new Date().getFullYear();

document.getElementById('goalProgress').innerHTML = `
  <div style="margin-bottom:18px">
    <div style="display:flex;justify-content:space-between;margin-bottom:6px">
      <span style="font-size:13px;color:var(--text2)">Ø§Ù„ØªÙ‚Ø¯Ù… Ù†Ø­Ùˆ ${H.fmt(settings.targetCapital)} SAR</span>
      <span style="font-size:13px;font-weight:700;color:var(--accent)">${progressPct.toFixed(1)}%</span>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" style="width:${progressPct}%"></div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px;color:var(--text3)">
      <span>${H.fmt(totalMkt)} SAR Ø­Ø§Ù„ÙŠØ§Ù‹</span>
      <span>${H.fmt(settings.targetCapital - totalMkt)} SAR Ù…ØªØ¨Ù‚ÙŠ</span>
    </div>
  </div>
  <div class="kpi-grid cols-2" style="margin:0">
    <div class="kpi-card" style="padding:14px">
      <div class="kpi-label">Ø³Ù†ÙˆØ§Øª Ù„Ù„ØªÙ‚Ø§Ø¹Ø¯</div>
      <div class="kpi-value warn">${yearsLeft}</div>
      <div class="kpi-sub">${settings.retirementYear}</div>
    </div>
    <div class="kpi-card" style="padding:14px">
      <div class="kpi-label">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</div>
      <div class="kpi-value pos">${H.fmt(settings.targetCapital * settings.targetYield)}</div>
      <div class="kpi-sub">SAR</div>
    </div>
  </div>`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Top / Worst Stocks
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sorted = [...portfolio]
  .map(p => ({ ...p, pl:(p.current_price - p.avg_cost) / p.avg_cost }))
  .sort((a,b) => b.pl - a.pl);

document.getElementById('topStocks').innerHTML =
  [...sorted.slice(0,4), ...sorted.slice(-3)].map(p => `
    <div class="stock-row-mini">
      <div>
        <div class="name">${p.stock}</div>
        <div class="ticker">${p.ticker} â€¢ ${p.sector}</div>
      </div>
      <div style="text-align:left">
        <div class="${p.pl>=0?'pos':'neg'}" style="font-weight:700">
          ${p.pl>=0?'+':''}${(p.pl*100).toFixed(2)}%
        </div>
        <div style="font-size:11px;color:var(--text3)">${H.fmt(p.current_price)} SAR</div>
      </div>
    </div>`).join('');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Rules
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rules = [
  { icon:'ğŸ›¡ï¸', text:'Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø£Ù‡Ù… Ù…Ù† Ø§Ù„Ø±Ø¨Ø­. Ù†Ù… Ù‚Ø±ÙŠØ± Ø§Ù„Ø¹ÙŠÙ†.' },
  { icon:'â³', text:'Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø£Ù‡Ù… Ù…Ù† ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø³ÙˆÙ‚.' },
  { icon:'ğŸ§Š', text:'Ø³ÙˆÙ‚ Ø§Ù„Ø£Ø³Ù‡Ù… ÙŠÙƒØ§ÙØ¦ Ø§Ù„ØµØ¨ÙˆØ± Ø¬Ø¯Ø§Ù‹.' },
  { icon:'ğŸ’', text:'Ù„Ø§ ØªØ¨ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø£Ø¨Ø¯Ø§Ù‹.' },
  { icon:'ğŸ”´', text:'Ø±ÙŠØ§Ù„ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ù…Ù…Ù†ÙˆØ¹ ÙŠØ®Ø±Ø¬.' },
  { icon:'ğŸ“', text:'Ø£Ù†Øª Defensive Investor â€” Ù„Ø§ ØªØªØµØ±Ù ÙƒØ§Ù„Ù…Ø¶Ø§Ø±Ø¨.' },
];

document.getElementById('rulesBox').innerHTML = rules.map(r=>`
  <div class="rule-item">
    <span class="rule-icon">${r.icon}</span>
    <span>${r.text}</span>
  </div>`).join('');
</script>
</body>
</html>
