<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ù…Ø­ÙØ¸Ø© 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<style>
  .progress-bar-wrap {
    background: var(--border);
    border-radius: 4px;
    height: 6px;
    overflow: hidden;
    margin-top: 8px;
  }
  .progress-bar {
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--accent), var(--purple));
    transition: width 0.8s ease;
  }
  .stock-row-mini {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 9px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .stock-row-mini:last-child { border-bottom: none; }
  .stock-row-mini .name   { font-weight: 600; }
  .stock-row-mini .ticker { color: var(--text3); font-size: 11px; }
  .rule-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    color: var(--text2);
  }
  .rule-item:last-child  { border-bottom: none; }
  .rule-item .rule-icon  { flex-shrink: 0; margin-top: 1px; }

  /* â”€â”€ Chart wrapper â€” Ø§Ù„Ø­Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù€ Chart.js â”€â”€ */
  .chart-wrap {
    position: relative;
    width: 100%;
    height: 240px;      /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ù‡Ù†Ø§ ÙÙ‚Ø· */
  }
  .chart-wrap canvas {
    position: absolute !important;
    top: 0; left: 0;
    width: 100% !important;
    height: 100% !important;
  }
</style>
</head>
<body>
<script>initPage('dashboard');</script>

<div class="main">

  <!-- Header -->
  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
      <p id="lastUpdate">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: â€”</p>
    </div>
    <div class="page-header-right">
      <span id="headerDate" style="color:var(--text3);font-size:13px"></span>
    </div>
  </div>

  <!-- KPIs Row 1 -->
  <div class="kpi-grid cols-4" id="kpiRow1"></div>

  <!-- KPIs Row 2 -->
  <div class="kpi-grid cols-4" id="kpiRow2"></div>

  <!-- Charts Row 1 -->
  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ¥§ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</div>
      <div class="chart-wrap">
        <canvas id="sectorChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“Š Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù‡Ø¯Ù</div>
      <div class="chart-wrap">
        <canvas id="allocChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Charts Row 2 -->
  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ’° Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³Ù‡Ù…</div>
      <div class="chart-wrap">
        <canvas id="divChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“ˆ ØªÙ‚Ø¯Ù… Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù</div>
      <div style="padding:16px 0" id="goalProgress"></div>
    </div>
  </div>

  <!-- Bottom Row -->
  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ† Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ù‡Ù… Ø£Ø¯Ø§Ø¡Ù‹</div>
      <div id="topStocks"></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“– Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</div>
      <div id="rulesBox"></div>
    </div>
  </div>

</div>

<script>
const portfolio = Store.load('portfolio_v1', APP.portfolio);
const settings  = APP.settings;
const divs      = Store.load('dividends_v1', APP.dividends);

const totalCost = portfolio.reduce((s,p) => s + p.qty * p.avg_cost,      0);
const totalMkt  = portfolio.reduce((s,p) => s + p.qty * p.current_price, 0);
const totalPL   = totalMkt - totalCost;
const plPct     = totalPL / totalCost;
const totalDiv  = divs.reduce((s,d) => s + d.amount, 0);
const divYield  = totalDiv / totalCost;

// â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('headerDate').textContent = new Date().toLocaleDateString('ar-SA', {
  weekday:'long', year:'numeric', month:'long', day:'numeric'
});
document.getElementById('lastUpdate').textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${APP.netWorth.lastUpdated}`;

// â”€â”€ KPI Row 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('kpiRow1').innerHTML = `
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ’¹</div>
    <div class="kpi-label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</div>
    <div class="kpi-value accent">${H.fmt(totalMkt)}</div>
    <div class="kpi-sub">SAR â€” Ø§Ù„ØªÙƒÙ„ÙØ©: ${H.fmt(totalCost)}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ“ˆ</div>
    <div class="kpi-label">Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ù‚ÙŠØ©</div>
    <div class="kpi-value ${totalPL>=0?'pos':'neg'}">${totalPL>=0?'+':''}${H.fmt(totalPL)}</div>
    <div class="kpi-sub">${H.pct(plPct)} Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ„ÙØ©</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ’°</div>
    <div class="kpi-label">Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</div>
    <div class="kpi-value pos">${H.fmt(totalDiv)}</div>
    <div class="kpi-sub">Ø¹Ø§Ø¦Ø¯ ${H.fmt(divYield*100,2)}% Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ„ÙØ©</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ¯</div>
    <div class="kpi-label">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„Ø¹Ø§Ø¦Ø¯</div>
    <div class="kpi-value warn">${H.fmt(settings.targetYield*100,1)}%</div>
    <div class="kpi-sub">Ø±Ø£Ø³ Ù…Ø§Ù„ Ù…Ø³ØªÙ‡Ø¯Ù: ${H.fmt(settings.targetCapital)}</div>
  </div>
`;

// â”€â”€ KPI Row 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const positions = portfolio.length;
const sectors   = [...new Set(portfolio.map(p=>p.sector))].length;
const toAccum   = portfolio.filter(p=>p.decision.includes('ØªØ¬Ù…ÙŠØ¹')).length;
const toReduce  = portfolio.filter(p=>p.decision.includes('ØªØ®ÙÙŠÙ')).length;

document.getElementById('kpiRow2').innerHTML = `
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ¦</div>
    <div class="kpi-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙƒØ²</div>
    <div class="kpi-value">${positions}</div>
    <div class="kpi-sub">Ù…Ù† ${settings.minPositions}â€“${settings.maxPositions} Ù…Ø³ØªÙ‡Ø¯Ù</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">ğŸ—‚ï¸</div>
    <div class="kpi-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</div>
    <div class="kpi-value">${sectors}</div>
    <div class="kpi-sub">ØªÙ†ÙˆÙŠØ¹ Ù‚Ø·Ø§Ø¹ÙŠ</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">â¬†ï¸</div>
    <div class="kpi-label">Ø£Ø³Ù‡Ù… Ù„Ù„ØªØ¬Ù…ÙŠØ¹</div>
    <div class="kpi-value accent">${toAccum}</div>
    <div class="kpi-sub">ØªØ¬Ù…ÙŠØ¹ Ø¹Ù†Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø´Ø±Ø§Ø¡</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">â¬‡ï¸</div>
    <div class="kpi-label">Ø£Ø³Ù‡Ù… Ù„Ù„ØªØ®ÙÙŠÙ</div>
    <div class="kpi-value warn">${toReduce}</div>
    <div class="kpi-sub">ØªØ®ÙÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</div>
  </div>
`;

// â”€â”€ Sector Doughnut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sectorMap = {};
portfolio.forEach(p => {
  const v = p.qty * p.current_price;
  sectorMap[p.sector] = (sectorMap[p.sector]||0) + v;
});
const COLORS = [
  '#4f8ef7','#22c55e','#f59e0b','#ef4444','#a78bfa',
  '#06b6d4','#f97316','#84cc16','#ec4899','#14b8a6','#8b5cf6','#fb923c'
];

new Chart(document.getElementById('sectorChart'), {
  type: 'doughnut',
  data: {
    labels: Object.keys(sectorMap),
    datasets: [{
      data: Object.values(sectorMap),
      backgroundColor: COLORS,
      borderColor: '#131722',
      borderWidth: 2,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
        labels: { color:'#94a3b8', font:{size:11}, padding:10, boxWidth:12 }
      },
      tooltip: {
        callbacks: {
          label: ctx => ` ${H.fmt(ctx.raw)} SAR (${(ctx.raw/totalMkt*100).toFixed(1)}%)`
        }
      }
    }
  }
});

// â”€â”€ Allocation Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const allocData = portfolio
  .map(p => ({
    name:   p.stock.substring(0,7),
    goal:   p.goal_alloc * 100,
    actual: p.qty * p.current_price / totalMkt * 100,
  }))
  .sort((a,b) => b.goal - a.goal);

new Chart(document.getElementById('allocChart'), {
  type: 'bar',
  data: {
    labels: allocData.map(d=>d.name),
    datasets: [
      { label:'Ø§Ù„Ù‡Ø¯Ù %',  data: allocData.map(d=>d.goal),   backgroundColor:'rgba(79,142,247,0.5)', borderRadius:3 },
      { label:'Ø§Ù„ÙØ¹Ù„ÙŠ %', data: allocData.map(d=>d.actual), backgroundColor:'rgba(34,197,94,0.5)',  borderRadius:3 },
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend:{ labels:{ color:'#94a3b8', font:{size:11} } } },
    scales: {
      x: { ticks:{ color:'#64748b', font:{size:9} }, grid:{ color:'#1e2340' } },
      y: { ticks:{ color:'#64748b' },                grid:{ color:'#1e2340' } }
    }
  }
});

// â”€â”€ Dividends Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const divMap = {};
divs.forEach(d => { divMap[d.stock] = (divMap[d.stock]||0) + d.amount; });
const divSorted = Object.entries(divMap).sort((a,b)=>b[1]-a[1]);

new Chart(document.getElementById('divChart'), {
  type: 'bar',
  data: {
    labels: divSorted.map(d=>d[0]),
    datasets: [{
      label: 'SAR',
      data:  divSorted.map(d=>d[1]),
      backgroundColor: 'rgba(79,142,247,0.6)',
      borderRadius: 4,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend:{ display:false } },
    scales: {
      x: { ticks:{ color:'#64748b', font:{size:10} }, grid:{ color:'#1e2340' } },
      y: { ticks:{ color:'#64748b' },                 grid:{ color:'#1e2340' } }
    }
  }
});

// â”€â”€ Goal Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const targetCap   = settings.targetCapital;
const progressPct = Math.min((totalMkt / targetCap) * 100, 100);
const yearsLeft   = settings.retirementYear - new Date().getFullYear();

document.getElementById('goalProgress').innerHTML = `
  <div style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;margin-bottom:6px">
      <span style="font-size:13px;color:var(--text2)">Ø§Ù„ØªÙ‚Ø¯Ù… Ù†Ø­Ùˆ ${H.fmt(targetCap)} SAR</span>
      <span style="font-size:13px;font-weight:700;color:var(--accent)">${progressPct.toFixed(1)}%</span>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" style="width:${progressPct}%"></div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px;color:var(--text3)">
      <span>${H.fmt(totalMkt)} SAR Ø­Ø§Ù„ÙŠØ§Ù‹</span>
      <span>${H.fmt(targetCap - totalMkt)} SAR Ù…ØªØ¨Ù‚ÙŠ</span>
    </div>
  </div>
  <div class="kpi-grid cols-2" style="margin:0">
    <div class="kpi-card" style="padding:14px">
      <div class="kpi-label">Ø³Ù†ÙˆØ§Øª Ù„Ù„ØªÙ‚Ø§Ø¹Ø¯</div>
      <div class="kpi-value warn">${yearsLeft}</div>
      <div class="kpi-sub">${settings.retirementYear}</div>
    </div>
    <div class="kpi-card" style="padding:14px">
      <div class="kpi-label">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
      <div class="kpi-value pos">${H.fmt(targetCap * settings.targetYield)}</div>
      <div class="kpi-sub">SAR ØªÙˆØ²ÙŠØ¹Ø§Øª</div>
    </div>
  </div>
`;

// â”€â”€ Top / Worst Stocks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sorted = [...portfolio]
  .map(p => ({ ...p, pl: (p.current_price - p.avg_cost) / p.avg_cost }))
  .sort((a,b) => b.pl - a.pl);

document.getElementById('topStocks').innerHTML =
  [...sorted.slice(0,5), ...sorted.slice(-3)].map(p => `
    <div class="stock-row-mini">
      <div>
        <div class="name">${p.stock}</div>
        <div class="ticker">${p.ticker}</div>
      </div>
      <div style="text-align:left">
        <div class="${p.pl>=0?'pos':'neg'}" style="font-weight:700">
          ${p.pl>=0?'+':''}${(p.pl*100).toFixed(2)}%
        </div>
        <div style="font-size:11px;color:var(--text3)">${H.fmt(p.current_price)}</div>
      </div>
    </div>
  `).join('');

// â”€â”€ Financial Bible â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const rules = [
  { icon:'ğŸ›¡ï¸', text:'Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø£Ù‡Ù… Ù…Ù† Ø§Ù„Ø±Ø¨Ø­. Ù†Ù… Ù‚Ø±ÙŠØ± Ø§Ù„Ø¹ÙŠÙ†.' },
  { icon:'â³', text:'Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø£Ù‡Ù… Ù…Ù† ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø³ÙˆÙ‚.' },
  { icon:'ğŸ§Š', text:'Ø³ÙˆÙ‚ Ø§Ù„Ø£Ø³Ù‡Ù… ÙŠÙƒØ§ÙØ¦ Ø§Ù„ØµØ¨ÙˆØ± Ø¬Ø¯Ø§Ù‹.' },
  { icon:'ğŸ’', text:'Ù„Ø§ ØªØ¨ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø£Ø¨Ø¯Ø§Ù‹.' },
  { icon:'ğŸ”´', text:'Ø±ÙŠØ§Ù„ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ù…Ù…Ù†ÙˆØ¹ ÙŠØ®Ø±Ø¬.' },
  { icon:'ğŸ“', text:'Ø£Ù†Øª Defensive Investor â€” Ù„Ø§ ØªØªØµØ±Ù ÙƒØ§Ù„Ù…Ø¶Ø§Ø±Ø¨.' },
];

document.getElementById('rulesBox').innerHTML = rules.map(r => `
  <div class="rule-item">
    <span class="rule-icon">${r.icon}</span>
    <span>${r.text}</span>
  </div>
`).join('');
</script>
</body>
</html>
