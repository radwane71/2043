<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<style>
.progress-bar-wrap {
  background: var(--border); border-radius: 4px; height: 8px; overflow: hidden; margin-top: 8px;
}
.progress-bar {
  height: 100%; border-radius: 4px;
  background: linear-gradient(90deg, var(--accent), var(--purple)); transition: width 0.8s ease;
}
.stock-row-mini {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 0; border-bottom: 1px solid var(--border); font-size: 13px;
}
.stock-row-mini:last-child { border-bottom: none; }
.stock-row-mini .sname  { font-weight: 600; }
.stock-row-mini .sticker { color: var(--text3); font-size: 11px; }
.signal-item {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 9px 12px; border-radius: 8px; margin-bottom: 7px;
  font-size: 13px; border: 1px solid;
}
.signal-item.buy  { background: rgba(34,197,94,.08);  border-color: rgba(34,197,94,.25); }
.signal-item.sell { background: rgba(245,158,11,.08); border-color: rgba(245,158,11,.25); }
.geo-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-size: 13px; }
.geo-bar-bg  { flex: 1; height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; }
.geo-bar-fill { height: 100%; border-radius: 5px; }
.rule-item {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 10px 0; border-bottom: 1px solid var(--border);
  font-size: 13px; color: var(--text2);
}
.rule-item:last-child { border-bottom: none; }
.rule-item .rule-icon { flex-shrink: 0; margin-top: 1px; }
.tx-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 0; border-bottom: 1px solid var(--border); font-size: 13px;
}
.tx-row:last-child { border-bottom: none; }
.chart-grid.col-4060 { grid-template-columns: 4fr 6fr; }
.chart-grid.col-6040 { grid-template-columns: 6fr 4fr; }
.quick-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
  gap: 12px; margin-bottom: 28px;
}
.quick-card {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 8px; padding: 20px 12px; background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); text-decoration: none; color: var(--text);
  font-size: 13px; font-weight: 600; transition: all 0.18s; cursor: pointer; text-align: center;
}
.quick-card:hover { border-color: var(--accent); background: rgba(79,142,247,0.06); transform: translateY(-2px); color: var(--accent); }
.quick-card .qc-icon  { font-size: 26px; line-height: 1; }
.quick-card .qc-label { font-size: 12px; color: var(--text2); font-weight: 500; margin-top: 2px; }
</style>
</head>
<body>
<script>initPage('dashboard');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
      <p id="lastUpdate">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: â€”</p>
    </div>
    <div class="page-header-right">
      <span id="headerDate" style="color:var(--text3);font-size:13px"></span>
    </div>
  </div>

  <div style="margin-bottom:8px">
    <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">ğŸ”— ÙˆØµÙˆÙ„ Ø³Ø±ÙŠØ¹</div>
    <div class="quick-grid">
      <a href="portfolio.html"     class="quick-card"><div class="qc-icon">ğŸ’¹</div><div>Ø§Ù„Ù…Ø­ÙØ¸Ø©</div><div class="qc-label">Portfolio</div></a>
      <a href="transactions.html" class="quick-card"><div class="qc-icon">ğŸ”„</div><div>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div><div class="qc-label">Transactions</div></a>
      <a href="dividends.html"    class="quick-card"><div class="qc-icon">ğŸ’°</div><div>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</div><div class="qc-label">Dividends</div></a>
      <a href="networth.html"     class="quick-card"><div class="qc-icon">ğŸ“Š</div><div>ØµØ§ÙÙŠ Ø§Ù„Ø«Ø±ÙˆØ©</div><div class="qc-label">Net Worth</div></a>
      <a href="properties.html"   class="quick-card"><div class="qc-icon">ğŸ¢</div><div>Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</div><div class="qc-label">Properties</div></a>
      <a href="cashinvest.html"   class="quick-card"><div class="qc-icon">ğŸ’µ</div><div>Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù„Ù„Ø¶Ø®</div><div class="qc-label">Cash to Invest</div></a>
      <a href="forecast.html"     class="quick-card"><div class="qc-icon">ğŸ”­</div><div>Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div><div class="qc-label">Forecast</div></a>
      <a href="salary.html"       class="quick-card"><div class="qc-icon">ğŸ’³</div><div>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨</div><div class="qc-label">Salary Records</div></a>
      <a href="salary-scale.html" class="quick-card"><div class="qc-icon">ğŸ“ˆ</div><div>Ø³Ù„Ù… Ø§Ù„Ø±Ø§ØªØ¨</div><div class="qc-label">Salary Scale</div></a>
      <a href="settings.html"     class="quick-card"><div class="qc-icon">âš™ï¸</div><div>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div><div class="qc-label">Settings</div></a>
    </div>
  </div>

  <div class="kpi-grid cols-4" id="kpiRow1"></div>
  <div class="kpi-grid cols-4" id="kpiRow2"></div>
  <div class="kpi-grid cols-4" id="kpiRow3"></div>

  <div class="chart-grid cols-2" style="margin-bottom:24px">
    <div class="chart-card"><div class="chart-title">ğŸŸ¢ Ø£Ø³Ù‡Ù… ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ØªØ¬Ù…ÙŠØ¹</div><div id="buySignals"></div></div>
    <div class="chart-card"><div class="chart-title">ğŸŸ¡ Ø£Ø³Ù‡Ù… ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ØªØ®ÙÙŠÙ</div><div id="sellSignals"></div></div>
  </div>

  <div class="chart-grid col-4060" style="margin-bottom:24px">
    <div class="chart-card">
      <div class="chart-title">ğŸ¥§ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</div>
      <div class="chart-wrap md"><canvas id="sectorChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“Š Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù‡Ø¯Ù</div>
      <div class="chart-wrap md"><canvas id="allocChart"></canvas></div>
      <div id="allocWarn"></div>
    </div>
  </div>

  <div class="chart-grid col-4060" style="margin-bottom:24px">
    <div class="chart-card">
      <div class="chart-title">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø¯Ù… Ù†Ø­Ùˆ Ù‡Ø¯Ù Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯</div>
      <div id="goalProgress" style="padding:8px 0"></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ† Ø£ÙØ¶Ù„ ÙˆØ£Ø³ÙˆØ£ Ø§Ù„Ø£Ø³Ù‡Ù… Ø£Ø¯Ø§Ø¡Ù‹</div>
      <div id="topStocks"></div>
    </div>
  </div>

  <div class="chart-grid col-6040" style="margin-bottom:24px">
    <div class="chart-card"><div class="chart-title">ğŸ”„ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div><div id="lastTx"></div></div>
    <div class="chart-card">
      <div class="chart-title">ğŸ’° Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø³Ù‡Ù…</div>
      <div class="chart-wrap md"><canvas id="divChart"></canvas></div>
    </div>
  </div>

  <div class="chart-card" style="margin-bottom:24px">
    <div class="chart-title">ğŸŒ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„Ù…Ø­ÙØ¸Ø©</div>
    <div id="geoBox" style="padding:8px 0;max-width:600px"></div>
  </div>

  <div class="chart-card">
    <div class="chart-title">ğŸ“– Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</div>
    <div id="rulesBox" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0 24px"></div>
  </div>

</div>

<script>
const portfolio    = Store.load('portfolio_v1',    APP.portfolio);
const settings     = APP.settings;
const divs         = Store.load('dividends_v1',    APP.dividends);
const transactions = Store.load('transactions_v1', APP.transactions);

const ALL_TICKERS = [...TICKERS, ...Store.load('custom_tickers', [])];
const TICKER_MAP  = {};
ALL_TICKERS.forEach(t => { TICKER_MAP[t.code] = t; });

const totalMkt    = portfolio.reduce((s,p) => s + p.qty * p.current_price, 0);
const totalBought = transactions.filter(t=>t.status==='Buy').reduce((s,t)=>s+(t.total_cost||0),0);
const totalSold   = transactions.filter(t=>t.status==='Sell').reduce((s,t)=>s+(t.total_cost||0),0);
const netCost     = totalBought - totalSold;
const totalDiv    = divs.reduce((s,d)=>s+d.amount,0);
const paperPL     = totalMkt - netCost;
const paperPLPct  = netCost > 0 ? paperPL / netCost : 0;
const totalReturn    = paperPL + totalDiv;
const totalReturnPct = netCost > 0 ? totalReturn / netCost : 0;
const avgCostPct     = netCost > 0 ? (totalMkt - netCost) / netCost * 100 : 0;

const now   = new Date();
const ago12 = new Date(now); ago12.setMonth(ago12.getMonth()-12);
const ago6  = new Date(now); ago6.setMonth(ago6.getMonth()-6);
const div12m   = divs.filter(d=>d.date&&new Date(d.date)>=ago12).reduce((s,d)=>s+d.amount,0);
const div6m    = divs.filter(d=>d.date&&new Date(d.date)>=ago6 ).reduce((s,d)=>s+d.amount,0);
const yield12m = netCost>0 ? div12m/netCost*100 : 0;
const yield6m  = netCost>0 ? div6m /netCost*100 : 0;
const sortedDivs = [...divs].sort((a,b)=>new Date(b.date)-new Date(a.date));
const lastDiv    = sortedDivs[0];

const sectors   = [...new Set(portfolio.map(p => H.tickerSector(p.ticker)))].length;
const toAccum   = portfolio.filter(p=>p.decision?.includes('ØªØ¬Ù…ÙŠØ¹')).length;
const toReduce  = portfolio.filter(p=>p.decision?.includes('ØªØ®ÙÙŠÙ')).length;
const yearsLeft = settings.retirementYear - new Date().getFullYear();
const progressPct = Math.min(totalMkt/settings.targetCapital*100, 100);

document.getElementById('headerDate').textContent = new Date().toLocaleDateString('ar-SA',{
  weekday:'long',year:'numeric',month:'long',day:'numeric'
});
document.getElementById('lastUpdate').textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${APP.netWorth?.lastUpdated||'â€”'}`;

// KPI Row 1
document.getElementById('kpiRow1').innerHTML = `
  <div class="kpi-card"><div class="kpi-icon">ğŸ’¹</div><div class="kpi-label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</div><div class="kpi-value accent">${H.fmt(totalMkt)}</div><div class="kpi-sub">SAR</div></div>
  <div class="kpi-card"><div class="kpi-icon">ğŸ§¾</div><div class="kpi-label">ØµØ§ÙÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</div><div class="kpi-value">${H.fmt(netCost)}</div><div class="kpi-sub">Ø´Ø±Ø§Ø¡ âˆ’ Ø¨ÙŠØ¹</div></div>
  <div class="kpi-card"><div class="kpi-icon">ğŸ“ˆ</div><div class="kpi-label">Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ù‚ÙŠØ©</div><div class="kpi-value ${paperPL>=0?'pos':'neg'}">${paperPL>=0?'+':''}${H.fmt(paperPL)}</div><div class="kpi-sub">${H.fmt(avgCostPct,2)}% Ù…Ù† Ø§Ù„ØªÙƒÙ„ÙØ©</div></div>
  <div class="kpi-card"><div class="kpi-icon">ğŸ†</div><div class="kpi-label">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„</div><div class="kpi-value ${totalReturn>=0?'pos':'neg'}">${totalReturn>=0?'+':''}${H.fmt(totalReturn)}</div><div class="kpi-sub">Ø±/Ø® + ØªÙˆØ²ÙŠØ¹Ø§Øª â€¢ ${H.pct(totalReturnPct)}</div></div>`;

// KPI Row 2
document.getElementById('kpiRow2').innerHTML = `
  <div class="kpi-card"><div class="kpi-icon">ğŸ’°</div><div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</div><div class="kpi-value pos">${H.fmt(totalDiv)}</div><div class="kpi-sub">SAR Ù…ÙØ³ØªÙ„Ù…Ø©</div></div>
  <div class="kpi-card"><div class="kpi-icon">ğŸ—“ï¸</div><div class="kpi-label">Ø¹Ø§Ø¦Ø¯ Ø¢Ø®Ø± 12 Ø´Ù‡Ø±</div><div class="kpi-value ${yield12m>=settings.targetYield*100?'pos':'warn'}">${H.fmt(yield12m,2)}%</div><div class="kpi-sub">${H.fmt(div12m)} SAR</div></div>
  <div class="kpi-card"><div class="kpi-icon">ğŸ“…</div><div class="kpi-label">Ø¹Ø§Ø¦Ø¯ Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±</div><div class="kpi-value">${H.fmt(yield6m,2)}%</div><div class="kpi-sub">${H.fmt(div6m)} SAR</div></div>
  <div class="kpi-card"><div class="kpi-icon">ğŸ¯</div><div class="kpi-label">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</div><div class="kpi-value warn">${H.fmt(settings.targetYield*100,1)}%</div><div class="kpi-sub">ÙØ¬ÙˆØ© ${H.fmt(Math.max(0,settings.targetYield*100-yield12m),2)}%</div></div>`;

// KPI Row 3
document.getElementById('kpiRow3').innerHTML = `
  <div class="kpi-card"><div class="kpi-icon">ğŸ¦</div><div class="kpi-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙƒØ²</div><div class="kpi-value">${portfolio.length}</div><div class="kpi-sub">Ù…Ù† ${settings.minPositions}â€“${settings.maxPositions} Ù…Ø³ØªÙ‡Ø¯Ù</div></div>
  <div class="kpi-card"><div class="kpi-icon">ğŸ—‚ï¸</div><div class="kpi-label">Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù…Ø«Ù‘Ù„Ø©</div><div class="kpi-value">${sectors}</div><div class="kpi-sub">ØªÙ†ÙˆÙŠØ¹ Ù‚Ø·Ø§Ø¹ÙŠ</div></div>
  <div class="kpi-card"><div class="kpi-icon">âš¡</div><div class="kpi-label">Ø¥Ø´Ø§Ø±Ø§Øª ÙØ¹Ù‘Ø§Ù„Ø©</div><div class="kpi-value accent">${toAccum+toReduce}</div><div class="kpi-sub">${toAccum} ØªØ¬Ù…ÙŠØ¹ â€¢ ${toReduce} ØªØ®ÙÙŠÙ</div></div>
  <div class="kpi-card"><div class="kpi-icon">ğŸ“¬</div><div class="kpi-label">Ø¢Ø®Ø± ØªÙˆØ²ÙŠØ¹</div><div class="kpi-value pos" style="font-size:18px">${lastDiv?H.fmt(lastDiv.amount):'â€”'}</div><div class="kpi-sub">${lastDiv?((lastDiv.ticker?H.tickerName(lastDiv.ticker):lastDiv.stock)+' â€¢ '+lastDiv.date):'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>`;

// Signals â€” ÙŠØ³ØªØ®Ø¯Ù… H.tickerName
const buyList  = portfolio.filter(p=>p.decision?.includes('ØªØ¬Ù…ÙŠØ¹')&&p.current_price<=p.buy_zone_max);
const sellList = portfolio.filter(p=>p.decision?.includes('ØªØ®ÙÙŠÙ')&&p.current_price>=p.sell_zone_low);

document.getElementById('buySignals').innerHTML = buyList.length
  ? buyList.map(p=>`
    <div class="signal-item buy">
      <span>ğŸŸ¢</span>
      <div><strong>${H.tickerName(p.ticker)}</strong><span style="color:var(--text3);font-size:12px"> â€¢ ${p.ticker}</span><br>
      <span style="font-size:12px;color:var(--text2)">Ø§Ù„Ø³Ø¹Ø± <strong>${H.fmt(p.current_price)}</strong> â† Ù…Ù†Ø·Ù‚Ø© Ø´Ø±Ø§Ø¡ Ø£Ù‚Ù„ Ù…Ù† ${H.fmt(p.buy_zone_max)}</span></div>
    </div>`).join('')
  : '<p style="color:var(--text3);font-size:13px;padding:8px 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ØªØ¬Ù…ÙŠØ¹</p>';

document.getElementById('sellSignals').innerHTML = sellList.length
  ? sellList.map(p=>`
    <div class="signal-item sell">
      <span>ğŸŸ¡</span>
      <div><strong>${H.tickerName(p.ticker)}</strong><span style="color:var(--text3);font-size:12px"> â€¢ ${p.ticker}</span><br>
      <span style="font-size:12px;color:var(--text2)">Ø§Ù„Ø³Ø¹Ø± <strong>${H.fmt(p.current_price)}</strong> â† Ù…Ù†Ø·Ù‚Ø© ØªØ®ÙÙŠÙ Ù…Ù† ${H.fmt(p.sell_zone_low)}</span></div>
    </div>`).join('')
  : '<p style="color:var(--text3);font-size:13px;padding:8px 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ØªØ®ÙÙŠÙ</p>';

// Sector Doughnut â€” H.tickerSector
const sectorMap = {};
portfolio.forEach(p=>{
  const s = H.tickerSector(p.ticker);
  sectorMap[s] = (sectorMap[s]||0) + p.qty * p.current_price;
});
const COLORS = ['#4f8ef7','#22c55e','#f59e0b','#ef4444','#a78bfa','#06b6d4','#f97316','#84cc16','#ec4899','#14b8a6','#8b5cf6','#fb923c'];
new Chart(document.getElementById('sectorChart'),{
  type:'doughnut',
  data:{ labels:Object.keys(sectorMap), datasets:[{data:Object.values(sectorMap),backgroundColor:COLORS,borderColor:'#131722',borderWidth:2}] },
  options:{ responsive:true,maintainAspectRatio:false,
    plugins:{ legend:{position:'bottom',labels:{color:'#94a3b8',font:{size:10},padding:8,boxWidth:10}},
      tooltip:{callbacks:{label:ctx=>`${H.fmt(ctx.raw)} SAR (${(ctx.raw/totalMkt*100).toFixed(1)}%)`}}
    }
  }
});

// Allocation Bar
const allocData = portfolio
  .map(p=>({name:p.ticker, stockName:H.tickerName(p.ticker), goal:(p.goal_alloc||0)*100, actual:totalMkt>0?p.qty*p.current_price/totalMkt*100:0}))
  .sort((a,b)=>b.goal-a.goal).slice(0,12);
const overAlloc = allocData.filter(d=>d.goal>0&&(d.actual-d.goal)>5);
new Chart(document.getElementById('allocChart'),{
  type:'bar',
  data:{
    labels:allocData.map(d=>(overAlloc.find(x=>x.name===d.name)?'âš  ':'')+d.name),
    datasets:[
      {label:'Ø§Ù„Ù‡Ø¯Ù %', data:allocData.map(d=>d.goal),backgroundColor:'rgba(79,142,247,0.55)',borderRadius:3,maxBarThickness:20},
      {label:'Ø§Ù„ÙØ¹Ù„ÙŠ %',data:allocData.map(d=>d.actual),backgroundColor:allocData.map(d=>d.goal>0&&(d.actual-d.goal)>5?'rgba(239,68,68,0.7)':'rgba(34,197,94,0.6)'),borderRadius:3,maxBarThickness:20}
    ]
  },
  options:{
    responsive:true,maintainAspectRatio:false,barPercentage:0.65,categoryPercentage:0.75,
    plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}},tooltip:{callbacks:{afterBody:items=>{
      const d=allocData[items[0].dataIndex];
      return d.goal>0&&(d.actual-d.goal)>5?`âš  ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù‡Ø¯Ù Ø¨Ù€ ${(d.actual-d.goal).toFixed(1)}%`:'';
    }}}},
    scales:{x:{ticks:{color:'#64748b',font:{size:9},maxRotation:45},grid:{color:'#1e2340'}},y:{ticks:{color:'#64748b',callback:v=>v+'%'},grid:{color:'#1e2340'}}}
  }
});
if(overAlloc.length){
  const w=document.createElement('div');
  w.style.cssText='margin-top:10px;padding:10px 14px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.3);border-radius:8px;font-size:12px;color:var(--red);line-height:1.8';
  w.innerHTML=overAlloc.map(d=>`âš ï¸ <strong>${d.stockName}</strong> (${d.name}): ÙØ¹Ù„ÙŠ ${d.actual.toFixed(1)}% Ù…Ù‚Ø§Ø¨Ù„ Ù‡Ø¯Ù ${d.goal.toFixed(1)}% (+${(d.actual-d.goal).toFixed(1)}%)`).join('<br>');
  document.getElementById('allocWarn').appendChild(w);
}

// Goal Progress
document.getElementById('goalProgress').innerHTML = `
  <div style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;margin-bottom:6px">
      <span style="font-size:13px;color:var(--text2)">Ø§Ù„ØªÙ‚Ø¯Ù… Ù†Ø­Ùˆ ${H.fmt(settings.targetCapital)} SAR</span>
      <span style="font-size:14px;font-weight:800;color:var(--accent)">${progressPct.toFixed(1)}%</span>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar" style="width:${progressPct}%"></div></div>
    <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px;color:var(--text3)">
      <span>${H.fmt(totalMkt)} SAR Ø­Ø§Ù„ÙŠØ§Ù‹</span>
      <span>${H.fmt(settings.targetCapital-totalMkt)} SAR Ù…ØªØ¨Ù‚ÙŠ</span>
    </div>
  </div>
  <div class="kpi-grid cols-2" style="margin:0">
    <div class="kpi-card" style="padding:14px">
      <div class="kpi-label">Ø³Ù†ÙˆØ§Øª Ù„Ù„ØªÙ‚Ø§Ø¹Ø¯</div>
      <div class="kpi-value warn">${yearsLeft}</div>
      <div class="kpi-sub">${settings.retirementYear}</div>
    </div>
    <div class="kpi-card" style="padding:14px">
      <div class="kpi-label">Ù‡Ø¯Ù Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
      <div class="kpi-value pos">${H.fmt(settings.targetCapital*settings.targetYield)}</div>
      <div class="kpi-sub">SAR</div>
    </div>
  </div>`;

// Top Stocks â€” H.tickerName + H.tickerSector
const sortedPL=[...portfolio].map(p=>({...p,pl:p.avg_cost>0?(p.current_price-p.avg_cost)/p.avg_cost:0})).sort((a,b)=>b.pl-a.pl);
const topN=sortedPL.slice(0,4); const worstN=sortedPL.slice(-3);
function stockRow(p){
  const name   = H.tickerName(p.ticker);
  const sector = H.tickerSector(p.ticker);
  return `<div class="stock-row-mini">
    <div><div class="sname">${name}</div><div class="sticker">${p.ticker} â€¢ ${sector}</div></div>
    <div style="text-align:left"><div class="${p.pl>=0?'pos':'neg'}" style="font-weight:700">${p.pl>=0?'+':''}${(p.pl*100).toFixed(2)}%</div>
    <div style="font-size:11px;color:var(--text3)">${H.fmt(p.current_price)} SAR</div></div>
  </div>`;}
document.getElementById('topStocks').innerHTML=`
  <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Ø£ÙØ¶Ù„ 4</div>
  ${topN.map(p=>stockRow(p)).join('')}
  <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin:12px 0 6px">Ø£Ø³ÙˆØ£ 3</div>
  ${worstN.map(p=>stockRow(p)).join('')}`;

// Last Tx
const lastTxList=[...transactions].sort((a,b)=>new Date(b.date||0)-new Date(a.date||0)).slice(0,7);
document.getElementById('lastTx').innerHTML=lastTxList.length
  ?lastTxList.map(t=>`
    <div class="tx-row">
      <div style="display:flex;align-items:center;gap:10px">
        <span class="badge ${t.status==='Buy'?'badge-buy':'badge-sell'}" style="font-size:10px">${t.status==='Buy'?'â¬† Ø´Ø±Ø§Ø¡':'â¬‡ Ø¨ÙŠØ¹'}</span>
        <div><div style="font-weight:600;font-size:13px">${t.ticker}</div>
        <div style="font-size:11px;color:var(--text3)">${H.tickerName(t.ticker)}</div></div>
      </div>
      <div style="text-align:left">
        <div style="font-weight:700;font-size:13px">${H.fmt(t.total_cost||0)} SAR</div>
        <div style="font-size:11px;color:var(--text3)">${t.date||'â€”'} â€¢ ${H.fmt(t.qty,0)} Ø³Ù‡Ù…</div>
      </div>
    </div>`).join('')
  :'<p style="color:var(--text3);font-size:13px;padding:8px 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</p>';

// Dividends Bar â€” d.stock Ù…Ø§Ø²Ø§Ù„ Ù†ØµÙŠ ÙÙŠ dividends
const divMap={};
divs.forEach(d=>{ divMap[d.stock]=(divMap[d.stock]||0)+d.amount; });
const divSorted=Object.entries(divMap).sort((a,b)=>b[1]-a[1]);
new Chart(document.getElementById('divChart'),{
  type:'bar',
  data:{labels:divSorted.map(d=>d[0]),datasets:[{label:'SAR',data:divSorted.map(d=>d[1]),backgroundColor:'rgba(34,197,94,0.6)',borderRadius:4,maxBarThickness:32}]},
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
    scales:{x:{ticks:{color:'#64748b',font:{size:10}},grid:{color:'#1e2340'}},y:{ticks:{color:'#64748b'},grid:{color:'#1e2340'}}}}
});

// Geo
const geoMap={};
portfolio.forEach(p=>{
  const label = TICKER_MAP[p.ticker]?.coverage || 'Ù…Ø­Ù„ÙŠ';
  geoMap[label]=(geoMap[label]||0)+p.qty*p.current_price;
});
const geoColors={'Ù…Ø­Ù„ÙŠ':'#4f8ef7','Ø¥Ù‚Ù„ÙŠÙ…ÙŠ':'#22c55e','Ø¹Ø§Ù„Ù…ÙŠ':'#f59e0b'};
const geoTotal=Object.values(geoMap).reduce((s,v)=>s+v,0);
document.getElementById('geoBox').innerHTML=
  Object.entries(geoMap).map(([label,val])=>{
    const pct=geoTotal>0?(val/geoTotal*100):0;
    const color=geoColors[label]||'#a78bfa';
    return `<div class="geo-bar-row">
      <span style="min-width:180px">${label==='Ù…Ø­Ù„ÙŠ'?'ğŸ‡¸ğŸ‡¦':label==='Ø¥Ù‚Ù„ÙŠÙ…ÙŠ'?'ğŸŒ':'ğŸŒ'} ${label}</span>
      <div class="geo-bar-bg"><div class="geo-bar-fill" style="width:${pct}%;background:${color}"></div></div>
      <span style="min-width:50px;text-align:left;font-weight:700;color:${color}">${pct.toFixed(1)}%</span>
      <span style="min-width:80px;text-align:left;font-size:11px;color:var(--text3)">${H.fmt(val)} SAR</span>
    </div>`;}).join('')+
  `<p style="font-size:11px;color:var(--text3);margin-top:10px">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: <strong>${H.fmt(geoTotal)} SAR</strong></p>`;

// Rules
const rules=[
  {icon:'ğŸ›¡ï¸',text:'Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø£Ù‡Ù… Ù…Ù† Ø§Ù„Ø±Ø¨Ø­. Ù†Ù… Ù‚Ø±ÙŠØ± Ø§Ù„Ø¹ÙŠÙ†.'},
  {icon:'â³',text:'Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø£Ù‡Ù… Ù…Ù† ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø³ÙˆÙ‚.'},
  {icon:'ğŸ§Š',text:'Ø³ÙˆÙ‚ Ø§Ù„Ø£Ø³Ù‡Ù… ÙŠÙƒØ§ÙØ¦ Ø§Ù„ØµØ¨ÙˆØ± Ø¬Ø¯Ø§Ù‹.'},
  {icon:'ğŸ’',text:'Ù„Ø§ ØªØ¨ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø£Ø¨Ø¯Ø§Ù‹.'},
  {icon:'ğŸ”´',text:'Ø±ÙŠØ§Ù„ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ù…Ù…Ù†ÙˆØ¹ ÙŠØ®Ø±Ø¬.'},
  {icon:'ğŸ“',text:'Ø£Ù†Øª Defensive Investor â€” Ù„Ø§ ØªØªØµØ±Ù ÙƒØ§Ù„Ù…Ø¶Ø§Ø±Ø¨.'},
];
document.getElementById('rulesBox').innerHTML=rules.map(r=>`
  <div class="rule-item"><span class="rule-icon">${r.icon}</span><span>${r.text}</span></div>`).join('');
</script>
</body>
</html>
