<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ø³ÙŠÙˆÙ„Ø© â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-sync.js"></script>
<style>
.chart-wrap { position:relative; width:100%; height:280px; }
.chart-wrap canvas { width:100% !important; height:100% !important; }
.editable {
  cursor:pointer; border-bottom:1px dashed var(--border2);
  display:inline-block; min-width:60px; transition:border-color .2s;
}
.editable:hover { border-color:var(--accent); color:var(--accent); }
.edit-input {
  width:120px; padding:4px 8px; background:var(--bg2);
  border:1px solid var(--accent); border-radius:4px;
  color:var(--text); font-size:12px; text-align:center;
  outline:none; font-family:inherit;
}
</style>
</head>
<body>
<script>initPage('cash');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ’µ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h1>
      <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„Ù†Ù‚Ø¯ â€” Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="kpi-grid cols-3" id="cashKPIs"></div>

  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
        <select id="c-type">
          <option value="Ø­Ø³Ø§Ø¨ Ø¬Ø§Ø±ÙŠ">Ø­Ø³Ø§Ø¨ Ø¬Ø§Ø±ÙŠ</option>
          <option value="Ø­Ø³Ø§Ø¨ ØªÙˆÙÙŠØ±">Ø­Ø³Ø§Ø¨ ØªÙˆÙÙŠØ±</option>
          <option value="Ù†Ù‚Ø¯">Ù†Ù‚Ø¯</option>
          <option value="Ù…Ø­ÙØ¸Ø© Ø±Ù‚Ù…ÙŠØ©">Ù…Ø­ÙØ¸Ø© Ø±Ù‚Ù…ÙŠØ©</option>
          <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
        <input id="c-name" placeholder="Ø§Ù„Ø£Ù‡Ù„ÙŠ - Ø¬Ø§Ø±ÙŠ">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø±ØµÙŠØ¯ (Ø±.Ø³)</label>
        <input id="c-balance" type="number" step="0.01" placeholder="15000">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø¨Ù†Ùƒ</label>
        <input id="c-bank" placeholder="Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
        <select id="c-currency">
          <option value="SAR">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (SAR)</option>
          <option value="USD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ (USD)</option>
          <option value="EUR">ÙŠÙˆØ±Ùˆ (EUR)</option>
          <option value="GBP">Ø¬Ù†ÙŠÙ‡ Ø¥Ø³ØªØ±Ù„ÙŠÙ†ÙŠ (GBP)</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="c-notes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
    </div>
    <button class="btn btn-primary" onclick="addAccount()">â• Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ“Š Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</div>
      <div class="chart-wrap"><canvas id="byTypeChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ¦ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ùƒ</div>
      <div class="chart-wrap"><canvas id="byBankChart"></canvas></div>
    </div>
  </div>

  <div class="toolbar">
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="applySearch(this.value)">
    <span id="trCount" style="color:var(--text3);font-size:13px"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th>
          <th>Ø§Ù„Ø¨Ù†Ùƒ</th><th>Ø§Ù„Ø¹Ù…Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="cashBody"></tbody>
      <tfoot id="cashFoot"></tfoot>
    </table>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cash = [];
let filtered = [];
let searchQ = '';
let chartType = null, chartBank = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  cash = APP.cash;
  filtered = [...cash];
  renderKPIs();
  renderTable();
  renderCharts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKPIs() {
  const total = cash.reduce((s, c) => s + (parseFloat(c.balance) || 0), 0);
  const count = cash.length;
  const avg = count > 0 ? total / count : 0;

  const kpis = [
    { label:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',        value:H.fmt(total, 0) + ' Ø±.Ø³', icon:'ğŸ’°' },
    { label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª',    value:count.toString(),          icon:'ğŸ¦' },
    { label:'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±ØµÙŠØ¯',    value:H.fmt(avg, 0) + ' Ø±.Ø³',   icon:'ğŸ“Š' }
  ];

  document.getElementById('cashKPIs').innerHTML = kpis.map(k => `
    <div class="kpi-card">
      <div class="kpi-icon">${k.icon}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Add Account
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addAccount() {
  const type = document.getElementById('c-type').value;
  const name = document.getElementById('c-name').value.trim();
  const balance = parseFloat(document.getElementById('c-balance').value) || 0;
  const bank = document.getElementById('c-bank').value.trim();
  const currency = document.getElementById('c-currency').value;
  const notes = document.getElementById('c-notes').value.trim();

  if (!name) {
    toast('âš ï¸ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø·Ù„ÙˆØ¨', 'warn');
    return;
  }

  const newAccount = {
    id: Date.now(),
    type,
    name,
    balance,
    bank,
    currency,
    notes
  };

  cash.push(newAccount);

  // Clear
  document.getElementById('c-name').value = '';
  document.getElementById('c-balance').value = '';
  document.getElementById('c-bank').value = '';
  document.getElementById('c-notes').value = '';

  saveAll();
  init();
  toast('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const tbody = document.getElementById('cashBody');
  const tfoot = document.getElementById('cashFoot');

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</td></tr>';
    tfoot.innerHTML = '';
    updateCount();
    return;
  }

  let total = 0;

  tbody.innerHTML = filtered.map(c => {
    const balance = parseFloat(c.balance) || 0;
    total += balance;

    return `
      <tr>
        <td>${c.type}</td>
        <td><strong>${c.name}</strong></td>
        <td>
          <span class="editable" onclick="editBalance(${c.id}, ${c.balance})">${H.fmt(c.balance, 2)}</span>
        </td>
        <td>${c.bank || '-'}</td>
        <td>${c.currency}</td>
        <td>${c.notes || '-'}</td>
        <td><button class="btn btn-danger btn-xs" onclick="deleteAccount(${c.id})">ğŸ—‘ï¸</button></td>
      </tr>
    `;
  }).join('');

  tfoot.innerHTML = `
    <tr style="font-weight:700;background:var(--bg2)">
      <td colspan="2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
      <td>${H.fmt(total, 2)}</td>
      <td colspan="4"></td>
    </tr>
  `;

  updateCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Edit Balance
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editBalance(id, currentBalance) {
  const span = event.target;
  const input = document.createElement('input');
  input.className = 'edit-input';
  input.type = 'number';
  input.step = '0.01';
  input.value = currentBalance;

  span.replaceWith(input);
  input.focus();
  input.select();

  const save = () => {
    const newBalance = parseFloat(input.value) || currentBalance;
    const idx = cash.findIndex(c => c.id === id);
    if (idx !== -1) {
      cash[idx].balance = newBalance;
      Store.save('cash_v1', cash);
      dataSync.emit('cash');
    }
    init();
  };

  input.onblur = save;
  input.onkeydown = (e) => {
    if (e.key === 'Enter') save();
    if (e.key === 'Escape') init();
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Delete Account
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteAccount(id) {
  if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) return;

  cash = cash.filter(c => c.id !== id);

  saveAll();
  init();
  toast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Search
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applySearch(q) {
  searchQ = q.trim().toLowerCase();
  filtered = searchQ
    ? cash.filter(c =>
        (c.name || '').toLowerCase().includes(searchQ) ||
        (c.type || '').toLowerCase().includes(searchQ) ||
        (c.bank || '').toLowerCase().includes(searchQ)
      )
    : [...cash];
  renderTable();
}

function updateCount() {
  document.getElementById('trCount').textContent =
    `${filtered.length} Ù…Ù† ${cash.length} Ø­Ø³Ø§Ø¨`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Charts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts() {
  if (!cash.length) {
    ['#byTypeChart', '#byBankChart'].forEach(id => {
      document.querySelector(id).parentElement.innerHTML =
        '<p style="text-align:center;color:var(--text3);padding:60px 20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    });
    return;
  }

  // By Type
  const byType = {};
  cash.forEach(c => {
    const type = c.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    byType[type] = (byType[type] || 0) + (parseFloat(c.balance) || 0);
  });

  const typeData = Object.entries(byType).sort((a,b) => b[1] - a[1]);

  const ctx1 = document.getElementById('byTypeChart').getContext('2d');
  if (chartType) chartType.destroy();
  chartType = new Chart(ctx1, {
    type: 'doughnut',
    data: {
      labels: typeData.map(t => t[0]),
      datasets: [{
        data: typeData.map(t => t[1]),
        backgroundColor: CHART_COLORS,
        borderWidth: 3,
        borderColor: CHART_BORDER_COLOR
      }]
    },
    options: {
      ...getChartOptions(),
      plugins: {
        ...getChartOptions().plugins,
        tooltip: {
          ...getChartOptions().plugins.tooltip,
          callbacks: { label: (ctx) => `${ctx.label}: ${H.fmt(ctx.parsed, 0)} Ø±.Ø³` }
        }
      }
    }
  });

  // By Bank
  const byBank = {};
  cash.forEach(c => {
    const bank = c.bank || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    byBank[bank] = (byBank[bank] || 0) + (parseFloat(c.balance) || 0);
  });

  const bankData = Object.entries(byBank).sort((a,b) => b[1] - a[1]);

  const ctx2 = document.getElementById('byBankChart').getContext('2d');
  if (chartBank) chartBank.destroy();
  chartBank = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: bankData.map(b => b[0]),
      datasets: [{
        label: 'Ø§Ù„Ø±ØµÙŠØ¯ (Ø±.Ø³)',
        data: bankData.map(b => b[1]),
        backgroundColor: CHART_COLORS[0],
        borderRadius: 8
      }]
    },
    options: {
      ...getChartOptions('bar'),
      plugins: {
        ...getChartOptions('bar').plugins,
        legend: { display: false },
        tooltip: {
          ...getChartOptions('bar').plugins.tooltip,
          callbacks: { label: (ctx) => `${H.fmt(ctx.parsed.y, 0)} Ø±.Ø³` }
        }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAll() {
  Store.save('cash_v1', cash);
  toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  dataSync.emit('cash');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sync
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
dataSync.onDataChanged('cash', init);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Run
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>

</body>
</html>
