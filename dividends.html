<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-sync.js"></script>
<style>
.editable {
  cursor:pointer; border-bottom:1px dashed var(--border2);
  display:inline-block; min-width:30px; transition:border-color .2s;
}
.editable:hover { border-color:var(--accent); color:var(--accent); }
.edit-input {
  width:100px; padding:4px 6px; background:var(--bg2); 
  border:1px solid var(--accent); border-radius:4px; 
  color:var(--text); font-size:12px; text-align:center; 
  outline:none; font-family:inherit;
}
.yield-tabs { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
.yield-tab {
  padding:7px 18px; border-radius:20px; border:1px solid var(--border); 
  background:transparent; color:var(--text3); font-size:12px; 
  font-weight:600; cursor:pointer; transition:all .18s; font-family:inherit;
}
.yield-tab:hover { border-color:var(--accent); color:var(--accent); }
.yield-tab.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.yield-box { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; padding:18px 0 4px; }
.yield-item { text-align:center; }
.yield-item .y-val { font-size:22px; font-weight:800; color:var(--accent); }
.yield-item .y-label { font-size:12px; color:var(--text3); margin-top:4px; }
.chart-wrap { position:relative; width:100%; height:260px; }
.chart-wrap canvas { width:100% !important; height:100% !important; }
.rank-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-bottom:4px; }
.rank-card {
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius); padding:16px; text-align:center;
}
.rank-card .rank-no { font-size:22px; font-weight:800; color:var(--accent); }
.rank-card .rank-name { font-size:12px; font-weight:700; margin:4px 0; }
.rank-card .rank-val { font-size:12px; color:var(--text3); }
@media(max-width:900px){ 
  .rank-grid{ grid-template-columns:repeat(2,1fr); } 
  .yield-box{ grid-template-columns:repeat(2,1fr); } 
}
</style>
</head>
<body>
<script>initPage('dividends');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ’° Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</h1>
      <p>Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„ â€” Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
      <button class="btn btn-ghost btn-sm" onclick="exportJSON()">ğŸ“¦ JSON</button>
      <button class="btn btn-warn btn-sm" onclick="showImport()">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="chart-card" style="margin-bottom:24px">
    <div style="font-size:14px;font-weight:700;color:var(--text2);margin-bottom:14px">ğŸ“Š Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
    <div class="yield-tabs" id="yieldTabs">
      <button class="yield-tab active" onclick="setYieldTab('12m',this)">Ø¢Ø®Ø± 12 Ø´Ù‡Ø±</button>
      <button class="yield-tab" onclick="setYieldTab('yoc',this)">Yield on Cost</button>
      <button class="yield-tab" onclick="setYieldTab('all',this)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</button>
    </div>
    <div id="yieldContent"></div>
  </div>

  <div class="kpi-grid cols-4" id="divKPIs"></div>

  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© ØªÙˆØ²ÙŠØ¹ Ø¬Ø¯ÙŠØ¯</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="d-date" type="date">
      </div>
      <div class="form-group">
        <label>ÙƒÙˆØ¯ Ø§Ù„ØªÙŠÙƒØ±</label>
        <input id="d-ticker" placeholder="4164" autocomplete="off" 
          oninput="previewDivTicker()" style="text-transform:uppercase;letter-spacing:1px">
        <div id="d-ticker-preview" style="font-size:11px;margin-top:4px;min-height:16px;font-weight:600"></div>
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ù…Ø¨Ù„Øº (SAR)</label>
        <input id="d-amount" type="number" step="0.01" placeholder="500">
      </div>
      <div class="form-group">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <input id="d-note" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
      </div>
    </div>
    <button class="btn btn-primary" onclick="addDividend()">â• Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ’° Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø³Ù‡Ù…</div>
      <div class="chart-wrap"><canvas id="divByStock"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“… Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</div>
      <div class="chart-wrap"><canvas id="divByMonth"></canvas></div>
    </div>
  </div>

  <div class="chart-card" style="margin-bottom:24px">
    <div style="font-size:14px;font-weight:700;color:var(--text2);margin-bottom:14px">ğŸ† Ø£Ø¹Ù„Ù‰ 5 Ø£Ø³Ù‡Ù… Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙˆØ²ÙŠØ¹</div>
    <div class="rank-grid" id="top5total"></div>
  </div>

  <div class="toolbar">
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="applySearch(this.value)">
    <span id="trCount" style="color:var(--text3);font-size:13px"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªÙŠÙƒØ±</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº (SAR)</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="divBody"></tbody>
    </table>
  </div>
</div>

<!-- Import Modal -->
<div id="importModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;align-items:center;justify-content:center">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;width:90%;max-width:500px">
    <h3 style="margin-bottom:16px">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</h3>
    <div class="info-box blue" style="margin-bottom:14px">ÙŠØ¯Ø¹Ù… <strong>JSON</strong> Ùˆ <strong>CSV</strong>.</div>
    <div style="border:2px dashed var(--border2);border-radius:var(--radius);padding:20px;text-align:center;color:var(--text3);cursor:pointer"
         onclick="document.getElementById('divFileInput').click()">ğŸ“ Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</div>
    <input id="divFileInput" type="file" accept=".json,.csv" style="display:none" onchange="handleImportFile(this)">
    <textarea id="divPaste" rows="5"
      style="width:100%;margin-top:14px;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:monospace;outline:none;resize:vertical"
      placeholder='[{"no":1,"date":"2025-08-01","ticker":"4164","amount":500}]'></textarea>
    <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeImport()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="doImport(false)">Ø¯Ù…Ø¬</button>
      <button class="btn btn-danger" onclick="doImport(true)">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let divData = [];
let filtered = [];
let searchQ = '';
let activeYieldTab = '12m';
let chartStock = null, chartMonth = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  divData = APP.dividends;
  filtered = [...divData];
  document.getElementById('d-date').value = H.today();
  renderYield();
  renderKPIs();
  renderTable();
  renderCharts();
  renderTop5();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Yield Calculation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setYieldTab(tab, btn) {
  activeYieldTab = tab;
  document.querySelectorAll('.yield-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderYield();
}

function renderYield() {
  const portfolio = APP.portfolio;
  const divs = divData;

  const totalValue = portfolio.reduce((s,p) => s + p.qty * p.current_price, 0);
  const totalCost  = portfolio.reduce((s,p) => s + p.qty * p.avg_cost, 0);

  let html = '';

  if (activeYieldTab === '12m') {
    const today = new Date();
    const oneYearAgo = new Date(today);
    oneYearAgo.setFullYear(today.getFullYear() - 1);

    const last12 = divs.filter(d => {
      const dDate = new Date(d.date);
      return dDate >= oneYearAgo && dDate <= today;
    });

    const total12 = last12.reduce((s,d) => s + d.amount, 0);
    const yield12 = totalValue > 0 ? (total12 / totalValue * 100) : 0;

    html = `
      <div class="yield-box">
        <div class="yield-item">
          <div class="y-val">${H.fmt(total12, 2)}</div>
          <div class="y-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¢Ø®Ø± 12 Ø´Ù‡Ø± (Ø±.Ø³)</div>
        </div>
        <div class="yield-item">
          <div class="y-val">${H.fmt(totalValue, 0)}</div>
          <div class="y-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø±.Ø³)</div>
        </div>
        <div class="yield-item">
          <div class="y-val">${yield12.toFixed(2)}%</div>
          <div class="y-label">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ (Dividend Yield)</div>
        </div>
      </div>
    `;
  } else if (activeYieldTab === 'yoc') {
    const totalDiv = divs.reduce((s,d) => s + d.amount, 0);
    const yoc = totalCost > 0 ? (totalDiv / totalCost * 100) : 0;

    html = `
      <div class="yield-box">
        <div class="yield-item">
          <div class="y-val">${H.fmt(totalDiv, 2)}</div>
          <div class="y-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª (Ø±.Ø³)</div>
        </div>
        <div class="yield-item">
          <div class="y-val">${H.fmt(totalCost, 0)}</div>
          <div class="y-label">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ© (Ø±.Ø³)</div>
        </div>
        <div class="yield-item">
          <div class="y-val">${yoc.toFixed(2)}%</div>
          <div class="y-label">Yield on Cost</div>
        </div>
      </div>
    `;
  } else {
    // all
    const totalDiv = divs.reduce((s,d) => s + d.amount, 0);
    const avgPerMonth = divs.length > 0 ? totalDiv / (divs.length / 4) : 0; // ØªÙ‚Ø±ÙŠØ¨ÙŠ

    html = `
      <div class="yield-box">
        <div class="yield-item">
          <div class="y-val">${H.fmt(totalDiv, 0)}</div>
          <div class="y-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª (Ø±.Ø³)</div>
        </div>
        <div class="yield-item">
          <div class="y-val">${divs.length}</div>
          <div class="y-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</div>
        </div>
        <div class="yield-item">
          <div class="y-val">${H.fmt(avgPerMonth, 0)}</div>
          <div class="y-label">Ù…ØªÙˆØ³Ø· Ø´Ù‡Ø±ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ (Ø±.Ø³)</div>
        </div>
      </div>
    `;
  }

  document.getElementById('yieldContent').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKPIs() {
  const total = divData.reduce((s,d) => s + d.amount, 0);
  const count = divData.length;
  const avg = count > 0 ? total / count : 0;
  const max = count > 0 ? Math.max(...divData.map(d => d.amount)) : 0;

  const kpis = [
    { label:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',         value:H.fmt(total, 0) + ' Ø±.Ø³', icon:'ğŸ’°' },
    { label:'Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª',     value:count.toString(),          icon:'ğŸ”¢' },
    { label:'Ø§Ù„Ù…ØªÙˆØ³Ø·',          value:H.fmt(avg, 2) + ' Ø±.Ø³',   icon:'ğŸ“Š' },
    { label:'Ø£Ø¹Ù„Ù‰ ØªÙˆØ²ÙŠØ¹',       value:H.fmt(max, 2) + ' Ø±.Ø³',   icon:'ğŸ†' }
  ];

  document.getElementById('divKPIs').innerHTML = kpis.map(k => `
    <div class="kpi-card">
      <div class="kpi-icon">${k.icon}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Preview Ticker
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function previewDivTicker() {
  const code = document.getElementById('d-ticker').value.trim().toUpperCase();
  const prev = document.getElementById('d-ticker-preview');
  const name = H.tickerName(code);
  if (!code) { prev.textContent = ''; return; }
  if (name !== code) {
    prev.textContent = `âœ… ${name}`;
    prev.style.color = 'var(--green)';
  } else {
    prev.textContent = 'âš ï¸ Ø³Ù‡Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    prev.style.color = 'var(--yellow)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Add Dividend
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addDividend() {
  const date = document.getElementById('d-date').value;
  const ticker = document.getElementById('d-ticker').value.trim().toUpperCase();
  const amount = parseFloat(document.getElementById('d-amount').value);
  const note = document.getElementById('d-note').value.trim();

  if (!date || !ticker || !amount) {
    toast('âš ï¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©', 'warn');
    return;
  }

  const newDiv = {
    no: divData.length + 1,
    date,
    ticker,
    stock: H.tickerName(ticker),
    amount,
    note
  };

  divData.push(newDiv);

  // Clear
  document.getElementById('d-ticker').value = '';
  document.getElementById('d-amount').value = '';
  document.getElementById('d-note').value = '';
  document.getElementById('d-ticker-preview').textContent = '';

  saveAll();
  init();
  toast('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const tbody = document.getElementById('divBody');

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØ²ÙŠØ¹Ø§Øª</td></tr>';
    updateCount();
    return;
  }

  tbody.innerHTML = filtered.map(d => `
    <tr>
      <td>${d.no}</td>
      <td>${d.date}</td>
      <td><strong>${d.ticker}</strong></td>
      <td>${d.stock || H.tickerName(d.ticker)}</td>
      <td>
        <span class="editable" onclick="editAmount(${d.no}, ${d.amount})">${H.fmt(d.amount, 2)}</span>
      </td>
      <td>${d.note || '-'}</td>
      <td><button class="btn btn-danger btn-xs" onclick="deleteDividend(${d.no})">ğŸ—‘ï¸</button></td>
    </tr>
  `).join('');

  updateCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Edit Amount
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editAmount(no, currentAmount) {
  const span = event.target;
  const input = document.createElement('input');
  input.className = 'edit-input';
  input.type = 'number';
  input.step = '0.01';
  input.value = currentAmount;

  span.replaceWith(input);
  input.focus();
  input.select();

  const save = () => {
    const newAmount = parseFloat(input.value) || currentAmount;
    const idx = divData.findIndex(d => d.no === no);
    if (idx !== -1) {
      divData[idx].amount = newAmount;
    }
    renderTable();
    renderKPIs();
    renderYield();
  };

  input.onblur = save;
  input.onkeydown = (e) => {
    if (e.key === 'Enter') save();
    if (e.key === 'Escape') renderTable();
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Delete Dividend
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteDividend(no) {
  if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ²ÙŠØ¹ØŸ')) return;

  divData = divData.filter(d => d.no !== no);
  divData.forEach((d, i) => d.no = i + 1);

  saveAll();
  init();
  toast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Search
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applySearch(q) {
  searchQ = q.trim().toLowerCase();
  filtered = searchQ
    ? divData.filter(d =>
        d.ticker.toLowerCase().includes(searchQ) ||
        (d.stock || '').toLowerCase().includes(searchQ) ||
        d.date.includes(searchQ)
      )
    : [...divData];
  renderTable();
}

function updateCount() {
  document.getElementById('trCount').textContent =
    `${filtered.length} Ù…Ù† ${divData.length} ØªÙˆØ²ÙŠØ¹`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Charts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts() {
  if (!divData.length) {
    document.querySelector('#divByStock').parentElement.innerHTML = '<p style="text-align:center;color:var(--text3);padding:60px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    document.querySelector('#divByMonth').parentElement.innerHTML = '<p style="text-align:center;color:var(--text3);padding:60px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    return;
  }

  // By Stock
  const byStock = {};
  divData.forEach(d => {
    byStock[d.ticker] = (byStock[d.ticker] || 0) + d.amount;
  });
  const stockData = Object.entries(byStock).sort((a,b) => b[1] - a[1]).slice(0, 10);

  const ctx1 = document.getElementById('divByStock').getContext('2d');
  if (chartStock) chartStock.destroy();
  chartStock = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: stockData.map(s => H.tickerName(s[0])),
      datasets: [{
        label: 'Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª (Ø±.Ø³)',
        data: stockData.map(s => s[1]),
        backgroundColor: '#6366f1',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: 'var(--text3)' }, grid: { color: 'var(--border)' } },
        x: { ticks: { color: 'var(--text3)' }, grid: { display: false } }
      }
    }
  });

  // By Month
  const byMonth = {};
  divData.forEach(d => {
    const month = d.date.substring(0, 7);
    byMonth[month] = (byMonth[month] || 0) + d.amount;
  });
  const sorted = Object.keys(byMonth).sort();
  const last12 = sorted.slice(-12);

  const ctx2 = document.getElementById('divByMonth').getContext('2d');
  if (chartMonth) chartMonth.destroy();
  chartMonth = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: last12.map(m => {
        const [y, mo] = m.split('-');
        return `${mo}/${y.slice(2)}`;
      }),
      datasets: [{
        label: 'Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª (Ø±.Ø³)',
        data: last12.map(m => byMonth[m]),
        backgroundColor: '#6366f1',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: 'var(--text3)' }, grid: { color: 'var(--border)' } },
        x: { ticks: { color: 'var(--text3)' }, grid: { display: false } }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Top 5
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTop5() {
  if (!divData.length) {
    document.getElementById('top5total').innerHTML = '<p style="text-align:center;color:var(--text3);padding:40px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    return;
  }

  const byStock = {};
  divData.forEach(d => {
    byStock[d.ticker] = (byStock[d.ticker] || 0) + d.amount;
  });

  const top5 = Object.entries(byStock).sort((a,b) => b[1] - a[1]).slice(0, 5);

  document.getElementById('top5total').innerHTML = top5.map((s, i) => `
    <div class="rank-card">
      <div class="rank-no">#${i + 1}</div>
      <div class="rank-name">${H.tickerName(s[0])}</div>
      <div class="rank-val">${H.fmt(s[1], 0)} Ø±.Ø³</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAll() {
  Store.save('dividends_v1', divData);
  toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  dataSync.emit('dividends');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Export CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const headers = ['#','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„ØªÙŠÙƒØ±','Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø©'];
  const rows = divData.map(d => [d.no, d.date, d.ticker, d.stock, d.amount, d.note]);

  let csv = headers.join(',') + '\n';
  rows.forEach(r => { csv += r.join(',') + '\n'; });

  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `dividends_${H.today()}.csv`;
  link.click();

  toast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± CSV', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Export JSON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON() {
  const json = JSON.stringify(divData, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `dividends_${H.today()}.json`;
  link.click();

  toast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± JSON', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Import
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showImport() {
  document.getElementById('importModal').style.display = 'flex';
}

function closeImport() {
  document.getElementById('importModal').style.display = 'none';
  document.getElementById('divPaste').value = '';
}

function handleImportFile(input) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    document.getElementById('divPaste').value = e.target.result;
  };
  reader.readAsText(file);
}

function doImport(replace) {
  const raw = document.getElementById('divPaste').value.trim();
  if (!raw) { toast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'warn'); return; }

  try {
    let imported = [];

    if (raw.startsWith('[') || raw.startsWith('{')) {
      imported = JSON.parse(raw);
      if (!Array.isArray(imported)) imported = [imported];
    } else {
      // CSV
      const lines = raw.split('\n').filter(l => l.trim());
      lines.shift();
      imported = lines.map(line => {
        const parts = line.split(',');
        return {
          no: parseInt(parts[0]) || 0,
          date: parts[1] || H.today(),
          ticker: (parts[2] || '').trim().toUpperCase(),
          stock: parts[3] || '',
          amount: parseFloat(parts[4]) || 0,
          note: parts[5] || ''
        };
      });
    }

    imported = H.normalizeDividends(imported);

    if (replace) {
      divData = imported;
    } else {
      divData.push(...imported);
    }

    divData.forEach((d, i) => d.no = i + 1);

    saveAll();
    closeImport();
    init();

    toast(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported.length} ØªÙˆØ²ÙŠØ¹`, 'success');
  } catch(e) {
    toast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sync
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
dataSync.onDataChanged('dividends', init);
dataSync.onDataChanged('portfolio', renderYield);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Run
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>

</body>
</html>
