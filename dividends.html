<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<style>
.editable {
  cursor: pointer;
  border-bottom: 1px dashed var(--border2);
  display: inline-block;
  min-width: 30px;
  transition: border-color .2s;
}
.editable:hover { border-color: var(--accent); color: var(--accent); }

.edit-input {
  width: 100px; padding: 4px 6px;
  background: var(--bg2); border: 1px solid var(--accent);
  border-radius: 4px; color: var(--text);
  font-size: 12px; text-align: center;
  outline: none; font-family: inherit;
}

.alert-banner {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 14px 18px; border-radius: var(--radius-sm);
  border: 1px solid; margin-bottom: 10px; font-size: 13px;
}
.alert-banner.red    { background:rgba(239,68,68,.1);  border-color:rgba(239,68,68,.35);  color:var(--red);    }
.alert-banner.yellow { background:rgba(245,158,11,.1); border-color:rgba(245,158,11,.35); color:var(--yellow); }

.rank-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-bottom:4px; }
.rank-card {
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius); padding:16px; text-align:center;
}
.rank-card .rank-no   { font-size:22px; font-weight:800; color:var(--accent); }
.rank-card .rank-name { font-size:12px; font-weight:700; margin:4px 0; }
.rank-card .rank-val  { font-size:12px; color:var(--text3); }

.section-title {
  font-size:14px; font-weight:700; color:var(--text2);
  margin-bottom:14px; display:flex; align-items:center; gap:7px;
  padding-bottom:10px; border-bottom:1px solid var(--border);
}

/* â”€â”€ Yield Tabs â”€â”€ */
.yield-tabs { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
.yield-tab  {
  padding:7px 18px; border-radius:20px;
  border:1px solid var(--border); background:transparent;
  color:var(--text3); font-size:12px; font-weight:600;
  cursor:pointer; transition:all .18s; font-family:inherit;
}
.yield-tab:hover  { border-color:var(--accent); color:var(--accent); }
.yield-tab.active { background:var(--accent); border-color:var(--accent); color:#fff; }

.yield-box {
  display:grid; grid-template-columns:repeat(3,1fr); gap:14px;
  padding:18px 0 4px;
}
.yield-item { text-align:center; }
.yield-item .y-val   { font-size:22px; font-weight:800; color:var(--accent); }
.yield-item .y-label { font-size:12px; color:var(--text3); margin-top:4px; }

.chart-card { height:auto !important; display:block !important; overflow:visible !important; }
.chart-wrap { position:relative; width:100%; height:260px; overflow:hidden; }
.chart-wrap canvas { position:absolute !important; top:0 !important; left:0 !important; width:100% !important; height:100% !important; }

.muted { color:var(--text3); font-size:13px; }
.never-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; }

@media(max-width:900px){ .rank-grid{ grid-template-columns:repeat(2,1fr); } .yield-box{ grid-template-columns:repeat(2,1fr); } }
</style>
</head>
<body>
<script>initPage('dividends');</script>

<div class="main">

  <!-- Header -->
  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ’° Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</h1>
      <p>Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„ â€” Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-ghost btn-sm"   onclick="exportCSV()">ğŸ“¥ CSV</button>
      <button class="btn btn-ghost btn-sm"   onclick="exportJSON()">ğŸ“¦ JSON</button>
      <button class="btn btn-warn btn-sm"    onclick="showImport()">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <!-- Alerts -->
  <div id="alertsBox"></div>

  <!-- â”€â”€ Yield Dashboard â”€â”€ -->
  <div class="chart-card" style="margin-bottom:24px">
    <div class="section-title">ğŸ“Š Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
    <div class="yield-tabs" id="yieldTabs">
      <button class="yield-tab active" onclick="setYieldTab('12m',this)">Ø¢Ø®Ø± 12 Ø´Ù‡Ø±</button>
      <button class="yield-tab"        onclick="setYieldTab('yoc',this)">Yield on Cost</button>
      <button class="yield-tab"        onclick="setYieldTab('all',this)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</button>
    </div>
    <div id="yieldContent"></div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid cols-4" id="divKPIs"></div>

  <!-- Add Form -->
  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© ØªÙˆØ²ÙŠØ¹ Ø¬Ø¯ÙŠØ¯</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="d-date" type="date">
      </div>
      <div class="form-group">
        <label>Ø§Ø³Ù… Ø§Ù„Ø³Ù‡Ù…</label>
        <input id="d-stock" placeholder="Ø£Ø±Ø§Ù…ÙƒÙˆ" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ù…Ø¨Ù„Øº (SAR)</label>
        <input id="d-amount" type="number" step="0.01" placeholder="500">
      </div>
      <div class="form-group">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <input id="d-note" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
      </div>
    </div>
    <button class="btn btn-primary" onclick="addDividend()">â• Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <!-- Charts -->
  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ’° Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø³Ù‡Ù…</div>
      <div class="chart-wrap"><canvas id="divByStock"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“… Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</div>
      <div class="chart-wrap"><canvas id="divByMonth"></canvas></div>
    </div>
  </div>

  <!-- Ø£Ø¹Ù„Ù‰ 5 Ø¥Ø¬Ù…Ø§Ù„Ø§Ù‹ -->
  <div class="chart-card" style="margin-bottom:24px">
    <div class="section-title">ğŸ† Ø£Ø¹Ù„Ù‰ 5 Ø£Ø³Ù‡Ù… Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙˆØ²ÙŠØ¹</div>
    <div class="rank-grid" id="top5total"></div>
  </div>

  <!-- Ø£ÙØ¶Ù„ 5 Ø«Ø¨Ø§ØªØ§Ù‹ -->
  <div class="chart-card" style="margin-bottom:24px">
    <div class="section-title">ğŸ›¡ï¸ Ø£ÙØ¶Ù„ 5 Ø£Ø³Ù‡Ù… Ø«Ø¨Ø§ØªØ§Ù‹ ÙÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹</div>
    <div id="top5stable"></div>
  </div>

  <!-- Ø£ÙƒØ¨Ø± 5 Ù†Ù…ÙˆØ§Ù‹ -->
  <div class="chart-card" style="margin-bottom:24px">
    <div class="section-title">ğŸ“ˆ Ø£ÙƒØ¨Ø± 5 Ø£Ø³Ù‡Ù… Ù†Ù…ÙˆØ§Ù‹ ÙÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹</div>
    <div id="top5growth"></div>
  </div>

  <!-- Ø£Ù‚Ù„ 5 ØªÙˆØ²ÙŠØ¹Ø§Ù‹ -->
  <div class="chart-card" style="margin-bottom:24px">
    <div class="section-title">ğŸ“‰ Ø£Ù‚Ù„ 5 Ø£Ø³Ù‡Ù… ØªÙˆØ²ÙŠØ¹Ø§Ù‹</div>
    <div id="top5lowest"></div>
  </div>

  <!-- Ø£Ø¹Ù„Ù‰ 5 ØªØ°Ø¨Ø°Ø¨Ø§Ù‹ -->
  <div class="chart-card" style="margin-bottom:24px">
    <div class="section-title">âš¡ Ø£Ø¹Ù„Ù‰ 5 Ø£Ø³Ù‡Ù… ØªØ°Ø¨Ø°Ø¨Ø§Ù‹ ÙÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹</div>
    <div id="top5volatile"></div>
  </div>

  <!-- Ø£Ø³Ù‡Ù… Ø³Ù†Ø© Ø¨Ø¯ÙˆÙ† ØªÙˆØ²ÙŠØ¹ -->
  <div class="chart-card" style="margin-bottom:24px">
    <div class="section-title">ğŸš¨ Ø£Ø³Ù‡Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù…ØªÙ„Ø§ÙƒÙ‡Ø§ Ø³Ù†Ø© ÙˆÙ„Ù… ØªÙˆØ²Ø¹</div>
    <div id="neverPaidBox"></div>
  </div>

  <!-- Filters + Table -->
  <div class="toolbar">
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="applySearch(this.value)">
    <span id="trCount" style="color:var(--text3);font-size:13px"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø³Ù‡Ù…</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº (SAR)</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="divBody"></tbody>
    </table>
  </div>
</div>

<!-- Import Modal -->
<div id="importModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;align-items:center;justify-content:center">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;width:90%;max-width:500px">
    <h3 style="margin-bottom:16px">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</h3>
    <div class="info-box blue" style="margin-bottom:14px">ÙŠØ¯Ø¹Ù… <strong>JSON</strong> Ùˆ <strong>CSV</strong>.</div>
    <div style="border:2px dashed var(--border2);border-radius:var(--radius);padding:20px;text-align:center;color:var(--text3);cursor:pointer"
         onclick="document.getElementById('divFileInput').click()">ğŸ“ Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</div>
    <input id="divFileInput" type="file" accept=".json,.csv" style="display:none" onchange="handleImportFile(this)">
    <textarea id="divPaste" rows="5"
      style="width:100%;margin-top:14px;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:monospace;outline:none;resize:vertical"
      placeholder='[{"no":1,"date":"2025-08-01","stock":"Ø£Ø±Ø§Ù…ÙƒÙˆ","amount":500}]'></textarea>
    <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end">
      <button class="btn btn-ghost"   onclick="closeImport()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="doImport(false)">Ø¯Ù…Ø¬</button>
      <button class="btn btn-danger"  onclick="doImport(true)">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let divData  = Store.load('dividends_v1', APP.dividends).map(d=>({...d}));
let filtered = [...divData];
let searchQ  = '';
let activeYieldTab = '12m';
let chartStock = null, chartMonth = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Analytics Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function byStock() {
  const m = {};
  divData.forEach(d => {
    if (!m[d.stock]) m[d.stock] = [];
    m[d.stock].push({ amount: d.amount, date: d.date });
  });
  return m;
}

function totalByStock() {
  const m = byStock();
  return Object.entries(m)
    .map(([s, arr]) => ({
      stock: s,
      total: arr.reduce((a,b) => a + b.amount, 0),
      arr:   arr.map(x => x.amount),
      dates: arr.map(x => x.date)
    }))
    .sort((a,b) => b.total - a.total);
}

function cv(arr) {
  if (arr.length < 2) return 0;
  const mean = arr.reduce((a,b)=>a+b,0) / arr.length;
  const std  = Math.sqrt(arr.reduce((a,b)=>a+(b-mean)**2,0) / arr.length);
  return mean > 0 ? std / mean : 0;
}

function growth(arr) {
  if (arr.length < 2) return null;
  return (arr[arr.length-1] - arr[0]) / arr[0];
}

function consecutiveDrops(arr) {
  let max = 0, cur = 0;
  for (let i = 1; i < arr.length; i++) {
    if (arr[i] < arr[i-1]) { cur++; max = Math.max(max, cur); }
    else cur = 0;
  }
  return max;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Yield Dashboard
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setYieldTab(tab, btn) {
  activeYieldTab = tab;
  document.querySelectorAll('.yield-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderYield();
}

function renderYield() {
  const totalCost = APP.portfolio.reduce((s,p) => s + p.qty * p.avg_cost, 0);
  const totalMkt  = APP.portfolio.reduce((s,p) => s + p.qty * p.current_price, 0);
  const now       = new Date();
  const y12Ago    = new Date(now); y12Ago.setFullYear(y12Ago.getFullYear()-1);

  const divLast12 = divData
    .filter(d => d.date && new Date(d.date) >= y12Ago)
    .reduce((s,d) => s + d.amount, 0);

  const totalDiv = divData.reduce((s,d) => s + d.amount, 0);

  const yoc       = totalDiv / totalCost * 100;
  const yield12m  = divLast12 / totalCost * 100;
  const yieldMkt  = divLast12 / totalMkt  * 100;

  let html = '';

  if (activeYieldTab === '12m') {
    html = `
      <div class="yield-box">
        <div class="yield-item">
          <div class="y-val accent">${H.fmt(divLast12)} SAR</div>
          <div class="y-label">ØªÙˆØ²ÙŠØ¹Ø§Øª Ø¢Ø®Ø± 12 Ø´Ù‡Ø±</div>
        </div>
        <div class="yield-item">
          <div class="y-val pos">${H.fmt(yield12m,2)}%</div>
          <div class="y-label">Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ„ÙØ© (12Ù…)</div>
        </div>
        <div class="yield-item">
          <div class="y-val warn">${H.fmt(yieldMkt,2)}%</div>
          <div class="y-label">Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</div>
        </div>
      </div>`;
  } else if (activeYieldTab === 'yoc') {
    const monthly   = totalDiv / Math.max(divData.length,1);
    const projected = monthly * 12;
    html = `
      <div class="yield-box">
        <div class="yield-item">
          <div class="y-val pos">${H.fmt(yoc,2)}%</div>
          <div class="y-label">Yield on Cost Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
        </div>
        <div class="yield-item">
          <div class="y-val accent">${H.fmt(totalDiv)} SAR</div>
          <div class="y-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</div>
        </div>
        <div class="yield-item">
          <div class="y-val warn">${H.fmt(projected)} SAR</div>
          <div class="y-label">ØªÙˆØ²ÙŠØ¹ Ø³Ù†ÙˆÙŠ Ù…ØªÙˆÙ‚Ø¹ (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</div>
        </div>
      </div>
      <p style="font-size:11px;color:var(--text3);margin-top:8px">
        * YOC = Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ã· Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø­ÙØ¸Ø©. ÙƒÙ„Ù…Ø§ Ø§Ø±ØªÙØ¹ ÙƒÙ„Ù…Ø§ Ø£Ø«Ø¨Øª ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ.
      </p>`;
  } else {
    const startDate = divData.map(d=>d.date).filter(Boolean).sort()[0] || 'â€”';
    html = `
      <div class="yield-box">
        <div class="yield-item">
          <div class="y-val pos">${H.fmt(totalDiv)} SAR</div>
          <div class="y-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</div>
        </div>
        <div class="yield-item">
          <div class="y-val accent">${H.fmt(yoc,2)}%</div>
          <div class="y-label">YOC Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
        </div>
        <div class="yield-item">
          <div class="y-val">${divData.length} Ø¯ÙØ¹Ø©</div>
          <div class="y-label">Ù…Ù†Ø° ${startDate}</div>
        </div>
      </div>`;
  }

  document.getElementById('yieldContent').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Alerts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAlerts() {
  const m = byStock();
  const alerts = [];
  Object.entries(m).forEach(([stock, arr]) => {
    const amounts = arr.map(x=>x.amount);
    if (amounts.length < 2) return;
    const drops = consecutiveDrops(amounts);
    if (drops >= 3)
      alerts.push({ level:'red',    msg:`ğŸš¨ <strong>${stock}</strong> â€” Ø®ÙÙ‘Ø¶ Ø§Ù„ØªÙˆØ²ÙŠØ¹ <strong>${drops} Ù…Ø±Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ©</strong>. Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ø§Ø¬Ù„Ø©.` });
    else if (drops >= 2)
      alerts.push({ level:'yellow', msg:`âš ï¸ <strong>${stock}</strong> â€” Ø®ÙÙ‘Ø¶ Ø§Ù„ØªÙˆØ²ÙŠØ¹ <strong>${drops} Ù…Ø±Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ©</strong>. Ø§Ù†ØªØ¨Ù‡.` });
  });
  document.getElementById('alertsBox').innerHTML = alerts
    .map(a=>`<div class="alert-banner ${a.level}">${a.msg}</div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKPIs() {
  const total     = divData.reduce((s,d)=>s+d.amount,0);
  const totalCost = APP.portfolio.reduce((s,p)=>s+p.qty*p.avg_cost,0);
  const stocks    = new Set(divData.map(d=>d.stock)).size;
  const now       = new Date();
  const y12Ago    = new Date(now); y12Ago.setFullYear(y12Ago.getFullYear()-1);
  const last12    = divData.filter(d=>d.date&&new Date(d.date)>=y12Ago).reduce((s,d)=>s+d.amount,0);

  document.getElementById('divKPIs').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ’°</div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</div>
      <div class="kpi-value pos">${H.fmt(total)}</div>
      <div class="kpi-sub">SAR Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“Š</div>
      <div class="kpi-label">YOC Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
      <div class="kpi-value accent">${H.fmt(total/totalCost*100,2)}%</div>
      <div class="kpi-sub">Yield on Cost</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ—“ï¸</div>
      <div class="kpi-label">Ø¹Ø§Ø¦Ø¯ Ø¢Ø®Ø± 12 Ø´Ù‡Ø±</div>
      <div class="kpi-value warn">${H.fmt(last12/totalCost*100,2)}%</div>
      <div class="kpi-sub">${H.fmt(last12)} SAR</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ¦</div>
      <div class="kpi-label">Ø£Ø³Ù‡Ù… Ù…ÙˆØ²Ù‘Ø¹Ø©</div>
      <div class="kpi-value">${stocks}</div>
      <div class="kpi-sub">Ù…Ù† ${APP.portfolio.length} Ø³Ù‡Ù…</div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Charts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts() {
  const byS = totalByStock();

  if (chartStock) chartStock.destroy();
  chartStock = new Chart(document.getElementById('divByStock'), {
    type: 'bar',
    data: {
      labels: byS.map(d=>d.stock),
      datasets: [{ label:'SAR', data:byS.map(d=>d.total),
        backgroundColor:'rgba(79,142,247,.65)', borderRadius:4 }]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false} },
      scales:{
        x:{ ticks:{color:'#64748b',font:{size:10}}, grid:{color:'#1e2340'} },
        y:{ ticks:{color:'#64748b'}, grid:{color:'#1e2340'} }
      }
    }
  });

  const mMap = {};
  divData.forEach(d => {
    const m = d.date ? d.date.substring(0,7) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    mMap[m] = (mMap[m]||0) + d.amount;
  });
  const mKeys = Object.keys(mMap).sort();

  if (chartMonth) chartMonth.destroy();
  chartMonth = new Chart(document.getElementById('divByMonth'), {
    type: 'line',
    data: {
      labels: mKeys,
      datasets: [{ label:'SAR', data:mKeys.map(k=>mMap[k]),
        borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,.1)',
        borderWidth:2, fill:true, tension:.4,
        pointBackgroundColor:'#22c55e', pointRadius:4 }]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false} },
      scales:{
        x:{ ticks:{color:'#64748b',font:{size:10}}, grid:{color:'#1e2340'} },
        y:{ ticks:{color:'#64748b'}, grid:{color:'#1e2340'} }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Rank Cards
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rankCard(no, name, val, sub) {
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£'];
  return `
    <div class="rank-card">
      <div class="rank-no">${medals[no]||no+1}</div>
      <div class="rank-name">${name}</div>
      <div class="rank-val">${val}</div>
      <div class="rank-val" style="font-size:11px;margin-top:2px;color:var(--text3)">${sub}</div>
    </div>`;
}

function insufficientMsg() {
  return '<p class="muted" style="padding:16px 0">âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© â€” ÙŠØ­ØªØ§Ø¬ ÙƒÙ„ Ø³Ù‡Ù… 5 Ø¯ÙØ¹Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ranks
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRanks() {
  const byS = totalByStock();

  // â”€â”€ Ø£Ø¹Ù„Ù‰ 5 Ø¥Ø¬Ù…Ø§Ù„Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø·)
  document.getElementById('top5total').innerHTML =
    byS.slice(0,5).map((d,i) =>
      rankCard(i, d.stock, H.fmt(d.total)+' SAR', d.arr.length+' Ø¯ÙØ¹Ø©')
    ).join('') || '<p class="muted" style="padding:16px 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';

  // â”€â”€ Ø£ÙØ¶Ù„ 5 Ø«Ø¨Ø§ØªØ§Ù‹ â€” ÙŠØ´ØªØ±Ø· 5+ Ø¯ÙØ¹Ø§Øª
  const stabArr = byS
    .filter(d => d.arr.length >= 5)
    .map(d => ({...d, cvVal: cv(d.arr)}))
    .sort((a,b) => a.cvVal - b.cvVal);
  document.getElementById('top5stable').innerHTML = stabArr.length >= 1
    ? `<div class="rank-grid">${stabArr.slice(0,5).map((d,i) =>
        rankCard(i, d.stock,
          'ØªØ°Ø¨Ø°Ø¨ '+(d.cvVal*100).toFixed(1)+'%',
          d.arr.length+' Ø¯ÙØ¹Ø©'
        )).join('')}</div>`
    : insufficientMsg();

  // â”€â”€ Ø£ÙƒØ¨Ø± 5 Ù†Ù…ÙˆØ§Ù‹ â€” ÙŠØ´ØªØ±Ø· 5+ Ø¯ÙØ¹Ø§Øª ÙˆÙ†Ù…Ùˆ Ù…ÙˆØ¬Ø¨
  const growArr = byS
    .filter(d => d.arr.length >= 5)
    .map(d => ({...d, gVal: growth(d.arr)}))
    .filter(d => d.gVal !== null && d.gVal > 0)
    .sort((a,b) => b.gVal - a.gVal);
  document.getElementById('top5growth').innerHTML = growArr.length >= 1
    ? `<div class="rank-grid">${growArr.slice(0,5).map((d,i) =>
        rankCard(i, d.stock,
          '+'+H.fmt(d.gVal*100,1)+'%',
          H.fmt(d.arr[0])+' â† '+H.fmt(d.arr[d.arr.length-1])+' SAR'
        )).join('')}</div>`
    : insufficientMsg();

  // â”€â”€ Ø£Ù‚Ù„ 5 ØªÙˆØ²ÙŠØ¹Ø§Ù‹ â€” ÙÙ‚Ø· Ù…Ù† ÙˆØ²Ù‘Ø¹ (Ø¨Ø¯ÙˆÙ† Ø£ØµÙØ§Ø±)
  const lowestArr = [...byS]
    .filter(d => d.total > 0)
    .sort((a,b) => a.total - b.total);
  document.getElementById('top5lowest').innerHTML = lowestArr.length >= 1
    ? `<div class="rank-grid">${lowestArr.slice(0,5).map((d,i) =>
        rankCard(i, d.stock,
          H.fmt(d.total)+' SAR',
          d.arr.length+' Ø¯ÙØ¹Ø©'
        )).join('')}</div>`
    : '<p class="muted" style="padding:16px 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';

  // â”€â”€ Ø£Ø¹Ù„Ù‰ 5 ØªØ°Ø¨Ø°Ø¨Ø§Ù‹ â€” ÙŠØ´ØªØ±Ø· 5+ Ø¯ÙØ¹Ø§Øª
  const volArr = byS
    .filter(d => d.arr.length >= 5)
    .map(d => ({...d, cvVal: cv(d.arr)}))
    .sort((a,b) => b.cvVal - a.cvVal);
  document.getElementById('top5volatile').innerHTML = volArr.length >= 1
    ? `<div class="rank-grid">${volArr.slice(0,5).map((d,i) =>
        rankCard(i, d.stock,
          'ØªØ°Ø¨Ø°Ø¨ '+(d.cvVal*100).toFixed(1)+'%',
          d.arr.length+' Ø¯ÙØ¹Ø©'
        )).join('')}</div>`
    : insufficientMsg();

  // â”€â”€ Ø£Ø³Ù‡Ù… Ø³Ù†Ø© Ø¨Ø¯ÙˆÙ† ØªÙˆØ²ÙŠØ¹
  renderNeverPaid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Never Paid
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNeverPaid() {
  const transactions = Store.load('transactions_v1', APP.transactions);
  const oneYearAgo   = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

  // Ø£ÙˆÙ„ Ø´Ø±Ø§Ø¡ Ù„ÙƒÙ„ Ø³Ù‡Ù… (Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªÙŠÙƒØ±)
  const firstBuy = {};
  transactions
    .filter(t => t.status === 'Buy')
    .forEach(t => {
      const port = APP.portfolio.find(p =>
        p.ticker === t.ticker ||
        p.stock  === t.ticker ||
        p.ticker === t.stock  ||
        p.stock  === t.stock
      );
      const name = port?.stock || t.ticker;
      if (!firstBuy[name] || (t.date && t.date < firstBuy[name]))
        firstBuy[name] = t.date;
    });

  const divStocks = new Set(divData.map(d => d.stock));

  const neverPaid = APP.portfolio.filter(p => {
    const buyDate = firstBuy[p.stock];
    if (!buyDate) return false;
    return new Date(buyDate) <= oneYearAgo && !divStocks.has(p.stock);
  });

  const box = document.getElementById('neverPaidBox');
  if (!neverPaid.length) {
    box.innerHTML = '<p class="muted" style="padding:4px 0">âœ… ÙƒÙ„ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ØªÙŠ Ù…Ø¶Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ Ø³Ù†Ø© Ù‚Ø¯ ÙˆØ²Ù‘Ø¹Øª</p>';
    return;
  }

  box.innerHTML = `<div class="never-grid">
    ${neverPaid.map(p => `
      <div class="rank-card" style="border-color:rgba(239,68,68,.4)">
        <div class="rank-no">ğŸš¨</div>
        <div class="rank-name">${p.stock}</div>
        <div class="rank-val" style="color:var(--red)">Ù„Ù… ÙŠÙˆØ²Ø¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</div>
        <div class="rank-val" style="font-size:11px;margin-top:2px">Ù…Ù†Ø° ${firstBuy[p.stock]||'â€”'}</div>
      </div>`).join('')}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  document.getElementById('trCount').textContent = `${filtered.length} Ø³Ø¬Ù„`;
  if (!filtered.length) {
    document.getElementById('divBody').innerHTML = `
      <tr><td colspan="6"><div class="empty-state">
        <div class="empty-icon">ğŸ’¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>
      </div></td></tr>`;
    return;
  }
  document.getElementById('divBody').innerHTML = filtered.map(d => {
    const idx = divData.indexOf(d);
    return `<tr>
      <td style="color:var(--text3)">${d.no||idx+1}</td>
      <td><span class="editable" onclick="editDate(this,${idx},'date')">${d.date||'â€”'}</span></td>
      <td style="font-weight:600"><span class="editable" onclick="editText(this,${idx},'stock')">${d.stock}</span></td>
      <td class="pos" style="font-weight:700"><span class="editable" onclick="editNum(this,${idx},'amount')">${H.fmt(d.amount)}</span></td>
      <td style="color:var(--text3)"><span class="editable" onclick="editText(this,${idx},'note')">${d.note||'â€”'}</span></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteRow(${idx})">ğŸ—‘</button></td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Add
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addDividend() {
  const date   = document.getElementById('d-date').value   || H.today();
  const stock  = document.getElementById('d-stock').value.trim();
  const amount = parseFloat(document.getElementById('d-amount').value)||0;
  const note   = document.getElementById('d-note').value.trim();
  if (!stock)  return toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ù‡Ù…',  'error');
  if (!amount) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº',     'error');
  divData.push({ no:divData.length+1, date, stock, amount, note });
  ['d-stock','d-amount','d-note'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('d-date').value = H.today();
  refreshAll();
  toast(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØªÙˆØ²ÙŠØ¹ ${stock}`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Inline Edits
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editNum(span,idx,field){
  if(span.querySelector('input')) return;
  const inp=document.createElement('input');
  inp.className='edit-input';inp.type='number';inp.step='0.01';inp.value=divData[idx][field];
  span.textContent='';span.appendChild(inp);inp.focus();inp.select();
  const c=()=>{const v=parseFloat(inp.value);if(!isNaN(v)&&v>=0)divData[idx][field]=v;refreshAll();};
  inp.addEventListener('blur',c);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')refreshAll();});
}
function editText(span,idx,field){
  if(span.querySelector('input')) return;
  const inp=document.createElement('input');
  inp.className='edit-input';inp.style.width='120px';inp.type='text';inp.value=divData[idx][field]||'';
  span.textContent='';span.appendChild(inp);inp.focus();inp.select();
  const c=()=>{if(inp.value.trim())divData[idx][field]=inp.value.trim();refreshAll();};
  inp.addEventListener('blur',c);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')refreshAll();});
}
function editDate(span,idx,field){
  if(span.querySelector('input')) return;
  const inp=document.createElement('input');
  inp.className='edit-input';inp.style.width='130px';inp.type='date';inp.value=divData[idx][field]||H.today();
  span.textContent='';span.appendChild(inp);inp.focus();
  const c=()=>{if(inp.value)divData[idx][field]=inp.value;refreshAll();};
  inp.addEventListener('blur',c);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')refreshAll();});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Delete
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteRow(idx){
  if(!confirm(`Ø­Ø°Ù ØªÙˆØ²ÙŠØ¹ ${divData[idx].stock}ØŸ`)) return;
  divData.splice(idx,1);
  divData.forEach((d,i)=>d.no=i+1);
  refreshAll();
  toast('ğŸ—‘ ØªÙ… Ø§Ù„Ø­Ø°Ù','warn');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Search
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applySearch(q){
  searchQ=q;
  filtered=divData.filter(d=>!q||d.stock.includes(q)||(d.note||'').includes(q));
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save / Export / Import
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAll(){ Store.save('dividends_v1',divData); toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸','success'); }

function exportCSV(){
  const h=['no','date','stock','amount','note'];
  const rows=divData.map(d=>h.map(k=>d[k]??'').join(','));
  dl('\uFEFF'+[h.join(','),...rows].join('\n'),`dividends_${H.today()}.csv`,'text/csv');
  toast('ğŸ“¥ CSV','success');
}
function exportJSON(){
  dl(JSON.stringify(divData,null,2),`dividends_${H.today()}.json`,'application/json');
  toast('ğŸ“¦ JSON','success');
}
function dl(content,name,type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type}));
  a.download=name;a.click();
}
function showImport(){ document.getElementById('importModal').style.display='flex'; }
function closeImport(){
  document.getElementById('importModal').style.display='none';
  document.getElementById('divPaste').value='';
  document.getElementById('divFileInput').value='';
}
function handleImportFile(inp){
  const f=inp.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=e=>document.getElementById('divPaste').value=e.target.result;
  r.readAsText(f);
}
function doImport(replace){
  const raw=document.getElementById('divPaste').value.trim();
  if(!raw) return toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª','error');
  let data;
  try{ data=JSON.parse(raw); }
  catch(e){
    try{
      const lines=raw.split('\n').filter(l=>l.trim());
      const hdrs=lines[0].split(',').map(h=>h.trim());
      data=lines.slice(1).map(line=>{
        const v=line.split(',');const o={};
        hdrs.forEach((h,i)=>{const x=v[i]?.trim();o[h]=isNaN(x)||x===''?x:parseFloat(x);});
        return o;
      });
    }catch(e2){ return toast('ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©','error'); }
  }
  if(replace){ divData=data.map((d,i)=>({...d,no:i+1})); }
  else{ const s=divData.length;data.forEach((d,i)=>{d.no=s+i+1;divData.push(d);}); }
  closeImport();refreshAll();
  toast(`âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${data.length} Ø³Ø¬Ù„`,'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Refresh All
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshAll(){
  filtered=divData.filter(d=>!searchQ||d.stock.includes(searchQ));
  renderAlerts();
  renderYield();
  renderKPIs();
  renderCharts();
  renderRanks();
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('d-date').value = H.today();
refreshAll();
</script>
</body>
</html>
