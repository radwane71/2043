<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ù…Ø­ÙØ¸Ø© â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-sync.js"></script>
<style>
.chart-wrap { position:relative; width:100%; height:300px; }
.chart-wrap canvas { width:100% !important; height:100% !important; }
.editable {
  cursor:pointer; border-bottom:1px dashed var(--border2);
  display:inline-block; min-width:60px; transition:border-color .2s;
}
.editable:hover { border-color:var(--accent); color:var(--accent); }
.edit-input {
  width:90px; padding:4px 8px; background:var(--bg2);
  border:1px solid var(--accent); border-radius:4px;
  color:var(--text); font-size:12px; text-align:center;
  outline:none; font-family:inherit;
}
</style>
</head>
<body>
<script>initPage('portfolio');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ’¼ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h1>
      <p>Ø¬Ù…ÙŠØ¹ Ù…Ø±Ø§ÙƒØ²Ùƒ ÙÙŠ Ø§Ù„Ø£Ø³Ù‡Ù… â€” Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØªØ­Ø¯ÙŠØ«Ù‡</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-primary btn-sm" onclick="updateAllPrices()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ„</button>
      <button class="btn btn-ghost btn-sm" onclick="window.location.href='transactions.html'">â• Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
  </div>

  <div class="kpi-grid cols-5" id="portfolioKPIs"></div>

  <div class="chart-grid cols-3">
    <div class="chart-card">
      <div class="chart-title">ğŸ° ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
      <div class="chart-wrap"><canvas id="distributionChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“Š Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø·Ø§Ø¹</div>
      <div class="chart-wrap"><canvas id="sectorChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸŒ Ø­Ø³Ø¨ Ø§Ù„ØªØºØ·ÙŠØ©</div>
      <div class="chart-wrap"><canvas id="coverageChart"></canvas></div>
    </div>
  </div>

  <div class="toolbar">
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="applySearch(this.value)">
    <div style="display:flex;gap:8px">
      <select id="sectorFilter" onchange="applyFilters()" style="padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;outline:none">
        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</option>
      </select>
      <span id="trCount" style="color:var(--text3);font-size:13px;line-height:36px"></span>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø³Ù‡Ù…</th><th>Ø§Ù„Ù‚Ø·Ø§Ø¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
          <th>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th><th>%</th><th>Ø§Ù„ÙˆØ²Ù†</th>
        </tr>
      </thead>
      <tbody id="portfolioBody"></tbody>
      <tfoot id="portfolioFoot"></tfoot>
    </table>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let portfolio = [];
let filtered = [];
let searchQ = '';
let sectorFilter = '';
let chartDist = null, chartSector = null, chartCoverage = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  portfolio = APP.portfolio;
  filtered = [...portfolio];
  populateSectorFilter();
  renderKPIs();
  renderTable();
  renderCharts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKPIs() {
  const totalValue = portfolio.reduce((s, p) => s + p.qty * p.current_price, 0);
  const totalCost = portfolio.reduce((s, p) => s + p.qty * p.avg_cost, 0);
  const totalPnL = totalValue - totalCost;
  const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost * 100) : 0;
  const stocksCount = portfolio.length;

  const kpis = [
    { label:'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©',    value:H.fmt(totalValue, 0) + ' Ø±.Ø³', icon:'ğŸ’°' },
    { label:'Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©',   value:H.fmt(totalCost, 0) + ' Ø±.Ø³',  icon:'ğŸ“Š' },
    { label:'Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©',       value:H.fmt(totalPnL, 0) + ' Ø±.Ø³',   icon:'ğŸ“ˆ', color:H.colorClass(totalPnL) },
    { label:'Ø§Ù„Ù†Ø³Ø¨Ø© %',            value:H.pct(totalPnLPct),             icon:'ğŸ“‰', color:H.colorClass(totalPnLPct) },
    { label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…',          value:stocksCount.toString(),         icon:'ğŸ”¢' }
  ];

  document.getElementById('portfolioKPIs').innerHTML = kpis.map(k => `
    <div class="kpi-card">
      <div class="kpi-icon">${k.icon}</div>
      <div class="kpi-value ${k.color || ''}">${k.value}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const tbody = document.getElementById('portfolioBody');
  const tfoot = document.getElementById('portfolioFoot');

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©</td></tr>';
    tfoot.innerHTML = '';
    updateCount();
    return;
  }

  const totalValue = portfolio.reduce((s, p) => s + p.qty * p.current_price, 0);
  const totalCost = portfolio.reduce((s, p) => s + p.qty * p.avg_cost, 0);
  const totalPnL = totalValue - totalCost;

  tbody.innerHTML = filtered.map(p => {
    const value = p.qty * p.current_price;
    const cost = p.qty * p.avg_cost;
    const pnl = value - cost;
    const pnlPct = cost > 0 ? (pnl / cost * 100) : 0;
    const weight = totalValue > 0 ? (value / totalValue * 100) : 0;

    return `
      <tr>
        <td><strong>${H.tickerName(p.ticker)}</strong></td>
        <td>${p.sector}</td>
        <td>${H.fmt(p.qty, 0)}</td>
        <td>${H.fmt(p.avg_cost, 2)}</td>
        <td>
          <span class="editable" onclick="editPrice('${p.ticker}', ${p.current_price})">${H.fmt(p.current_price, 2)}</span>
        </td>
        <td><strong>${H.fmt(value, 0)}</strong></td>
        <td style="${H.colorStyle(pnl)}">${H.fmt(pnl, 0)}</td>
        <td style="${H.colorStyle(pnlPct)}">${H.pct(pnlPct)}</td>
        <td>${weight.toFixed(1)}%</td>
      </tr>
    `;
  }).join('');

  const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost * 100) : 0;

  tfoot.innerHTML = `
    <tr style="font-weight:700;background:var(--bg2)">
      <td colspan="5">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
      <td>${H.fmt(totalValue, 0)}</td>
      <td style="${H.colorStyle(totalPnL)}">${H.fmt(totalPnL, 0)}</td>
      <td style="${H.colorStyle(totalPnLPct)}">${H.pct(totalPnLPct)}</td>
      <td>100%</td>
    </tr>
  `;

  updateCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Edit Price (inline)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editPrice(ticker, currentPrice) {
  const span = event.target;
  const input = document.createElement('input');
  input.className = 'edit-input';
  input.type = 'number';
  input.step = '0.01';
  input.value = currentPrice;

  span.replaceWith(input);
  input.focus();
  input.select();

  const save = () => {
    const newPrice = parseFloat(input.value) || currentPrice;
    const idx = portfolio.findIndex(p => p.ticker === ticker);
    if (idx !== -1) {
      portfolio[idx].current_price = newPrice;
      Store.save('portfolio_v1', portfolio);
      dataSync.emit('portfolio');
    }
    init();
  };

  input.onblur = save;
  input.onkeydown = (e) => {
    if (e.key === 'Enter') save();
    if (e.key === 'Escape') init();
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Update All Prices (manual prompt)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateAllPrices() {
  if (!portfolio.length) {
    toast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©', 'warn');
    return;
  }

  let updated = 0;
  portfolio.forEach(p => {
    const newPrice = prompt(`ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± ${H.tickerName(p.ticker)}:`, p.current_price);
    if (newPrice !== null && !isNaN(newPrice)) {
      p.current_price = parseFloat(newPrice);
      updated++;
    }
  });

  if (updated > 0) {
    Store.save('portfolio_v1', portfolio);
    dataSync.emit('portfolio');
    init();
    toast(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${updated} Ø³Ù‡Ù…`, 'success');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Filters
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateSectorFilter() {
  const sectors = [...new Set(portfolio.map(p => p.sector))].sort();
  const select = document.getElementById('sectorFilter');
  select.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</option>' +
    sectors.map(s => `<option value="${s}">${s}</option>`).join('');
}

function applySearch(q) {
  searchQ = q.trim().toLowerCase();
  applyFilters();
}

function applyFilters() {
  sectorFilter = document.getElementById('sectorFilter').value;
  
  filtered = portfolio.filter(p => {
    const matchSearch = !searchQ || 
      H.tickerName(p.ticker).toLowerCase().includes(searchQ) ||
      p.ticker.toLowerCase().includes(searchQ) ||
      p.sector.toLowerCase().includes(searchQ);
    
    const matchSector = !sectorFilter || p.sector === sectorFilter;
    
    return matchSearch && matchSector;
  });

  renderTable();
}

function updateCount() {
  document.getElementById('trCount').textContent = 
    `${filtered.length} Ù…Ù† ${portfolio.length} Ø³Ù‡Ù…`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Charts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts() {
  if (!portfolio.length) {
    ['#distributionChart', '#sectorChart', '#coverageChart'].forEach(id => {
      document.querySelector(id).parentElement.innerHTML = 
        '<p style="text-align:center;color:var(--text3);padding:60px 20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    });
    return;
  }

  // Distribution Chart
  const distData = portfolio.map(p => ({
    ticker: p.ticker,
    value: p.qty * p.current_price
  })).sort((a,b) => b.value - a.value).slice(0, 10);

  const ctx1 = document.getElementById('distributionChart').getContext('2d');
  if (chartDist) chartDist.destroy();
  chartDist = new Chart(ctx1, {
    type: 'doughnut',
    data: {
      labels: distData.map(d => H.tickerName(d.ticker)),
      datasets: [{
        data: distData.map(d => d.value),
        backgroundColor: CHART_COLORS,
        borderWidth: 3,
        borderColor: CHART_BORDER_COLOR
      }]
    },
    options: {
      ...getChartOptions(),
      plugins: {
        ...getChartOptions().plugins,
        tooltip: {
          ...getChartOptions().plugins.tooltip,
          callbacks: { label: (ctx) => `${ctx.label}: ${H.fmt(ctx.parsed, 0)} Ø±.Ø³` }
        }
      }
    }
  });

  // Sector Chart
  const bySector = {};
  portfolio.forEach(p => {
    const sector = p.sector || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    bySector[sector] = (bySector[sector] || 0) + p.qty * p.current_price;
  });
  const sectorData = Object.entries(bySector).sort((a,b) => b[1] - a[1]);

  const ctx2 = document.getElementById('sectorChart').getContext('2d');
  if (chartSector) chartSector.destroy();
  chartSector = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: sectorData.map(s => s[0]),
      datasets: [{
        data: sectorData.map(s => s[1]),
        backgroundColor: CHART_COLORS,
        borderWidth: 3,
        borderColor: CHART_BORDER_COLOR
      }]
    },
    options: {
      ...getChartOptions(),
      plugins: {
        ...getChartOptions().plugins,
        tooltip: {
          ...getChartOptions().plugins.tooltip,
          callbacks: { label: (ctx) => `${ctx.label}: ${H.fmt(ctx.parsed, 0)} Ø±.Ø³` }
        }
      }
    }
  });

  // Coverage Chart
  const byCoverage = {};
  portfolio.forEach(p => {
    const coverage = p.coverage || 'Ù…Ø­Ù„ÙŠ';
    byCoverage[coverage] = (byCoverage[coverage] || 0) + p.qty * p.current_price;
  });
  const coverageData = Object.entries(byCoverage).sort((a,b) => b[1] - a[1]);

  const ctx3 = document.getElementById('coverageChart').getContext('2d');
  if (chartCoverage) chartCoverage.destroy();
  chartCoverage = new Chart(ctx3, {
    type: 'bar',
    data: {
      labels: coverageData.map(c => c[0]),
      datasets: [{
        label: 'Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø±.Ø³)',
        data: coverageData.map(c => c[1]),
        backgroundColor: CHART_COLORS.slice(0, coverageData.length),
        borderRadius: 8
      }]
    },
    options: {
      ...getChartOptions('bar'),
      plugins: {
        ...getChartOptions('bar').plugins,
        legend: { display: false },
        tooltip: {
          ...getChartOptions('bar').plugins.tooltip,
          callbacks: { label: (ctx) => `${H.fmt(ctx.parsed.y, 0)} Ø±.Ø³` }
        }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sync
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
dataSync.onDataChanged('portfolio', init);
dataSync.onDataChanged('transactions', init);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Run
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>

</body>
</html>
