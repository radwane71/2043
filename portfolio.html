<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ù…Ø­ÙØ¸Ø© â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<style>
.price-up   { color: var(--green); }
.price-down { color: var(--red);   }

/* inline edit */
.editable {
  cursor: pointer;
  border-bottom: 1px dashed var(--border2);
  transition: border-color 0.2s;
}
.editable:hover { border-color: var(--accent); }

.edit-input {
  width: 90px;
  padding: 4px 6px;
  background: var(--bg2);
  border: 1px solid var(--accent);
  border-radius: 4px;
  color: var(--text);
  font-size: 12px;
  text-align: center;
  outline: none;
  font-family: inherit;
}

.filter-tabs {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.filter-tab {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text3);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.18s;
  font-family: inherit;
}
.filter-tab:hover  { border-color: var(--accent); color: var(--accent); }
.filter-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

.zone-buy  { color: var(--green); font-weight: 600; }
.zone-sell { color: var(--yellow); font-weight: 600; }

.pct-bar-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  min-width: 100px;
}
.pct-bar-bg {
  flex: 1;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}
.pct-bar-fill {
  height: 100%;
  border-radius: 2px;
  background: var(--accent);
}
</style>
</head>
<body>
<script>initPage('portfolio');</script>

<div class="main">

  <!-- Header -->
  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ’¹ Ù†Ø¸Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©</h1>
      <p>21 Ø³Ù‡Ù… â€” Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">ğŸ“¥ ØªØµØ¯ÙŠØ± CSV</button>
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid cols-4" id="portKPIs"></div>

  <!-- Filters + Search -->
  <div class="toolbar">
    <div class="filter-tabs" id="filterTabs">
      <button class="filter-tab active" onclick="applyFilter('all',this)">Ø§Ù„ÙƒÙ„</button>
      <button class="filter-tab" onclick="applyFilter('ØªØ¬Ù…ÙŠØ¹',this)">ØªØ¬Ù…ÙŠØ¹</button>
      <button class="filter-tab" onclick="applyFilter('Ø§Ø­ØªÙØ§Ø¸',this)">Ø§Ø­ØªÙØ§Ø¸</button>
      <button class="filter-tab" onclick="applyFilter('Ù…Ø±Ø§Ù‚Ø¨Ø©',this)">Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
      <button class="filter-tab" onclick="applyFilter('ØªØ®ÙÙŠÙ',this)">ØªØ®ÙÙŠÙ</button>
    </div>
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªÙŠÙƒØ±..." oninput="applySearch(this.value)">
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ø³Ù‡Ù…</th>
          <th>Ø§Ù„ØªÙŠÙƒØ±</th>
          <th>Ø§Ù„Ù‚Ø·Ø§Ø¹</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</th>
          <th>Ø±/Ø® SAR</th>
          <th>Ø±/Ø® %</th>
          <th>Ø§Ù„ØªØ®ØµÙŠØµ %</th>
          <th>Ø§Ù„Ù‡Ø¯Ù %</th>
          <th>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</th>
          <th>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨ÙŠØ¹</th>
          <th>Ø§Ù„Ù‚Ø±Ø§Ø±</th>
          <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
        </tr>
      </thead>
      <tbody id="portBody"></tbody>
    </table>
  </div>

  <!-- Info -->
  <div class="info-box blue">
    ğŸ’¡ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ <strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø§Ù„ÙƒÙ…ÙŠØ©ØŒ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©ØŒ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨ÙŠØ¹</strong> Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©. Ø«Ù… Ø§Ø¶ØºØ· <strong>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</strong>.
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let portData = Store.load('portfolio_v1', APP.portfolio).map(p => ({...p}));
let filtered = [...portData];
let activeFilter = 'all';
let searchQ = '';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  KPIs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPIs() {
  const totalCost = portData.reduce((s,p) => s + p.qty * p.avg_cost, 0);
  const totalMkt  = portData.reduce((s,p) => s + p.qty * p.current_price, 0);
  const totalPL   = totalMkt - totalCost;
  const plPct     = totalPL / totalCost;
  const divs      = Store.load('dividends_v1', APP.dividends);
  const totalDiv  = divs.reduce((s,d) => s + d.amount, 0);

  document.getElementById('portKPIs').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ’¼</div>
      <div class="kpi-label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</div>
      <div class="kpi-value accent">${H.fmt(totalMkt)}</div>
      <div class="kpi-sub">SAR</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“Š</div>
      <div class="kpi-label">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©</div>
      <div class="kpi-value">${H.fmt(totalCost)}</div>
      <div class="kpi-sub">SAR</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“ˆ</div>
      <div class="kpi-label">Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©</div>
      <div class="kpi-value ${totalPL>=0?'pos':'neg'}">${totalPL>=0?'+':''}${H.fmt(totalPL)}</div>
      <div class="kpi-sub">${H.pct(plPct)}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ’°</div>
      <div class="kpi-label">Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</div>
      <div class="kpi-value pos">${H.fmt(totalDiv)}</div>
      <div class="kpi-sub">Ø¹Ø§Ø¦Ø¯ ${H.fmt((totalDiv/totalCost)*100,2)}%</div>
    </div>
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Render Table
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  const totalMkt = portData.reduce((s,p) => s + p.qty * p.current_price, 0);

  document.getElementById('portBody').innerHTML = filtered.map((p, i) => {
    const cost    = p.qty * p.avg_cost;
    const mkt     = p.qty * p.current_price;
    const pl      = mkt - cost;
    const plPct   = cost > 0 ? pl / cost : 0;
    const allocPct = totalMkt > 0 ? (mkt / totalMkt) * 100 : 0;
    const plClass  = pl >= 0 ? 'pos' : 'neg';
    const priceClass = p.current_price >= p.avg_cost ? 'price-up' : 'price-down';

    // Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±
    const inBuyZone  = p.current_price <= p.buy_zone_max;
    const inSellZone = p.current_price >= p.sell_zone_low;

    return `<tr data-idx="${portData.indexOf(p)}">
      <td style="color:var(--text3)">${i+1}</td>
      <td>
        <strong>${p.stock}</strong>
        ${p.is_bluechip ? '<span style="font-size:10px;color:var(--yellow)"> â­</span>' : ''}
      </td>
      <td class="accent" style="font-weight:700">${p.ticker}</td>
      <td><small style="color:var(--text3)">${p.sector}</small></td>

      <!-- ÙƒÙ…ÙŠØ© â€” Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
      <td>
        <span class="editable" onclick="editCell(this, ${portData.indexOf(p)}, 'qty')">${H.fmt(p.qty, 0)}</span>
      </td>

      <!-- Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ© â€” Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
      <td>
        <span class="editable" onclick="editCell(this, ${portData.indexOf(p)}, 'avg_cost')">${H.fmt(p.avg_cost)}</span>
      </td>

      <!-- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ â€” Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
      <td>
        <span class="editable ${priceClass}" onclick="editCell(this, ${portData.indexOf(p)}, 'current_price')">${H.fmt(p.current_price)}</span>
      </td>

      <td style="font-weight:600">${H.fmt(mkt)}</td>
      <td class="${plClass}" style="font-weight:700">${pl>=0?'+':''}${H.fmt(pl)}</td>
      <td>${H.pct(plPct)}</td>

      <!-- Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„ÙØ¹Ù„ÙŠ -->
      <td>
        <div class="pct-bar-wrap">
          <span>${allocPct.toFixed(1)}%</span>
          <div class="pct-bar-bg">
            <div class="pct-bar-fill" style="width:${Math.min(allocPct/0.15,100)}%"></div>
          </div>
        </div>
      </td>

      <td style="color:var(--text3)">${(p.goal_alloc*100).toFixed(1)}%</td>

      <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
      <td>
        <span class="editable ${inBuyZone?'zone-buy':''}"
              onclick="editCell(this, ${portData.indexOf(p)}, 'buy_zone_max')">
          &lt;${H.fmt(p.buy_zone_max)}
        </span>
      </td>

      <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨ÙŠØ¹ â€” Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
      <td>
        <span class="editable ${inSellZone?'zone-sell':''}"
              onclick="editCell(this, ${portData.indexOf(p)}, 'sell_zone_low')">
          ${H.fmt(p.sell_zone_low)}â€“${H.fmt(p.sell_zone_high)}
        </span>
      </td>

      <td>${H.badge(p.decision)}</td>
      <td><small style="color:var(--text3)">${p.eval}</small></td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Inline Edit
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editCell(span, idx, field) {
  if (span.querySelector('input')) return;

  const p     = portData[idx];
  let current = p[field];

  // Ù„Ùˆ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨ÙŠØ¹ Ù†Ø£Ø®Ø° Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø· Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  const input = document.createElement('input');
  input.className = 'edit-input';
  input.type  = 'number';
  input.value = current;
  input.step  = '0.01';

  span.textContent = '';
  span.appendChild(input);
  input.focus();
  input.select();

  function commit() {
    const val = parseFloat(input.value);
    if (!isNaN(val) && val > 0) {
      portData[idx][field] = val;

      // Ù„Ùˆ ØªØºÙŠØ± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨ÙŠØ¹ Ù†Ø­Ø¯Ø« Ø§Ù„Ø§Ø«Ù†ÙŠÙ†
      if (field === 'sell_zone_low') {
        portData[idx].sell_zone_high = parseFloat((val * 1.05).toFixed(2));
      }
    }
    applyFilters();
    renderKPIs();
  }

  input.addEventListener('blur',    commit);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter')  { input.blur(); }
    if (e.key === 'Escape') { applyFilters(); }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Filters
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilter(decision, btn) {
  activeFilter = decision;
  document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  applyFilters();
}

function applySearch(q) {
  searchQ = q;
  applyFilters();
}

function applyFilters() {
  filtered = portData.filter(p => {
    const matchFilter = activeFilter === 'all' || p.decision.includes(activeFilter);
    const matchSearch = !searchQ ||
      p.stock.includes(searchQ) ||
      p.ticker.includes(searchQ) ||
      p.sector.includes(searchQ);
    return matchFilter && matchSearch;
  });
  renderTable();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Save
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveAll() {
  Store.save('portfolio_v1', portData);
  toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª', 'success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Export CSV
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  const headers = ['Ø§Ù„Ø³Ù‡Ù…','Ø§Ù„ØªÙŠÙƒØ±','Ø§Ù„Ù‚Ø·Ø§Ø¹','Ø§Ù„ÙƒÙ…ÙŠØ©','Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©','Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ','Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©','Ø±/Ø®','Ø±/Ø®%','Ø§Ù„Ù‚Ø±Ø§Ø±'];
  const rows = portData.map(p => {
    const mkt = p.qty * p.current_price;
    const pl  = mkt - p.qty * p.avg_cost;
    return [
      p.stock, p.ticker, p.sector, p.qty,
      p.avg_cost, p.current_price, mkt.toFixed(2),
      pl.toFixed(2), ((pl/(p.qty*p.avg_cost))*100).toFixed(2)+'%',
      p.decision
    ].join(',');
  });
  const csv  = '\uFEFF' + [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `portfolio_${H.today()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  toast('ğŸ“¥ ØªÙ… ØªØµØ¯ÙŠØ± CSV', 'success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderKPIs();
applyFilters();
</script>
</body>
</html>
