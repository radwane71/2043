<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-sync.js"></script>
<script src="assets/ticker-helper.js"></script>
<style>
.editable {
  cursor:pointer; border-bottom:1px dashed var(--border2);
  display:inline-block; min-width:30px; transition:border-color .2s;
}
.editable:hover { border-color:var(--accent); color:var(--accent); }
.edit-input {
  width:110px; padding:4px 6px; background:var(--bg2);
  border:1px solid var(--accent); border-radius:4px;
  color:var(--text); font-size:12px; text-align:center;
  outline:none; font-family:inherit;
}
.yield-bar-wrap { display:flex; align-items:center; gap:6px; }
.yield-bar-bg   { flex:1; height:4px; background:var(--border); border-radius:2px; overflow:hidden; }
.yield-bar-fill { height:100%; border-radius:2px; }

/* â”€â”€ Chart fix â”€â”€ */
.chart-card {
  height: auto !important;
  display: block !important;
  overflow: visible !important;
}
.chart-wrap {
  position: relative;
  width: 100%;
  height: 260px;
  overflow: hidden;
}
.chart-wrap canvas {
  position: absolute !important;
  top: 0 !important; left: 0 !important;
  width: 100% !important;
  height: 100% !important;
}
</style>
</head>
<body>
<script>initPage('properties');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ  Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h1>
      <p>Ø³Ø¬Ù„ Ù…Ù…ØªÙ„ÙƒØ§ØªÙƒ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© â€” Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-ghost btn-sm"   onclick="exportCSV()">ğŸ“¥ CSV</button>
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid cols-4" id="prKPIs"></div>

  <!-- Charts -->
  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ¥§ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø©</div>
      <div class="chart-wrap">
        <canvas id="propChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“Š Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù„ÙƒÙ„ Ø¹Ù‚Ø§Ø±</div>
      <div class="chart-wrap">
        <canvas id="yieldChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Add Form -->
  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ø§Ø³Ù… / ÙˆØµÙ Ø§Ù„Ø¹Ù‚Ø§Ø±</label>
        <input id="pr-name" placeholder="Ø´Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ â€” Ø­ÙŠ Ø§Ù„Ù†Ø±Ø¬Ø³">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ù†ÙˆØ¹</label>
        <select id="pr-type">
          <option>Ø´Ù‚Ø© Ø³ÙƒÙ†ÙŠØ©</option><option>ÙÙŠÙ„Ø§</option>
          <option>Ø£Ø±Ø¶</option><option>Ù…Ø­Ù„ ØªØ¬Ø§Ø±ÙŠ</option>
          <option>Ù…Ø³ØªÙˆØ¯Ø¹</option><option>ØµÙ†Ø¯ÙˆÙ‚ Ø±ÙŠØª</option><option>Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
        <input id="pr-city" placeholder="Ø§Ù„Ø±ÙŠØ§Ø¶">
      </div>
      <div class="form-group">
        <label>Ø³Ù†Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</label>
        <input id="pr-year" type="number" placeholder="2022">
      </div>
      <div class="form-group">
        <label>ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡ (SAR)</label>
        <input id="pr-cost" type="number" placeholder="500000">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (SAR)</label>
        <input id="pr-value" type="number" placeholder="650000">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ (SAR)</label>
        <input id="pr-rent" type="number" placeholder="36000">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select id="pr-status">
          <option>Ù…Ø¤Ø¬Ø±</option><option>Ø´Ø§ØºØ±</option>
          <option>Ù„Ù„Ø¨ÙŠØ¹</option><option>Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠ</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <input id="pr-note" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
      </div>
    </div>
    <button class="btn btn-primary" onclick="addProperty()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±</button>
  </div>

  <!-- Table -->
  <div class="toolbar">
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="applySearch(this.value)">
    <span id="prCount" style="color:var(--text3);font-size:13px"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
          <th>Ø³Ù†Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
          <th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙˆØ±Ù‚ÙŠ</th><th>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
          <th>Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± %</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="prBody"></tbody>
    </table>
  </div>

</div>

<script>
let prData   = Store.load('properties_v1', NW_default());
let filtered = [...prData];
let searchQ  = '';

function NW_default() {
  const nw = Store.load('networth_full_v1', { properties:[] });
  return nw.properties || [];
}

let chartProp=null, chartYield=null;

// â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPIs() {
  const totalVal  = prData.reduce((s,p)=>s+(p.value||0),0);
  const totalCost = prData.reduce((s,p)=>s+(p.cost||0),0);
  const totalRent = prData.reduce((s,p)=>s+(p.rent||0),0);
  const pl        = totalVal - totalCost;
  const avgYield  = totalVal>0 ? totalRent/totalVal*100 : 0;

  document.getElementById('prKPIs').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ </div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</div>
      <div class="kpi-value accent">${H.fmt(totalVal)}</div>
      <div class="kpi-sub">SAR â€” ${prData.length} Ø¹Ù‚Ø§Ø±</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“ˆ</div>
      <div class="kpi-label">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø±Ø£Ø³Ù…Ø§Ù„ÙŠ</div>
      <div class="kpi-value ${pl>=0?'pos':'neg'}">${pl>=0?'+':''}${H.fmt(pl)}</div>
      <div class="kpi-sub">${H.pct(totalCost>0?pl/totalCost:0)}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ’°</div>
      <div class="kpi-label">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
      <div class="kpi-value pos">${H.fmt(totalRent)}</div>
      <div class="kpi-sub">${H.fmt(totalRent/12)} SAR / Ø´Ù‡Ø±ÙŠØ§Ù‹</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“Š</div>
      <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠ</div>
      <div class="kpi-value warn">${H.fmt(avgYield,2)}%</div>
      <div class="kpi-sub">Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</div>
    </div>
  `;
}

// â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts() {
  if(!prData.length) return;

  if(chartProp)  chartProp.destroy();
  if(chartYield) chartYield.destroy();

  const COLORS=['#4f8ef7','#22c55e','#f59e0b','#ef4444','#a78bfa','#06b6d4','#f97316','#84cc16'];

  chartProp = new Chart(document.getElementById('propChart'),{
    type:'doughnut',
    data:{
      labels: prData.map(p=>p.name.substring(0,12)),
      datasets:[{ data:prData.map(p=>p.value||0),
        backgroundColor:COLORS, borderColor:'#131722', borderWidth:2 }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{position:'right',labels:{color:'#94a3b8',font:{size:11},padding:8,boxWidth:12}},
        tooltip:{callbacks:{label:ctx=>`${H.fmt(ctx.raw)} SAR`}}
      }
    }
  });

  chartYield = new Chart(document.getElementById('yieldChart'),{
    type:'bar',
    data:{
      labels: prData.map(p=>p.name.substring(0,10)),
      datasets:[{
        label:'Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± %',
        data: prData.map(p=> p.value>0 ? parseFloat(((p.rent||0)/p.value*100).toFixed(2)) : 0),
        backgroundColor:'rgba(34,197,94,.65)', borderRadius:4
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#64748b',font:{size:10}},grid:{color:'#1e2340'}},
        y:{ticks:{color:'#64748b',callback:v=>v+'%'},grid:{color:'#1e2340'}}
      }
    }
  });
}

// â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  document.getElementById('prCount').textContent = `${filtered.length} Ø¹Ù‚Ø§Ø±`;

  if(!filtered.length){
    document.getElementById('prBody').innerHTML=`
      <tr><td colspan="13"><div class="empty-state">
        <div class="empty-icon">ğŸ—ï¸</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
      </div></td></tr>`;
    return;
  }

  document.getElementById('prBody').innerHTML = filtered.map(p => {
    const idx     = prData.indexOf(p);
    const pl      = (p.value||0)-(p.cost||0);
    const plPct   = p.cost>0 ? pl/p.cost : 0;
    const yld     = p.value>0 ? (p.rent||0)/p.value*100 : 0;
    const yldClr  = yld>=6?'var(--green)':yld>=4?'var(--yellow)':'var(--red)';
    const statusBadge = {
      'Ù…Ø¤Ø¬Ø±':              'badge-buy',
      'Ø´Ø§ØºØ±':              'badge-watch',
      'Ù„Ù„Ø¨ÙŠØ¹':             'badge-reduce',
      'Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠ': 'badge-hold',
    }[p.status]||'badge-hold';

    return `<tr>
      <td style="color:var(--text3)">${idx+1}</td>
      <td style="font-weight:600">
        <span class="editable" onclick="editText(this,${idx},'name')">${p.name}</span>
      </td>
      <td><span class="editable" onclick="editSelect(this,${idx},'type',['Ø´Ù‚Ø© Ø³ÙƒÙ†ÙŠØ©','ÙÙŠÙ„Ø§','Ø£Ø±Ø¶','Ù…Ø­Ù„ ØªØ¬Ø§Ø±ÙŠ','Ù…Ø³ØªÙˆØ¯Ø¹','ØµÙ†Ø¯ÙˆÙ‚ Ø±ÙŠØª','Ø£Ø®Ø±Ù‰'])">${p.type}</span></td>
      <td><span class="editable" onclick="editText(this,${idx},'city')">${p.city||'â€”'}</span></td>
      <td style="color:var(--text3)"><span class="editable" onclick="editNum(this,${idx},'year',0)">${p.year||'â€”'}</span></td>
      <td><span class="editable" onclick="editNum(this,${idx},'cost')">${H.fmt(p.cost||0)}</span></td>
      <td class="accent" style="font-weight:700">
        <span class="editable" onclick="editNum(this,${idx},'value')">${H.fmt(p.value||0)}</span>
      </td>
      <td class="${pl>=0?'pos':'neg'}" style="font-weight:600">${pl>=0?'+':''}${H.fmt(pl)}</td>
      <td class="pos">
        <span class="editable" onclick="editNum(this,${idx},'rent')">${H.fmt(p.rent||0)}</span>
      </td>
      <td>
        <div class="yield-bar-wrap">
          <span style="color:${yldClr};font-weight:700">${yld.toFixed(2)}%</span>
          <div class="yield-bar-bg">
            <div class="yield-bar-fill" style="width:${Math.min(yld/10*100,100)}%;background:${yldClr}"></div>
          </div>
        </div>
      </td>
      <td><span class="badge ${statusBadge}">${p.status||'â€”'}</span></td>
      <td style="color:var(--text3)">
        <span class="editable" onclick="editText(this,${idx},'note')">${p.note||'â€”'}</span>
      </td>
      <td><button class="btn btn-danger btn-sm" onclick="delProp(${idx})">ğŸ—‘</button></td>
    </tr>`;
  }).join('');
}

// â”€â”€ Inline Edits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editNum(span,idx,field,min=0){
  if(span.querySelector('input')) return;
  const inp=document.createElement('input');
  inp.className='edit-input'; inp.type='number'; inp.step='0.01'; inp.value=prData[idx][field]||0;
  span.textContent=''; span.appendChild(inp); inp.focus(); inp.select();
  const c=()=>{const v=parseFloat(inp.value); if(!isNaN(v)&&v>=min) prData[idx][field]=v; refreshAll();};
  inp.addEventListener('blur',c);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')refreshAll();});
}

function editText(span,idx,field){
  if(span.querySelector('input')) return;
  const inp=document.createElement('input');
  inp.className='edit-input'; inp.style.width='140px'; inp.type='text'; inp.value=prData[idx][field]||'';
  span.textContent=''; span.appendChild(inp); inp.focus(); inp.select();
  const c=()=>{if(inp.value.trim()) prData[idx][field]=inp.value.trim(); refreshAll();};
  inp.addEventListener('blur',c);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')refreshAll();});
}

function editSelect(span,idx,field,options){
  if(span.querySelector('select')) return;
  const sel=document.createElement('select');
  sel.className='edit-input'; sel.style.width='130px';
  options.forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o;
    if(o===prData[idx][field]) opt.selected=true; sel.appendChild(opt); });
  span.textContent=''; span.appendChild(sel); sel.focus();
  const c=()=>{prData[idx][field]=sel.value; refreshAll();};
  sel.addEventListener('blur',c);
  sel.addEventListener('change',c);
}

// â”€â”€ Add â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addProperty(){
  const name  = document.getElementById('pr-name').value.trim();
  const type  = document.getElementById('pr-type').value;
  const city  = document.getElementById('pr-city').value.trim();
  const year  = parseInt(document.getElementById('pr-year').value)||0;
  const cost  = parseFloat(document.getElementById('pr-cost').value)||0;
  const value = parseFloat(document.getElementById('pr-value').value)||0;
  const rent  = parseFloat(document.getElementById('pr-rent').value)||0;
  const status= document.getElementById('pr-status').value;
  const note  = document.getElementById('pr-note').value.trim();

  if(!name)  return toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±','error');
  if(!value) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©','error');

  prData.push({name,type,city,year,cost,value,rent,status,note});
  ['pr-name','pr-city','pr-year','pr-cost','pr-value','pr-rent','pr-note']
    .forEach(id=>document.getElementById(id).value='');
  refreshAll(); toast('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±','success');
}

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function delProp(idx){
  if(!confirm(`Ø­Ø°Ù "${prData[idx].name}"ØŸ`)) return;
  prData.splice(idx,1);
  refreshAll(); toast('ğŸ—‘ ØªÙ… Ø§Ù„Ø­Ø°Ù','warn');
}

// â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applySearch(q){
  searchQ=q;
  filtered=prData.filter(p=>!q||p.name.includes(q)||p.city?.includes(q)||p.type.includes(q));
  renderTable();
}

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveAll(){
  updateNetWorth(current => {
    const updated = { ...current, properties: prData };
    return updated;
  });
  
  toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'success');
  
  // Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
  dataSync.notifyDataChanged('dashboard', { action: 'refresh' });
  dataSync.notifyDataChanged('networth', { action: 'refresh' });
}

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(){
  const h=['name','type','city','year','cost','value','rent','status','note'];
  const rows=prData.map(p=>h.map(k=>p[k]??'').join(','));
  const csv='\uFEFF'+[h.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`properties_${H.today()}.csv`; a.click();
  toast('ğŸ“¥ ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±','success');
}

// â”€â”€ Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAll(){
  filtered=prData.filter(p=>!searchQ||p.name.includes(searchQ)||p.city?.includes(searchQ));
  renderKPIs(); renderCharts(); renderTable();
}

refreshAll();

// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù† ØµÙØ­Ø§Øª Ø£Ø®Ø±Ù‰
dataSync.onDataChanged('networth', (data, timestamp) => {
  if (JSON.stringify(data.properties) !== JSON.stringify(prData)) {
    prData = [...data.properties];
    refreshAll();
    toast('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹', 'info');
  }
});

dataSync.onDataChanged('dashboard', (data, timestamp) => {
  if (data.action === 'refresh') {
    refreshAll();
  }
});

// ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('focus', () => {
  const latestNW = Store.load('networth_full_v1', { properties: [] });
  if (JSON.stringify(latestNW.properties) !== JSON.stringify(prData)) {
    prData = [...latestNW.properties];
    refreshAll();
  }
});
</script>
</body>
</html>
