<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<style>
.editable {
  cursor: pointer;
  border-bottom: 1px dashed var(--border2);
  transition: border-color 0.2s;
  display: inline-block;
  min-width: 40px;
}
.editable:hover { border-color: var(--accent); color: var(--accent); }

.edit-input {
  width: 90px;
  padding: 4px 6px;
  background: var(--bg2);
  border: 1px solid var(--accent);
  border-radius: 4px;
  color: var(--text);
  font-size: 12px;
  text-align: center;
  outline: none;
  font-family: inherit;
}

.filter-tabs {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.filter-tab {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text3);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.18s;
  font-family: inherit;
}
.filter-tab:hover { border-color: var(--accent); color: var(--accent); }
.filter-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.filter-tab.sell-active { background: var(--red); border-color: var(--red); color: #fff; }

.import-zone {
  border: 2px dashed var(--border2);
  border-radius: var(--radius);
  padding: 24px;
  text-align: center;
  color: var(--text3);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 12px;
}
.import-zone:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: rgba(79,142,247,0.04);
}

.row-deleted { opacity: 0.4; text-decoration: line-through; }

.ticker-name-preview {
  font-size: 11px;
  margin-top: 4px;
  min-height: 16px;
  font-weight: 600;
  transition: color 0.2s;
}
</style>
</head>
<body>
<script>initPage('transactions');</script>

<div class="main">

  <!-- Header -->
  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ”„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
      <p>Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ¹ â€” Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-ghost btn-sm"   onclick="exportCSV()">ğŸ“¥ ØªØµØ¯ÙŠØ± CSV</button>
      <button class="btn btn-ghost btn-sm"   onclick="exportJSON()">ğŸ“¦ ØªØµØ¯ÙŠØ± JSON</button>
      <button class="btn btn-warn btn-sm"    onclick="document.getElementById('importModal').style.display='flex'">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid cols-5" id="trKPIs"></div>

  <!-- Add Transaction Form -->
  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ø§Ù„Ù†ÙˆØ¹</label>
        <select id="t-status">
          <option value="Buy">Ø´Ø±Ø§Ø¡ â€” Buy</option>
          <option value="Sell">Ø¨ÙŠØ¹ â€” Sell</option>
        </select>
      </div>
      <div class="form-group">
        <label>ÙƒÙˆØ¯ Ø§Ù„ØªÙŠÙƒØ±</label>
        <input id="t-ticker" placeholder="2222" autocomplete="off" oninput="fetchTickerName()" style="text-transform:uppercase;letter-spacing:1px">
        <div class="ticker-name-preview" id="t-name-preview"></div>
      </div>
      <div class="form-group">
        <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input id="t-qty" type="number" min="1" placeholder="100">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø³Ø¹Ø±</label>
        <input id="t-price" type="number" step="0.01" placeholder="25.50" oninput="calcPreview()">
      </div>
      <div class="form-group">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="t-date" type="date">
      </div>
    </div>

    <!-- Preview -->
    <div id="addPreview" style="display:none;margin-bottom:14px;padding:12px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;font-size:13px;display:flex;gap:24px;flex-wrap:wrap">
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong id="prev-total" class="accent">â€”</strong></span>
      <span>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: <strong id="prev-comm" style="color:var(--text3)">â€”</strong></span>
      <span>VAT: <strong id="prev-vat" style="color:var(--text3)">â€”</strong></span>
      <span>ØµØ§ÙÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©: <strong id="prev-net" class="pos">â€”</strong></span>
    </div>

    <button class="btn btn-primary" onclick="addTransaction()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
  </div>

  <!-- Filters -->
  <div class="toolbar">
    <div class="filter-tabs">
      <button class="filter-tab active" onclick="applyFilter('all',this)">Ø§Ù„ÙƒÙ„</button>
      <button class="filter-tab" onclick="applyFilter('Buy',this)">Ø´Ø±Ø§Ø¡ ÙÙ‚Ø·</button>
      <button class="filter-tab" onclick="applyFilter('Sell',this)">Ø¨ÙŠØ¹ ÙÙ‚Ø·</button>
    </div>
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„ØªÙŠÙƒØ± Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." oninput="applySearch(this.value)">
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ù†ÙˆØ¹</th>
          <th>Ø§Ù„ØªÙŠÙƒØ±</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
          <th>VAT</th>
          <th>ØµØ§ÙÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody id="trBody"></tbody>
    </table>
  </div>

</div>

<!-- â•â• Import Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="importModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;align-items:center;justify-content:center">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;width:90%;max-width:520px">
    <h3 style="margin-bottom:16px;font-size:16px">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>

    <div class="info-box blue" style="margin-bottom:16px">
      ÙŠØ¯Ø¹Ù… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª <strong>JSON</strong> Ø£Ùˆ <strong>CSV</strong> Ø¨Ù†ÙØ³ ØµÙŠØºØ© Ø§Ù„ØªØµØ¯ÙŠØ±.
    </div>

    <div class="import-zone" onclick="document.getElementById('fileInput').click()">
      <div style="font-size:32px;margin-bottom:8px">ğŸ“</div>
      <div>Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£Ùˆ Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª</div>
      <div style="font-size:11px;margin-top:4px">JSON / CSV</div>
    </div>
    <input id="fileInput" type="file" accept=".json,.csv" style="display:none" onchange="handleImport(this)">

    <div style="margin-top:16px">
      <label style="font-size:12px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.4px;display:block;margin-bottom:6px">
        Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON Ù…Ø¨Ø§Ø´Ø±Ø©
      </label>
      <textarea id="jsonPaste" rows="5"
        style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:monospace;outline:none;resize:vertical"
        placeholder='[{"no":1,"status":"Buy","ticker":"2222","qty":100,...}]'></textarea>
    </div>

    <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="document.getElementById('importModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="doImport()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¯Ù…Ø¬</button>
      <button class="btn btn-danger"  onclick="doImportReplace()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let trData     = Store.load('transactions_v1', APP.transactions).map(t => ({...t}));
let filtered   = [...trData];
let activeF    = 'all';
let searchQ    = '';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Helper: Ø¯Ù…Ø¬ Ø§Ù„ØªÙŠÙƒØ±Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ø®ØµØµØ©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAllTickers() {
  return [...TICKERS, ...Store.load('custom_tickers', [])];
}

function lookupTicker(code) {
  return getAllTickers().find(t => t.code === code.toString().trim().toUpperCase());
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Auto-fetch ticker name on input
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fetchTickerName() {
  const code    = document.getElementById('t-ticker').value.trim().toUpperCase();
  const preview = document.getElementById('t-name-preview');
  const found   = lookupTicker(code);

  if (!code) {
    preview.textContent = '';
    return;
  }
  if (found) {
    preview.textContent = 'âœ“ ' + found.name;
    preview.style.color = 'var(--green)';
  } else {
    preview.innerHTML = 'âš ï¸ ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù â€” <a href="settings.html" style="color:var(--accent)">Ø£Ø¶ÙÙ‡ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>';
    preview.style.color = 'var(--red)';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  KPIs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPIs() {
  const buys    = trData.filter(t => t.status === 'Buy');
  const sells   = trData.filter(t => t.status === 'Sell');
  const buyAmt  = buys.reduce((s,t)  => s + t.total, 0);
  const sellAmt = sells.reduce((s,t) => s + t.total, 0);
  const fees    = trData.reduce((s,t) => s + (t.commission||0) + (t.vat||0), 0);
  const net     = buyAmt - sellAmt;

  document.getElementById('trKPIs').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ”¢</div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
      <div class="kpi-value">${trData.length}</div>
      <div class="kpi-sub">${buys.length} Ø´Ø±Ø§Ø¡ / ${sells.length} Ø¨ÙŠØ¹</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">â¬†ï¸</div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</div>
      <div class="kpi-value pos">${H.fmt(buyAmt)}</div>
      <div class="kpi-sub">SAR</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">â¬‡ï¸</div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</div>
      <div class="kpi-value neg">${H.fmt(sellAmt)}</div>
      <div class="kpi-sub">SAR</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ’¸</div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª + VAT</div>
      <div class="kpi-value warn">${H.fmt(fees)}</div>
      <div class="kpi-sub">SAR</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ”„</div>
      <div class="kpi-label">ØµØ§ÙÙŠ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</div>
      <div class="kpi-value accent">${H.fmt(net)}</div>
      <div class="kpi-sub">Ø´Ø±Ø§Ø¡ âˆ’ Ø¨ÙŠØ¹</div>
    </div>
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Render Table
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  if (filtered.length === 0) {
    document.getElementById('trBody').innerHTML = `
      <tr><td colspan="12">
        <div class="empty-state">
          <div class="empty-icon">ğŸ”</div>
          <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
        </div>
      </td></tr>`;
    return;
  }

  document.getElementById('trBody').innerHTML = filtered.map(t => {
    const realIdx = trData.indexOf(t);
    const isBuy   = t.status === 'Buy';
    // Ø§Ù„Ø§Ø³Ù… Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ù† tickers.js â€” Ù„Ø§ fallback Ø¹Ù„Ù‰ t.name Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const name    = H.tickerName(t.ticker);

    return `<tr id="row-${realIdx}">
      <td style="color:var(--text3)">${t.no}</td>
      <td>
        <span class="badge ${isBuy ? 'badge-buy' : 'badge-sell'}">
          ${isBuy ? 'â¬† Ø´Ø±Ø§Ø¡' : 'â¬‡ Ø¨ÙŠØ¹'}
        </span>
      </td>

      <!-- Ø§Ù„ØªÙŠÙƒØ± â€” ÙƒÙˆØ¯ ÙÙ‚Ø· -->
      <td class="accent" style="font-weight:700">
        ${t.ticker}
      </td>

      <!-- Ø§Ù„Ø§Ø³Ù… â€” Ù…Ù† tickers.js Ø¯Ø§Ø¦Ù…Ø§Ù‹ -->
      <td style="color:var(--text3);font-size:12px">${name}</td>

      <!-- Ø§Ù„ÙƒÙ…ÙŠØ© â€” Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
      <td>
        <span class="editable" onclick="editNum(this,${realIdx},'qty')">${H.fmt(t.qty,0)}</span>
      </td>

      <!-- Ø§Ù„Ø³Ø¹Ø± â€” Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
      <td>
        <span class="editable" onclick="editNum(this,${realIdx},'price')">${H.fmt(t.price)}</span>
      </td>

      <td style="font-weight:700">${H.fmt(t.total)}</td>
      <td style="color:var(--text3)">${H.fmt(t.commission||0)}</td>
      <td style="color:var(--text3)">${H.fmt(t.vat||0)}</td>
      <td style="font-weight:600;color:${isBuy?'var(--red)':'var(--green)'}">${H.fmt(t.total_cost||0)}</td>

      <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® â€” Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
      <td style="color:var(--text3)">
        <span class="editable" onclick="editDate(this,${realIdx},'date')">${t.date||'â€”'}</span>
      </td>

      <td>
        <button class="btn btn-danger btn-sm" onclick="deleteRow(${realIdx})">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Inline Edit â€” Number
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editNum(span, idx, field) {
  if (span.querySelector('input')) return;
  const input = document.createElement('input');
  input.className = 'edit-input';
  input.type  = 'number';
  input.value = trData[idx][field];
  input.step  = '0.01';
  span.textContent = '';
  span.appendChild(input);
  input.focus(); input.select();

  function commit() {
    const val = parseFloat(input.value);
    if (!isNaN(val) && val >= 0) {
      trData[idx][field] = val;
      if (field === 'qty' || field === 'price') {
        const total = trData[idx].qty * trData[idx].price;
        const fees  = H.calcCommission(total);
        trData[idx].total      = parseFloat(total.toFixed(4));
        trData[idx].commission = parseFloat(fees.commission.toFixed(4));
        trData[idx].vat        = parseFloat(fees.vat.toFixed(4));
        trData[idx].total_cost = parseFloat(fees.net.toFixed(4));
      }
    }
    applyFilters();
    renderKPIs();
  }
  input.addEventListener('blur',    commit);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter')  input.blur();
    if (e.key === 'Escape') applyFilters();
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Inline Edit â€” Date
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editDate(span, idx, field) {
  if (span.querySelector('input')) return;
  const input = document.createElement('input');
  input.className = 'edit-input';
  input.style.width = '130px';
  input.type  = 'date';
  input.value = trData[idx][field] || H.today();
  span.textContent = '';
  span.appendChild(input);
  input.focus();

  function commit() {
    if (input.value) trData[idx][field] = input.value;
    applyFilters();
  }
  input.addEventListener('blur',    commit);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter')  input.blur();
    if (e.key === 'Escape') applyFilters();
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Add Transaction
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcPreview() {
  const qty   = parseFloat(document.getElementById('t-qty').value)   || 0;
  const price = parseFloat(document.getElementById('t-price').value) || 0;
  if (!qty || !price) return;

  const total = qty * price;
  const fees  = H.calcCommission(total);
  const prev  = document.getElementById('addPreview');
  prev.style.display = 'flex';
  document.getElementById('prev-total').textContent = H.fmt(total) + ' SAR';
  document.getElementById('prev-comm').textContent  = H.fmt(fees.commission) + ' SAR';
  document.getElementById('prev-vat').textContent   = H.fmt(fees.vat) + ' SAR';
  document.getElementById('prev-net').textContent   = H.fmt(fees.net) + ' SAR';
}

function addTransaction() {
  const status = document.getElementById('t-status').value;
  const code   = document.getElementById('t-ticker').value.trim().toUpperCase();
  const qty    = parseFloat(document.getElementById('t-qty').value)   || 0;
  const price  = parseFloat(document.getElementById('t-price').value) || 0;
  const date   = document.getElementById('t-date').value || H.today();

  if (!code)  return toast('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙŠÙƒØ±', 'error');
  if (!qty)   return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©', 'error');
  if (!price) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø±', 'error');

  const found = lookupTicker(code);
  if (!found) {
    return toast('âŒ ÙƒÙˆØ¯ Ø§Ù„ØªÙŠÙƒØ± ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù â€” Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ£Ø¶ÙÙ‡ Ø£ÙˆÙ„Ø§Ù‹', 'error');
  }

  const total = qty * price;
  const fees  = H.calcCommission(total);

  trData.push({
    no:         trData.length + 1,
    status,
    ticker:     code,
    qty,
    price,
    total:      parseFloat(total.toFixed(4)),
    commission: parseFloat(fees.commission.toFixed(4)),
    vat:        parseFloat(fees.vat.toFixed(4)),
    total_cost: parseFloat(fees.net.toFixed(4)),
    date,
  });

  // Reset form
  document.getElementById('t-ticker').value = '';
  document.getElementById('t-qty').value    = '';
  document.getElementById('t-price').value  = '';
  document.getElementById('t-date').value   = '';
  document.getElementById('t-name-preview').textContent = '';
  document.getElementById('addPreview').style.display = 'none';

  applyFilters();
  renderKPIs();
  toast(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${status === 'Buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'} ${code} â€” ${found.name}`, 'success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Delete Row
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteRow(idx) {
  if (!confirm(`Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© #${trData[idx].no} â€” ${trData[idx].ticker}ØŸ`)) return;
  trData.splice(idx, 1);
  trData.forEach((t, i) => t.no = i + 1);
  applyFilters();
  renderKPIs();
  toast('ğŸ—‘ ØªÙ… Ø§Ù„Ø­Ø°Ù', 'warn');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Filters
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilter(f, btn) {
  activeF = f;
  document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active','sell-active'));
  btn.classList.add(f === 'Sell' ? 'sell-active' : 'active');
  applyFilters();
}

function applySearch(q) { searchQ = q; applyFilters(); }

function applyFilters() {
  filtered = trData.filter(t => {
    const mF   = activeF === 'all' || t.status === activeF;
    const name = H.tickerName(t.ticker);
    const mS   = !searchQ ||
                 t.ticker.toLowerCase().includes(searchQ.toLowerCase()) ||
                 name.toLowerCase().includes(searchQ.toLowerCase());
    return mF && mS;
  });
  renderTable();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Save
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveAll() {
  Store.save('transactions_v1', trData);
  toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Export CSV
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  const headers = ['no','status','ticker','name','qty','price','total','commission','vat','total_cost','date'];
  const rows = trData.map(t => {
    const name = H.tickerName(t.ticker);
    return headers.map(h => h === 'name' ? name : (t[h]??'')).join(',');
  });
  const csv  = '\uFEFF' + [headers.join(','), ...rows].join('\n');
  downloadFile(csv, `transactions_${H.today()}.csv`, 'text/csv');
  toast('ğŸ“¥ ØªÙ… ØªØµØ¯ÙŠØ± CSV', 'success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Export JSON
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportJSON() {
  const json = JSON.stringify(trData, null, 2);
  downloadFile(json, `transactions_${H.today()}.json`, 'application/json');
  toast('ğŸ“¦ ØªÙ… ØªØµØ¯ÙŠØ± JSON', 'success');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Import
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleImport(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('jsonPaste').value = e.target.result;
  };
  reader.readAsText(file);
}

function parseImportData() {
  const raw = document.getElementById('jsonPaste').value.trim();
  if (!raw) { toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'error'); return null; }

  try {
    return JSON.parse(raw);
  } catch(e) {
    try {
      const lines   = raw.split('\n').filter(l => l.trim());
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const vals = line.split(',');
        const obj  = {};
        headers.forEach((h, i) => {
          const v = vals[i]?.trim();
          obj[h]  = isNaN(v) || v === '' ? v : parseFloat(v);
        });
        return obj;
      });
    } catch(e2) {
      toast('ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
      return null;
    }
  }
}

function doImport() {
  const data = parseImportData();
  if (!data || !Array.isArray(data)) return;
  const startNo = trData.length + 1;
  data.forEach((t, i) => {
    t.no = startNo + i;
    trData.push(t);
  });
  closeImport();
  applyFilters();
  renderKPIs();
  toast(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${data.length} Ø¹Ù…Ù„ÙŠØ© (Ø¯Ù…Ø¬)`, 'success');
}

function doImportReplace() {
  if (!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  const data = parseImportData();
  if (!data || !Array.isArray(data)) return;
  trData = data.map((t, i) => ({ ...t, no: i + 1 }));
  closeImport();
  applyFilters();
  renderKPIs();
  toast(`âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ â€” ${trData.length} Ø¹Ù…Ù„ÙŠØ©`, 'success');
}

function closeImport() {
  document.getElementById('importModal').style.display = 'none';
  document.getElementById('jsonPaste').value = '';
  document.getElementById('fileInput').value = '';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Drag & Drop Import
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const zone = document.querySelector('.import-zone');
if (zone) {
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.style.borderColor = 'var(--accent)'; });
  zone.addEventListener('dragleave', () => { zone.style.borderColor = ''; });
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.style.borderColor = '';
    const file = e.dataTransfer.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => { document.getElementById('jsonPaste').value = ev.target.result; };
    reader.readAsText(file);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderKPIs();
applyFilters();
document.getElementById('t-date').value = H.today();
</script>
</body>
</html>
