<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-sync.js"></script>
<style>
.status-badge {
  display:inline-block; padding:4px 10px; border-radius:12px;
  font-size:11px; font-weight:600; text-transform:uppercase;
}
.status-buy  { background:rgba(16,185,129,.15); color:#10b981; }
.status-sell { background:rgba(239,68,68,.15);  color:#ef4444; }
.ticker-preview { font-size:11px; margin-top:4px; min-height:16px; font-weight:600; }
.chart-wrap { position:relative; width:100%; height:260px; }
.chart-wrap canvas { width:100% !important; height:100% !important; }
</style>
</head>
<body>
<script>initPage('transactions');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ”„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
      <p>Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ¹</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
      <button class="btn btn-ghost btn-sm" onclick="exportJSON()">ğŸ“¦ JSON</button>
      <button class="btn btn-warn btn-sm" onclick="showImport()">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="kpi-grid cols-4" id="transKPIs"></div>

  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
        <select id="t-status">
          <option value="Buy">Ø´Ø±Ø§Ø¡</option>
          <option value="Sell">Ø¨ÙŠØ¹</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="t-date" type="date">
      </div>
      <div class="form-group">
        <label>ÙƒÙˆØ¯ Ø§Ù„ØªÙŠÙƒØ±</label>
        <input id="t-ticker" placeholder="4164" autocomplete="off" 
          oninput="previewTicker()" style="text-transform:uppercase;letter-spacing:1px">
        <div id="t-ticker-preview" class="ticker-preview"></div>
      </div>
      <div class="form-group">
        <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input id="t-qty" type="number" step="1" placeholder="100" oninput="calcTotal()">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø³Ø¹Ø±</label>
        <input id="t-price" type="number" step="0.01" placeholder="27.50" oninput="calcTotal()">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
        <input id="t-total" type="number" step="0.01" readonly style="background:var(--bg2)">
      </div>
    </div>
    <button class="btn btn-primary" onclick="addTransaction()">â• Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ“Š Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø³Ù‡Ù…</div>
      <div class="chart-wrap"><canvas id="byStockChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ“… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</div>
      <div class="chart-wrap"><canvas id="byMonthChart"></canvas></div>
    </div>
  </div>

  <div class="toolbar">
    <select onchange="filterByStatus(this.value)" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-family:inherit">
      <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
      <option value="Buy">Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙ‚Ø·</option>
      <option value="Sell">Ø§Ù„Ø¨ÙŠØ¹ ÙÙ‚Ø·</option>
    </select>
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="applySearch(this.value)">
    <span id="trCount" style="color:var(--text3);font-size:13px"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªÙŠÙƒØ±</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
          <th>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>ØªØ¹Ø¯ÙŠÙ„</th><th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="transBody"></tbody>
    </table>
  </div>

</div>

<!-- Import Modal -->
<div id="importModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;align-items:center;justify-content:center">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;width:90%;max-width:500px">
    <h3 style="margin-bottom:16px">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
    <div class="info-box blue" style="margin-bottom:14px">ÙŠØ¯Ø¹Ù… <strong>JSON</strong> Ùˆ <strong>CSV</strong>.</div>
    <div style="border:2px dashed var(--border2);border-radius:var(--radius);padding:20px;text-align:center;color:var(--text3);cursor:pointer"
         onclick="document.getElementById('transFileInput').click()">ğŸ“ Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</div>
    <input id="transFileInput" type="file" accept=".json,.csv" style="display:none" onchange="handleImportFile(this)">
    <textarea id="transPaste" rows="5"
      style="width:100%;margin-top:14px;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:monospace;outline:none;resize:vertical"
      placeholder='[{"no":1,"status":"Buy","ticker":"4164","qty":100,"price":27.5}]'></textarea>
    <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeImport()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="doImport(false)">Ø¯Ù…Ø¬</button>
      <button class="btn btn-danger" onclick="doImport(true)">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let transactions = [];
let filtered = [];
let searchQ = '';
let statusFilter = 'all';
let chartStock = null, chartMonth = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  transactions = APP.transactions;
  filtered = [...transactions];
  document.getElementById('t-date').value = H.today();
  renderKPIs();
  renderTable();
  renderCharts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKPIs() {
  const totalBuy = transactions.filter(t => t.status === 'Buy')
    .reduce((s, t) => s + (t.total_cost || t.total), 0);
  const totalSell = transactions.filter(t => t.status === 'Sell')
    .reduce((s, t) => s + (t.total || 0), 0);
  const totalCommission = transactions.reduce((s, t) => s + (t.commission || 0), 0);
  const totalVAT = transactions.reduce((s, t) => s + (t.vat || 0), 0);

  const kpis = [
    { label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡',  value:H.fmt(totalBuy, 0) + ' Ø±.Ø³',        icon:'ğŸ“¥' },
    { label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹',   value:H.fmt(totalSell, 0) + ' Ø±.Ø³',       icon:'ğŸ“¤' },
    { label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª', value:H.fmt(totalCommission, 2) + ' Ø±.Ø³', icon:'ğŸ’¸' },
    { label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©',  value:H.fmt(totalVAT, 2) + ' Ø±.Ø³',        icon:'ğŸ§¾' }
  ];

  document.getElementById('transKPIs').innerHTML = kpis.map(k => `
    <div class="kpi-card">
      <div class="kpi-icon">${k.icon}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Preview Ticker
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function previewTicker() {
  const code = document.getElementById('t-ticker').value.trim().toUpperCase();
  const prev = document.getElementById('t-ticker-preview');
  const name = H.tickerName(code);
  if (!code) { prev.textContent = ''; return; }
  if (name !== code) {
    prev.textContent = `âœ… ${name}`;
    prev.style.color = 'var(--green)';
  } else {
    prev.textContent = 'âš ï¸ Ø³Ù‡Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    prev.style.color = 'var(--yellow)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Calc Total
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcTotal() {
  const qty = parseFloat(document.getElementById('t-qty').value) || 0;
  const price = parseFloat(document.getElementById('t-price').value) || 0;
  const total = qty * price;
  document.getElementById('t-total').value = total.toFixed(2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Add Transaction
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addTransaction() {
  const status = document.getElementById('t-status').value;
  const date = document.getElementById('t-date').value;
  const ticker = document.getElementById('t-ticker').value.trim().toUpperCase();
  const qty = parseFloat(document.getElementById('t-qty').value);
  const price = parseFloat(document.getElementById('t-price').value);
  const total = qty * price;

  if (!date || !ticker || !qty || !price) {
    toast('âš ï¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©', 'warn');
    return;
  }

  const comm = H.calcCommission(total);

  const newTrans = {
    no: transactions.length + 1,
    status,
    ticker,
    qty,
    price,
    total,
    commission: comm.commission,
    vat: comm.vat,
    total_cost: comm.net,
    date
  };

  transactions.push(newTrans);
  
  // Clear form
  document.getElementById('t-ticker').value = '';
  document.getElementById('t-qty').value = '';
  document.getElementById('t-price').value = '';
  document.getElementById('t-total').value = '';
  document.getElementById('t-ticker-preview').textContent = '';
  
  saveAll();
  syncAfterTransactionChange();
  init();
  toast('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const tbody = document.getElementById('transBody');
  
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;padding:40px;color:var(--text3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
    updateCount();
    return;
  }

  tbody.innerHTML = filtered.map(t => `
    <tr>
      <td>${t.no}</td>
      <td>${t.date}</td>
      <td><span class="status-badge status-${t.status.toLowerCase()}">${t.status === 'Buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}</span></td>
      <td><strong>${t.ticker}</strong></td>
      <td>${H.tickerName(t.ticker)}</td>
      <td>${H.fmt(t.qty, 2)}</td>
      <td>${H.fmt(t.price, 2)}</td>
      <td>${H.fmt(t.total, 2)}</td>
      <td>${H.fmt(t.commission, 2)}</td>
      <td>${H.fmt(t.vat, 2)}</td>
      <td>${H.fmt(t.total_cost || t.total, 2)}</td>
      <td><button class="btn btn-ghost btn-xs" onclick="editTransaction(${t.no})">âœï¸</button></td>
      <td><button class="btn btn-danger btn-xs" onclick="deleteTransaction(${t.no})">ğŸ—‘ï¸</button></td>
    </tr>
  `).join('');

  updateCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Edit Transaction
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editTransaction(no) {
  const t = transactions.find(tr => tr.no === no);
  if (!t) return;

  const newPrice = prompt('Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯:', t.price);
  if (!newPrice || isNaN(newPrice)) return;

  const newQty = prompt('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', t.qty);
  if (!newQty || isNaN(newQty)) return;

  t.price = parseFloat(newPrice);
  t.qty = parseFloat(newQty);
  t.total = t.price * t.qty;

  const comm = H.calcCommission(t.total);
  t.commission = comm.commission;
  t.vat = comm.vat;
  t.total_cost = comm.net;

  saveAll();
  syncAfterTransactionChange();
  init();
  toast('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Delete Transaction
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteTransaction(no) {
  if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) return;
  
  transactions = transactions.filter(t => t.no !== no);
  transactions.forEach((t, i) => t.no = i + 1);
  
  saveAll();
  syncAfterTransactionChange();
  init();
  toast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Search & Filter
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applySearch(q) {
  searchQ = q.trim().toLowerCase();
  applyFilters();
}

function filterByStatus(status) {
  statusFilter = status;
  applyFilters();
}

function applyFilters() {
  filtered = transactions.filter(t => {
    const matchStatus = statusFilter === 'all' || t.status === statusFilter;
    const matchSearch = !searchQ || 
      t.ticker.toLowerCase().includes(searchQ) ||
      H.tickerName(t.ticker).toLowerCase().includes(searchQ) ||
      t.date.includes(searchQ);
    return matchStatus && matchSearch;
  });
  renderTable();
}

function updateCount() {
  document.getElementById('trCount').textContent = 
    `${filtered.length} Ù…Ù† ${transactions.length} Ø¹Ù…Ù„ÙŠØ©`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Charts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts() {
  if (!transactions.length) {
    document.querySelector('#byStockChart').parentElement.innerHTML = '<p style="text-align:center;color:var(--text3);padding:60px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    document.querySelector('#byMonthChart').parentElement.innerHTML = '<p style="text-align:center;color:var(--text3);padding:60px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    return;
  }

  // By Stock
  const byStock = {};
  transactions.forEach(t => {
    byStock[t.ticker] = (byStock[t.ticker] || 0) + 1;
  });
  const stockData = Object.entries(byStock).sort((a,b) => b[1] - a[1]).slice(0, 10);

  const ctx1 = document.getElementById('byStockChart').getContext('2d');
  if (chartStock) chartStock.destroy();
  chartStock = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: stockData.map(s => H.tickerName(s[0])),
      datasets: [{
        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
        data: stockData.map(s => s[1]),
        backgroundColor: '#6366f1',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: 'var(--text3)' }, grid: { color: 'var(--border)' } },
        x: { ticks: { color: 'var(--text3)' }, grid: { display: false } }
      }
    }
  });

  // By Month
  const byMonth = {};
  transactions.forEach(t => {
    const month = t.date.substring(0, 7);
    byMonth[month] = (byMonth[month] || 0) + 1;
  });
  const sorted = Object.keys(byMonth).sort();
  const last12 = sorted.slice(-12);

  const ctx2 = document.getElementById('byMonthChart').getContext('2d');
  if (chartMonth) chartMonth.destroy();
  chartMonth = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: last12.map(m => {
        const [y, mo] = m.split('-');
        return `${mo}/${y.slice(2)}`;
      }),
      datasets: [{
        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
        data: last12.map(m => byMonth[m]),
        borderColor: '#6366f1',
        backgroundColor: 'rgba(99,102,241,.1)',
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: 'var(--text3)' }, grid: { color: 'var(--border)' } },
        x: { ticks: { color: 'var(--text3)' }, grid: { display: false } }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAll() {
  updateTransactions(() => transactions);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Export CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const headers = ['#','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù†ÙˆØ¹','Ø§Ù„ØªÙŠÙƒØ±','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ','Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©','Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©','Ø§Ù„ØµØ§ÙÙŠ'];
  const rows = transactions.map(t => [
    t.no, t.date, t.status, t.ticker, t.qty, t.price, t.total, t.commission, t.vat, t.total_cost
  ]);
  
  let csv = headers.join(',') + '\n';
  rows.forEach(r => { csv += r.join(',') + '\n'; });
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `transactions_${H.today()}.csv`;
  link.click();
  
  toast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± CSV', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Export JSON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON() {
  const json = JSON.stringify(transactions, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `transactions_${H.today()}.json`;
  link.click();
  
  toast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± JSON', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Import
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showImport() {
  document.getElementById('importModal').style.display = 'flex';
}

function closeImport() {
  document.getElementById('importModal').style.display = 'none';
  document.getElementById('transPaste').value = '';
}

function handleImportFile(input) {
  const file = input.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    document.getElementById('transPaste').value = e.target.result;
  };
  reader.readAsText(file);
}

function doImport(replace) {
  const raw = document.getElementById('transPaste').value.trim();
  if (!raw) { toast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'warn'); return; }
  
  try {
    let imported = [];
    
    if (raw.startsWith('[') || raw.startsWith('{')) {
      imported = JSON.parse(raw);
      if (!Array.isArray(imported)) imported = [imported];
    } else {
      // CSV parsing
      const lines = raw.split('\n').filter(l => l.trim());
      lines.shift(); // remove header
      imported = lines.map(line => {
        const parts = line.split(',');
        return {
          no: parseInt(parts[0]) || 0,
          date: parts[1] || H.today(),
          status: parts[2] || 'Buy',
          ticker: (parts[3] || '').trim().toUpperCase(),
          qty: parseFloat(parts[4]) || 0,
          price: parseFloat(parts[5]) || 0,
          total: parseFloat(parts[6]) || 0,
          commission: parseFloat(parts[7]) || 0,
          vat: parseFloat(parts[8]) || 0,
          total_cost: parseFloat(parts[9]) || 0
        };
      });
    }
    
    imported = H.normalizeTransactions(imported);
    
    if (replace) {
      transactions = imported;
    } else {
      transactions.push(...imported);
    }
    
    transactions.forEach((t, i) => t.no = i + 1);
    
    saveAll();
    syncAfterTransactionChange();
    closeImport();
    init();
    
    toast(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported.length} Ø¹Ù…Ù„ÙŠØ©`, 'success');
  } catch(e) {
    toast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sync
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
dataSync.onDataChanged('transactions', init);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Run
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>

</body>
</html>
