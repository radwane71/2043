<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-sync.js"></script>
<style>
.chart-wrap { position:relative; width:100%; height:280px; }
.chart-wrap canvas { width:100% !important; height:100% !important; }
</style>
</head>
<body>
<script>initPage('transactions');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ’¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
      <p>Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ¹</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="kpi-grid cols-4" id="transKPIs"></div>

  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ø§Ù„Ù†ÙˆØ¹</label>
        <select id="t-status">
          <option value="Buy">Ø´Ø±Ø§Ø¡</option>
          <option value="Sell">Ø¨ÙŠØ¹</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…</label>
        <input id="t-ticker" placeholder="2222" list="tickerList">
        <datalist id="tickerList"></datalist>
      </div>
      <div class="form-group">
        <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input id="t-qty" type="number" step="1" placeholder="100">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø³Ø¹Ø±</label>
        <input id="t-price" type="number" step="0.01" placeholder="27.50">
      </div>
      <div class="form-group">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="t-date" type="date">
      </div>
    </div>
    <button class="btn btn-primary" onclick="addTransaction()">â• Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ“Š Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</div>
      <div class="chart-wrap"><canvas id="byMonthChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ’° Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
      <div class="chart-wrap"><canvas id="volumeChart"></canvas></div>
    </div>
  </div>

  <div class="toolbar">
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="applySearch(this.value)">
    <div style="display:flex;gap:8px">
      <select id="statusFilter" onchange="applyFilters()" style="padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;outline:none">
        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
        <option value="Buy">Ø´Ø±Ø§Ø¡</option>
        <option value="Sell">Ø¨ÙŠØ¹</option>
      </select>
      <span id="trCount" style="color:var(--text3);font-size:13px;line-height:36px"></span>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø³Ù‡Ù…</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th><th>VAT</th><th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="transBody"></tbody>
    </table>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let transactions = [];
let filtered = [];
let searchQ = '';
let statusFilter = '';
let chartMonth = null, chartVolume = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  transactions = APP.transactions;
  filtered = [...transactions];
  populateTickerList();
  document.getElementById('t-date').value = H.today();
  renderKPIs();
  renderTable();
  renderCharts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKPIs() {
  const total = transactions.length;
  const buys = transactions.filter(t => t.status === 'Buy').length;
  const sells = transactions.filter(t => t.status === 'Sell').length;
  const totalVolume = transactions.reduce((s, t) => s + (t.total || 0), 0);

  const kpis = [
    { label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',  value:total.toString(),              icon:'ğŸ“Š' },
    { label:'Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡',    value:buys.toString(),               icon:'ğŸŸ¢' },
    { label:'Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹',     value:sells.toString(),              icon:'ğŸ”´' },
    { label:'Ø­Ø¬Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„',      value:H.fmt(totalVolume, 0) + ' Ø±.Ø³', icon:'ğŸ’°' }
  ];

  document.getElementById('transKPIs').innerHTML = kpis.map(k => `
    <div class="kpi-card">
      <div class="kpi-icon">${k.icon}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ticker Datalist
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateTickerList() {
  const tickers = TickerDB.all();
  document.getElementById('tickerList').innerHTML = tickers.map(t => 
    `<option value="${t.code}">${t.name}</option>`
  ).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Add Transaction
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addTransaction() {
  const status = document.getElementById('t-status').value;
  const ticker = document.getElementById('t-ticker').value.trim().toUpperCase();
  const qty = parseFloat(document.getElementById('t-qty').value) || 0;
  const price = parseFloat(document.getElementById('t-price').value) || 0;
  const date = document.getElementById('t-date').value;

  if (!ticker || !qty || !price || !date) {
    toast('âš ï¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©', 'warn');
    return;
  }

  const total = qty * price;
  const fees = H.calcCommission(total);

  const newTrans = {
    no: transactions.length + 1,
    status,
    ticker,
    qty,
    price,
    total,
    commission: fees.commission,
    vat: fees.vat,
    total_cost: fees.net,
    date
  };

  transactions.push(newTrans);

  // Clear
  document.getElementById('t-ticker').value = '';
  document.getElementById('t-qty').value = '';
  document.getElementById('t-price').value = '';

  saveAll();
  syncAfterTransactionChange();
  init();
  toast('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const tbody = document.getElementById('transBody');

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:40px;color:var(--text3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
    updateCount();
    return;
  }

  tbody.innerHTML = filtered.map(t => {
    const statusColor = t.status === 'Buy' ? 'var(--green)' : 'var(--red)';
    const statusText = t.status === 'Buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹';

    return `
      <tr>
        <td>${t.no}</td>
        <td>${t.date}</td>
        <td><span style="color:${statusColor};font-weight:700">${statusText}</span></td>
        <td><strong>${H.tickerName(t.ticker)}</strong></td>
        <td>${H.fmt(t.qty, 0)}</td>
        <td>${H.fmt(t.price, 2)}</td>
        <td>${H.fmt(t.total, 2)}</td>
        <td>${H.fmt(t.commission, 2)}</td>
        <td>${H.fmt(t.vat, 2)}</td>
        <td><strong>${H.fmt(t.total_cost, 2)}</strong></td>
        <td><button class="btn btn-danger btn-xs" onclick="deleteTransaction(${t.no})">ğŸ—‘ï¸</button></td>
      </tr>
    `;
  }).join('');

  updateCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Delete Transaction
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteTransaction(no) {
  if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ\nØ³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­ÙØ¸Ø©.')) return;

  transactions = transactions.filter(t => t.no !== no);
  transactions.forEach((t, i) => t.no = i + 1);

  saveAll();
  syncAfterTransactionChange();
  init();
  toast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Filters
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applySearch(q) {
  searchQ = q.trim().toLowerCase();
  applyFilters();
}

function applyFilters() {
  statusFilter = document.getElementById('statusFilter').value;

  filtered = transactions.filter(t => {
    const matchSearch = !searchQ ||
      H.tickerName(t.ticker).toLowerCase().includes(searchQ) ||
      t.ticker.toLowerCase().includes(searchQ) ||
      t.date.includes(searchQ);

    const matchStatus = !statusFilter || t.status === statusFilter;

    return matchSearch && matchStatus;
  });

  renderTable();
}

function updateCount() {
  document.getElementById('trCount').textContent =
    `${filtered.length} Ù…Ù† ${transactions.length} Ø¹Ù…Ù„ÙŠØ©`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Charts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts() {
  if (!transactions.length) {
    ['#byMonthChart', '#volumeChart'].forEach(id => {
      document.querySelector(id).parentElement.innerHTML =
        '<p style="text-align:center;color:var(--text3);padding:60px 20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</p>';
    });
    return;
  }

  // By Month
  const byMonth = {};
  transactions.forEach(t => {
    const month = t.date.substring(0, 7);
    byMonth[month] = (byMonth[month] || 0) + 1;
  });

  const sorted = Object.keys(byMonth).sort();
  const last12 = sorted.slice(-12);

  const ctx1 = document.getElementById('byMonthChart').getContext('2d');
  if (chartMonth) chartMonth.destroy();
  chartMonth = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: last12.map(m => {
        const [y, mo] = m.split('-');
        return `${mo}/${y.slice(2)}`;
      }),
      datasets: [{
        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
        data: last12.map(m => byMonth[m]),
        borderColor: CHART_COLORS[0],
        backgroundColor: CHART_COLORS[0] + '20',
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        borderWidth: 2
      }]
    },
    options: {
      ...getChartOptions('line'),
      plugins: {
        ...getChartOptions('line').plugins,
        legend: { display: false }
      }
    }
  });

  // Volume
  const byVolume = {};
  transactions.forEach(t => {
    const month = t.date.substring(0, 7);
    byVolume[month] = (byVolume[month] || 0) + (t.total || 0);
  });

  const ctx2 = document.getElementById('volumeChart').getContext('2d');
  if (chartVolume) chartVolume.destroy();
  chartVolume = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: last12.map(m => {
        const [y, mo] = m.split('-');
        return `${mo}/${y.slice(2)}`;
      }),
      datasets: [{
        label: 'Ø­Ø¬Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (Ø±.Ø³)',
        data: last12.map(m => byVolume[m] || 0),
        backgroundColor: CHART_COLORS[1],
        borderRadius: 8
      }]
    },
    options: {
      ...getChartOptions('bar'),
      plugins: {
        ...getChartOptions('bar').plugins,
        legend: { display: false },
        tooltip: {
          ...getChartOptions('bar').plugins.tooltip,
          callbacks: { label: (ctx) => `${H.fmt(ctx.parsed.y, 0)} Ø±.Ø³` }
        }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAll() {
  Store.save('transactions_v1', transactions);
  toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sync
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
dataSync.onDataChanged('transactions', init);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Run
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>

</body>
</html>
