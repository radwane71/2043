<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù„Ù„Ø¶Ø® â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<style>
.editable{cursor:pointer;border-bottom:1px dashed var(--border2);display:inline-block;min-width:30px;transition:border-color .2s}
.editable:hover{border-color:var(--accent);color:var(--accent)}
.edit-input{width:110px;padding:4px 6px;background:var(--bg2);border:1px solid var(--accent);border-radius:4px;color:var(--text);font-size:12px;text-align:center;outline:none;font-family:inherit}

/* â”€â”€ Chart fix â”€â”€ */
.chart-card {
  height: auto !important;
  display: block !important;
  overflow: visible !important;
}
.chart-wrap {
  position: relative;
  width: 100%;
  height: 260px;
  overflow: hidden;
}
.chart-wrap canvas {
  position: absolute !important;
  top: 0 !important; left: 0 !important;
  width: 100% !important;
  height: 100% !important;
}
</style>
</head>
<body>
<script>initPage('cashinvest');</script>

<div class="main">
  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ’µ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù„Ù„Ø¶Ø®</h1>
      <p>Ø®Ø·Ø· Ø§Ù„Ø¶Ø® Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø© â€” Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-ghost btn-sm"   onclick="exportCSV()">ğŸ“¥ CSV</button>
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="kpi-grid cols-4" id="ciKPIs"></div>

  <div class="chart-grid cols-2">
    <div class="chart-card">
      <div class="chart-title">ğŸ“… Ø§Ù„Ø¶Ø® Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
      <div class="chart-wrap">
        <canvas id="ciMonthChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸ¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¶Ø® Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù‡Ù…</div>
      <div class="chart-wrap">
        <canvas id="ciTargetChart"></canvas>
      </div>
    </div>
  </div>

  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø© Ø¶Ø®</h3>
    <div class="form-row">
      <div class="form-group"><label>Ø§Ù„Ø´Ù‡Ø±</label><input id="ci-date" type="month"></div>
      <div class="form-group"><label>Ø§Ù„Ù…Ø¨Ù„Øº (SAR)</label><input id="ci-amount" type="number" placeholder="5000"></div>
      <div class="form-group"><label>Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</label><input id="ci-target" placeholder="Ø£Ø±Ø§Ù…ÙƒÙˆ Ø£Ùˆ Ù…ØªÙ†ÙˆØ¹"></div>
      <div class="form-group">
        <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select id="ci-stat">
          <option>Ù…Ø®Ø·Ø·</option><option>Ù…Ù†ÙØ°</option><option>Ù…Ù„ØºÙŠ</option>
        </select>
      </div>
      <div class="form-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="ci-note" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
    </div>
    <button class="btn btn-primary" onclick="addPlan()">â• Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <div class="toolbar">
    <div style="display:flex;gap:6px;flex-wrap:wrap" id="filterTabs">
      <button class="filter-tab active" onclick="setFilter('all',this)">Ø§Ù„ÙƒÙ„</button>
      <button class="filter-tab" onclick="setFilter('Ù…Ø®Ø·Ø·',this)">Ù…Ø®Ø·Ø·</button>
      <button class="filter-tab" onclick="setFilter('Ù…Ù†ÙØ°',this)">Ù…Ù†ÙØ°</button>
      <button class="filter-tab" onclick="setFilter('Ù…Ù„ØºÙŠ',this)">Ù…Ù„ØºÙŠ</button>
    </div>
    <input class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="applySearch(this.value)">
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>#</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø­Ø°Ù</th></tr>
      </thead>
      <tbody id="ciBody"></tbody>
    </table>
  </div>
</div>

<script>
// â”€â”€ filter-tab style â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ftStyle=`.filter-tab{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text3);font-size:12px;font-weight:600;cursor:pointer;transition:all .18s;font-family:inherit}.filter-tab:hover{border-color:var(--accent);color:var(--accent)}.filter-tab.active{background:var(--accent);border-color:var(--accent);color:#fff}`;
const styleEl=document.createElement('style'); styleEl.textContent=ftStyle; document.head.appendChild(styleEl);

let ciData   = Store.load('cashinvest_v1', APP.cashPlans || []);
let filtered = [...ciData];
let activeF  = 'all';
let searchQ  = '';
let chartMonth=null, chartTarget=null;

// â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPIs(){
  const planned  = ciData.filter(c=>c.status==='Ù…Ø®Ø·Ø·').reduce((s,c)=>s+c.amount,0);
  const executed = ciData.filter(c=>c.status==='Ù…Ù†ÙØ°').reduce((s,c)=>s+c.amount,0);
  const total    = ciData.reduce((s,c)=>s+c.amount,0);
  const cnt      = ciData.filter(c=>c.status==='Ù…Ù†ÙØ°').length;

  document.getElementById('ciKPIs').innerHTML=`
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ’µ</div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø·Ø·</div>
      <div class="kpi-value accent">${H.fmt(total)}</div>
      <div class="kpi-sub">SAR â€” ${ciData.length} Ø®Ø·Ø©</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">âœ…</div>
      <div class="kpi-label">Ù…Ù†ÙØ°</div>
      <div class="kpi-value pos">${H.fmt(executed)}</div>
      <div class="kpi-sub">${cnt} Ø®Ø·Ø© Ù…Ù†ÙØ°Ø©</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“‹</div>
      <div class="kpi-label">Ù…Ø®Ø·Ø·</div>
      <div class="kpi-value warn">${H.fmt(planned)}</div>
      <div class="kpi-sub">SAR Ù‚Ø§Ø¯Ù…Ø©</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“Š</div>
      <div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</div>
      <div class="kpi-value">${total>0?H.fmt(executed/total*100,1)+'%':'â€”'}</div>
      <div class="kpi-sub">Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
    </div>
  `;
}

// â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts(){
  if(chartMonth)  chartMonth.destroy();
  if(chartTarget) chartTarget.destroy();

  const mMap={};
  ciData.forEach(c=>{
    const k=c.date||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    mMap[k]=(mMap[k]||0)+c.amount;
  });
  const mKeys=Object.keys(mMap).sort();

  chartMonth=new Chart(document.getElementById('ciMonthChart'),{
    type:'bar',
    data:{
      labels:mKeys,
      datasets:[{
        label:'SAR',
        data:mKeys.map(k=>mMap[k]),
        backgroundColor: ciData.map(c=>
          c.status==='Ù…Ù†ÙØ°'?'rgba(34,197,94,.7)':
          c.status==='Ù…Ù„ØºÙŠ'?'rgba(239,68,68,.5)':'rgba(79,142,247,.6)'
        ).slice(0,mKeys.length),
        borderRadius:4
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#64748b',font:{size:10}},grid:{color:'#1e2340'}},
        y:{ticks:{color:'#64748b'},grid:{color:'#1e2340'}}
      }
    }
  });

  const tMap={};
  ciData.filter(c=>c.status!=='Ù…Ù„ØºÙŠ').forEach(c=>{
    const k=c.target||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    tMap[k]=(tMap[k]||0)+c.amount;
  });
  const tEntries=Object.entries(tMap).sort((a,b)=>b[1]-a[1]);

  chartTarget=new Chart(document.getElementById('ciTargetChart'),{
    type:'doughnut',
    data:{
      labels:tEntries.map(e=>e[0]),
      datasets:[{
        data:tEntries.map(e=>e[1]),
        backgroundColor:['#4f8ef7','#22c55e','#f59e0b','#ef4444','#a78bfa','#06b6d4','#f97316','#84cc16'],
        borderColor:'#131722', borderWidth:2
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{position:'right',labels:{color:'#94a3b8',font:{size:11},padding:8,boxWidth:12}},
        tooltip:{callbacks:{label:ctx=>`${H.fmt(ctx.raw)} SAR`}}
      }
    }
  });
}

// â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(){
  if(!filtered.length){
    document.getElementById('ciBody').innerHTML=`<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">ğŸ’¼</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø·</p></div></td></tr>`;
    return;
  }

  const badgeMap={
    'Ù…Ø®Ø·Ø·':'badge-plan',
    'Ù…Ù†ÙØ°':'badge-done',
    'Ù…Ù„ØºÙŠ':'badge-cancel'
  };

  document.getElementById('ciBody').innerHTML=filtered.map(c=>{
    const idx=ciData.indexOf(c);
    return `<tr>
      <td style="color:var(--text3)">${idx+1}</td>
      <td><span class="editable" onclick="editDate(this,${idx},'date')">${c.date||'â€”'}</span></td>
      <td class="accent" style="font-weight:700">
        <span class="editable" onclick="editNum(this,${idx},'amount')">${H.fmt(c.amount)}</span>
      </td>
      <td><span class="editable" onclick="editText(this,${idx},'target')">${c.target||'â€”'}</span></td>
      <td>
        <span class="editable badge ${badgeMap[c.status]||'badge-hold'}"
              onclick="cycleStatus(${idx})">${c.status}</span>
      </td>
      <td style="color:var(--text3)">
        <span class="editable" onclick="editText(this,${idx},'note')">${c.note||'â€”'}</span>
      </td>
      <td><button class="btn btn-danger btn-sm" onclick="delPlan(${idx})">ğŸ—‘</button></td>
    </tr>`;
  }).join('');
}

// â”€â”€ Cycle Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cycleStatus(idx){
  const order=['Ù…Ø®Ø·Ø·','Ù…Ù†ÙØ°','Ù…Ù„ØºÙŠ'];
  const cur=ciData[idx].status||'Ù…Ø®Ø·Ø·';
  ciData[idx].status=order[(order.indexOf(cur)+1)%order.length];
  refreshAll();
}

// â”€â”€ Inline Edits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editNum(span,idx,field){
  if(span.querySelector('input')) return;
  const inp=document.createElement('input');
  inp.className='edit-input';inp.type='number';inp.step='0.01';inp.value=ciData[idx][field]||0;
  span.textContent='';span.appendChild(inp);inp.focus();inp.select();
  const c=()=>{const v=parseFloat(inp.value);if(!isNaN(v)&&v>=0)ciData[idx][field]=v;refreshAll();};
  inp.addEventListener('blur',c);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')refreshAll();});
}

function editText(span,idx,field){
  if(span.querySelector('input')) return;
  const inp=document.createElement('input');
  inp.className='edit-input';inp.style.width='130px';inp.type='text';inp.value=ciData[idx][field]||'';
  span.textContent='';span.appendChild(inp);inp.focus();inp.select();
  const c=()=>{if(inp.value.trim())ciData[idx][field]=inp.value.trim();refreshAll();};
  inp.addEventListener('blur',c);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')refreshAll();});
}

function editDate(span,idx,field){
  if(span.querySelector('input')) return;
  const inp=document.createElement('input');
  inp.className='edit-input';inp.style.width='130px';inp.type='month';inp.value=ciData[idx][field]||'';
  span.textContent='';span.appendChild(inp);inp.focus();
  const c=()=>{if(inp.value)ciData[idx][field]=inp.value;refreshAll();};
  inp.addEventListener('blur',c);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')refreshAll();});
}

// â”€â”€ Add â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addPlan(){
  const date   = document.getElementById('ci-date').value;
  const amount = parseFloat(document.getElementById('ci-amount').value)||0;
  const target = document.getElementById('ci-target').value.trim();
  const status = document.getElementById('ci-stat').value;
  const note   = document.getElementById('ci-note').value.trim();

  if(!amount) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº','error');
  if(!target) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù','error');

  ciData.push({date,amount,target,status,note});
  ['ci-date','ci-amount','ci-target','ci-note'].forEach(id=>document.getElementById(id).value='');
  refreshAll(); toast('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©','success');
}

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function delPlan(idx){
  if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø©ØŸ')) return;
  ciData.splice(idx,1);
  refreshAll(); toast('ğŸ—‘ ØªÙ… Ø§Ù„Ø­Ø°Ù','warn');
}

// â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f,btn){
  activeF=f;
  document.querySelectorAll('.filter-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  applyFilters();
}
function applySearch(q){searchQ=q;applyFilters();}
function applyFilters(){
  filtered=ciData.filter(c=>{
    const mF=activeF==='all'||c.status===activeF;
    const mS=!searchQ||c.target?.includes(searchQ)||(c.note||'').includes(searchQ);
    return mF&&mS;
  });
  renderTable();
}

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveAll(){
  Store.save('cashinvest_v1',ciData);
  toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸','success');
}

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(){
  const h=['date','amount','target','status','note'];
  const rows=ciData.map(c=>h.map(k=>c[k]??'').join(','));
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\uFEFF'+[h.join(','),...rows].join('\n')],{type:'text/csv'}));
  a.download=`cashinvest_${H.today()}.csv`;a.click();
  toast('ğŸ“¥ ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±','success');
}

// â”€â”€ Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAll(){
  applyFilters();
  renderKPIs();
  renderCharts();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const now=new Date();
document.getElementById('ci-date').value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
refreshAll();
</script>
</body>
</html>
