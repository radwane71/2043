<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨ â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<style>
.salary-table-wrap {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: auto;
  margin-bottom: 24px;
}
.salary-table-wrap table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  min-width: 1200px;
}
.salary-table-wrap thead th {
  background: var(--bg2);
  color: var(--text3);
  font-weight: 700;
  font-size: 10px;
  padding: 10px 10px;
  text-align: center;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  position: sticky;
  top: 0;
  z-index: 2;
}
.salary-table-wrap tbody td {
  padding: 9px 10px;
  border-bottom: 1px solid var(--border);
  text-align: center;
  white-space: nowrap;
}
.salary-table-wrap tbody tr:last-child td { border-bottom: none; }
.salary-table-wrap tbody tr:hover td { background: rgba(79,142,247,0.03); }

.th-group {
  background: var(--card2) !important;
  color: var(--accent) !important;
  font-size: 10px !important;
  padding: 6px 10px !important;
  border-bottom: 1px solid var(--border2) !important;
}

.col-year    { background: rgba(99,102,241,0.06); font-weight: 700; color: var(--accent); }
.col-month   { background: rgba(99,102,241,0.04); color: var(--text2); }
.col-income  { background: rgba(34,197,94,0.04); }
.col-deduct  { background: rgba(239,68,68,0.04); }
.col-split   { background: rgba(245,158,11,0.04); }
.col-net     { background: rgba(79,142,247,0.06); font-weight: 700; }
.col-invest  { background: rgba(34,197,94,0.06); font-weight: 700; color: var(--green); }

.editable-cell {
  cursor: pointer;
  border-bottom: 1px dashed var(--border2);
  display: inline-block;
  min-width: 50px;
  transition: border-color 0.2s;
}
.editable-cell:hover { border-color: var(--accent); color: var(--accent); }

.cell-input {
  width: 80px;
  padding: 3px 5px;
  background: var(--bg2);
  border: 1px solid var(--accent);
  border-radius: 4px;
  color: var(--text);
  font-size: 11px;
  text-align: center;
  outline: none;
  font-family: inherit;
}

.filter-tabs {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.filter-tab {
  padding: 5px 12px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text3);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.18s;
  font-family: inherit;
}
.filter-tab:hover  { border-color: var(--accent); color: var(--accent); }
.filter-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

.month-names {
  'ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ',
  'ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'
}
</style>
</head>
<body>
<script>initPage('salary');</script>

<div class="main">

  <!-- Header -->
  <div class="page-header">
    <div class="page-header-left">
      <h1>ğŸ’³ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨</h1>
      <p>ØªØªØ¨Ø¹ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±Ø§ØªØ¨ Ù…Ù†Ø° 2019</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">ğŸ“¥ ØªØµØ¯ÙŠØ± CSV</button>
      <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid cols-4" id="salaryKPIs"></div>

  <!-- Add Record Form -->
  <div class="form-card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø´Ù‡Ø±ÙŠ</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Ø§Ù„Ø³Ù†Ø©</label>
        <input id="s-year" type="number" placeholder="2026" min="2015" max="2060">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø´Ù‡Ø±</label>
        <select id="s-month">
          <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
          <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
          <option value="3">Ù…Ø§Ø±Ø³</option>
          <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
          <option value="5">Ù…Ø§ÙŠÙˆ</option>
          <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
          <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
          <option value="8">Ø£ØºØ³Ø·Ø³</option>
          <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
          <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
          <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
          <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
        <input id="s-basic" type="number" step="0.01" placeholder="0">
      </div>
      <div class="form-group">
        <label>Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†</label>
        <input id="s-housing" type="number" step="0.01" placeholder="0">
      </div>
      <div class="form-group">
        <label>Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„</label>
        <input id="s-transport" type="number" step="0.01" placeholder="0">
      </div>
      <div class="form-group">
        <label>Ø£ÙˆÙØ± ØªØ§ÙŠÙ…</label>
        <input id="s-overtime" type="number" step="0.01" placeholder="0" oninput="calcSalaryPreview()">
      </div>
      <div class="form-group">
        <label>Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰</label>
        <input id="s-other" type="number" step="0.01" placeholder="0" oninput="calcSalaryPreview()">
      </div>
      <div class="form-group">
        <label>GOSI</label>
        <input id="s-gosi" type="number" step="0.01" placeholder="0" oninput="calcSalaryPreview()">
      </div>
      <div class="form-group">
        <label>Ø®ØµÙ… Ø³Ø§Ù†Ø¯</label>
        <input id="s-saned" type="number" step="0.01" placeholder="0" oninput="calcSalaryPreview()">
      </div>
    </div>

    <!-- Preview -->
    <div id="salaryPreview" style="display:none;margin-bottom:14px;padding:12px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;font-size:13px;display:flex;gap:24px;flex-wrap:wrap">
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong id="prev-gross" class="accent">â€”</strong></span>
      <span>Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª: <strong id="prev-deduct" style="color:var(--red)">â€”</strong></span>
      <span>Ø§Ù„ØµØ§ÙÙŠ: <strong id="prev-net" class="pos">â€”</strong></span>
    </div>

    <!-- ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±Ø§ØªØ¨ -->
    <div style="margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:10px">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±Ø§ØªØ¨</div>
      <div class="form-row" id="splitFieldsRow"></div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="addRecord()">â• Ø¥Ø¶Ø§ÙØ©</button>
      <span id="remainingPreview" style="font-size:13px;color:var(--text3)"></span>
    </div>
  </div>

  <!-- Filters -->
  <div class="toolbar">
    <div class="filter-tabs" id="yearTabs"></div>
    <button class="btn btn-ghost btn-sm" onclick="showManageColumns()">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</button>
  </div>

  <!-- Table -->
  <div class="salary-table-wrap">
    <table id="salaryTable">
      <thead id="salaryHead"></thead>
      <tbody id="salaryBody"></tbody>
    </table>
  </div>

</div>

<!-- Manage Columns Modal -->
<div id="colModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;align-items:center;justify-content:center">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;width:90%;max-width:560px;max-height:80vh;overflow-y:auto">
    <h3 style="margin-bottom:16px;font-size:15px">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹</h3>
    <div class="info-box blue" style="margin-bottom:16px;font-size:12px">
      Ø£Ø¶Ù Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø£Ùˆ Ø§Ø­Ø°Ù Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹. Ø§Ù„ØªØ±ØªÙŠØ¨ ÙŠØ¹ÙƒØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
    </div>
    <div id="colList" style="margin-bottom:16px"></div>
    <div style="display:flex;gap:10px;margin-bottom:16px">
      <input id="newColName" class="field-inline" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="flex:1">
      <button class="btn btn-primary btn-sm" onclick="addColumn()">+ Ø¥Ø¶Ø§ÙØ©</button>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="document.getElementById('colModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
      <button class="btn btn-primary" onclick="saveColumns()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Default split columns
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_COLS = [
  { id:'col_house_exp',  label:'Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØª' },
  { id:'col_wife',       label:'Ù…Ø¹ÙˆÙ†Ø© Ø§Ù„Ø²ÙˆØ¬Ø©' },
  { id:'col_fun',        label:'Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ÙÙŠÙ‡' },
  { id:'col_emergency',  label:'Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø·Ø§Ø±Ø¦' },
  { id:'col_loan',       label:'ØªÙ…ÙˆÙŠÙ„' },
  { id:'col_rc_house',   label:'Ø¨ÙŠØª Ø§Ù„Ù‡ÙŠØ¦Ø©' },
];

const MONTHS = [
  '','ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ',
  'ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let records  = Store.load('salary_v1', []);
let splitCols = Store.load('salary_cols_v1', DEFAULT_COLS);
let activeYear = 'all';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKPIs() {
  const allRec = records;
  const totalNet    = allRec.reduce((s,r) => s + (r.net||0), 0);
  const totalGross  = allRec.reduce((s,r) => s + (r.gross||0), 0);
  const totalInvest = allRec.reduce((s,r) => s + (r.col_invest||0), 0);
  const totalDeduct = allRec.reduce((s,r) => s + (r.gosi||0) + (r.saned||0), 0);

  // Ø¢Ø®Ø± Ø±Ø§ØªØ¨
  const lastRec = [...allRec].sort((a,b)=> b.year*12+b.month - (a.year*12+a.month))[0];

  document.getElementById('salaryKPIs').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ’µ</div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„</div>
      <div class="kpi-value accent">${H.fmt(totalGross)}</div>
      <div class="kpi-sub">SAR â€¢ ${allRec.length} Ø´Ù‡Ø±</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">âœ…</div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§ÙÙŠ</div>
      <div class="kpi-value pos">${H.fmt(totalNet)}</div>
      <div class="kpi-sub">Ø¨Ø¹Ø¯ GOSI ÙˆØ³Ø§Ù†Ø¯</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“¤</div>
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</div>
      <div class="kpi-value neg">${H.fmt(totalDeduct)}</div>
      <div class="kpi-sub">GOSI + Ø³Ø§Ù†Ø¯</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“ˆ</div>
      <div class="kpi-label">Ù…Ø­ÙˆÙ„ Ù„Ù„Ù…Ø­ÙØ¸Ø©</div>
      <div class="kpi-value" style="color:var(--green)">${H.fmt(totalInvest)}</div>
      <div class="kpi-sub">Ù…Ø±Ø¬Ø¹ÙŠ ÙÙ‚Ø·</div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Calc Preview
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcSalaryPreview() {
  const basic     = parseFloat(document.getElementById('s-basic').value)     || 0;
  const housing   = parseFloat(document.getElementById('s-housing').value)   || 0;
  const transport = parseFloat(document.getElementById('s-transport').value) || 0;
  const overtime  = parseFloat(document.getElementById('s-overtime').value)  || 0;
  const other     = parseFloat(document.getElementById('s-other').value)     || 0;
  const gosi      = parseFloat(document.getElementById('s-gosi').value)      || 0;
  const saned     = parseFloat(document.getElementById('s-saned').value)     || 0;

  const gross = basic + housing + transport + overtime + other;
  const net   = gross - gosi - saned;

  const prev = document.getElementById('salaryPreview');
  prev.style.display = 'flex';
  document.getElementById('prev-gross').textContent  = H.fmt(gross)  + ' SAR';
  document.getElementById('prev-deduct').textContent = H.fmt(gosi + saned) + ' SAR';
  document.getElementById('prev-net').textContent    = H.fmt(net)    + ' SAR';

  calcRemaining();
}

function calcRemaining() {
  const net = parseFloat(document.getElementById('prev-net')?.textContent) || 0;
  let spent = 0;
  splitCols.forEach(c => {
    const el = document.getElementById('sf-' + c.id);
    if (el) spent += parseFloat(el.value) || 0;
  });
  const invest = parseFloat(document.getElementById('sf-col_invest')?.value) || 0;
  spent += invest;
  const rem = net - spent;
  const el  = document.getElementById('remainingPreview');
  if (el) {
    el.textContent = `Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹: ${H.fmt(rem)} SAR`;
    el.style.color = rem >= 0 ? 'var(--green)' : 'var(--red)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render Split Fields in Form
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSplitFields() {
  const allCols = [
    ...splitCols,
    { id:'col_invest', label:'Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ ğŸ“ˆ' }
  ];
  document.getElementById('splitFieldsRow').innerHTML = allCols.map(c => `
    <div class="form-group">
      <label>${c.label}</label>
      <input id="sf-${c.id}" type="number" step="0.01" placeholder="0" oninput="calcRemaining()">
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Add Record
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addRecord() {
  const year      = parseInt(document.getElementById('s-year').value)      || 0;
  const month     = parseInt(document.getElementById('s-month').value)     || 0;
  const basic     = parseFloat(document.getElementById('s-basic').value)     || 0;
  const housing   = parseFloat(document.getElementById('s-housing').value)   || 0;
  const transport = parseFloat(document.getElementById('s-transport').value) || 0;
  const overtime  = parseFloat(document.getElementById('s-overtime').value)  || 0;
  const other     = parseFloat(document.getElementById('s-other').value)     || 0;
  const gosi      = parseFloat(document.getElementById('s-gosi').value)      || 0;
  const saned     = parseFloat(document.getElementById('s-saned').value)     || 0;

  if (!year || !month) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø±', 'error');

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
  if (records.find(r => r.year === year && r.month === month)) {
    return toast(`${MONTHS[month]} ${year} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„`, 'error');
  }

  const gross = basic + housing + transport + overtime + other;
  const net   = gross - gosi - saned;

  const rec = { year, month, basic, housing, transport, overtime, other, gosi, saned, gross, net };

  // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±Ø§ØªØ¨
  splitCols.forEach(c => {
    rec[c.id] = parseFloat(document.getElementById('sf-' + c.id)?.value) || 0;
  });
  rec['col_invest'] = parseFloat(document.getElementById('sf-col_invest')?.value) || 0;

  // Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
  let spent = splitCols.reduce((s,c) => s + (rec[c.id]||0), 0) + (rec['col_invest']||0);
  rec.after_split = parseFloat((net - spent).toFixed(2));

  records.push(rec);
  records.sort((a,b) => a.year*12+a.month - (b.year*12+b.month));

  // Reset form
  ['s-basic','s-housing','s-transport','s-overtime','s-other','s-gosi','s-saned'].forEach(id => {
    document.getElementById(id).value = '';
  });
  splitCols.forEach(c => {
    const el = document.getElementById('sf-' + c.id);
    if (el) el.value = '';
  });
  const inv = document.getElementById('sf-col_invest');
  if (inv) inv.value = '';

  document.getElementById('salaryPreview').style.display = 'none';
  document.getElementById('remainingPreview').textContent = '';

  renderAll();
  toast(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${MONTHS[month]} ${year}`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render Year Tabs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderYearTabs() {
  const years = [...new Set(records.map(r => r.year))].sort();
  const tabs  = [{ v:'all', l:'Ø§Ù„ÙƒÙ„' }, ...years.map(y => ({ v:y, l:y })), { v:'add', l:'+ Ø³Ø¬Ù„' }];

  document.getElementById('yearTabs').innerHTML = tabs.map(t => {
    if (t.v === 'add') return '';
    return `<button class="filter-tab ${activeYear == t.v ? 'active':''}" onclick="setYear(${t.v === 'all' ? "'all'" : t.v}, this)">${t.l}</button>`;
  }).join('');
}

function setYear(y, btn) {
  activeYear = y;
  document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const filtered = activeYear === 'all'
    ? records
    : records.filter(r => r.year == activeYear);

  // Head
  const allCols = [...splitCols, { id:'col_invest', label:'Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯' }];
  document.getElementById('salaryHead').innerHTML = `
    <tr>
      <th class="th-group" colspan="2">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      <th class="th-group" colspan="5">ğŸ’µ Ø§Ù„Ø¯Ø®Ù„</th>
      <th class="th-group" colspan="2">ğŸ“¤ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</th>
      <th class="th-group" colspan="2">âœ… Ø§Ù„ØµØ§ÙÙŠ</th>
      <th class="th-group" colspan="${allCols.length}">ğŸ”€ Ø§Ù„ØªÙˆØ²ÙŠØ¹</th>
      <th class="th-group" colspan="2">ğŸ“Š Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
    </tr>
    <tr>
      <th>Ø§Ù„Ø³Ù†Ø©</th>
      <th>Ø§Ù„Ø´Ù‡Ø±</th>
      <th>Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
      <th>Ø§Ù„Ø³ÙƒÙ†</th>
      <th>Ø§Ù„Ù†Ù‚Ù„</th>
      <th>Ø£ÙˆÙØ± ØªØ§ÙŠÙ…</th>
      <th>Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰</th>
      <th>GOSI</th>
      <th>Ø³Ø§Ù†Ø¯</th>
      <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      <th>Ø§Ù„ØµØ§ÙÙŠ</th>
      ${allCols.map(c => `<th>${c.label}</th>`).join('')}
      <th>Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹</th>
      <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
    </tr>`;

  // Body
  if (!filtered.length) {
    document.getElementById('salaryBody').innerHTML = `
      <tr><td colspan="${14 + allCols.length}">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“‹</div>
          <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</p>
        </div>
      </td></tr>`;
    return;
  }

  // Totals row helper
  const totals = {};
  const numFields = ['basic','housing','transport','overtime','other','gosi','saned','gross','net','after_split',...allCols.map(c=>c.id)];
  numFields.forEach(f => { totals[f] = filtered.reduce((s,r)=>s+(r[f]||0),0); });

  document.getElementById('salaryBody').innerHTML =
    filtered.map((r, idx) => {
      const realIdx = records.indexOf(r);
      return `<tr>
        <td class="col-year">${r.year}</td>
        <td class="col-month">${MONTHS[r.month]}</td>
        <td class="col-income"><span class="editable-cell" onclick="editCell(this,${realIdx},'basic')">${H.fmt(r.basic||0,0)}</span></td>
        <td class="col-income"><span class="editable-cell" onclick="editCell(this,${realIdx},'housing')">${H.fmt(r.housing||0,0)}</span></td>
        <td class="col-income"><span class="editable-cell" onclick="editCell(this,${realIdx},'transport')">${H.fmt(r.transport||0,0)}</span></td>
        <td class="col-income"><span class="editable-cell" onclick="editCell(this,${realIdx},'overtime')">${H.fmt(r.overtime||0,0)}</span></td>
        <td class="col-income"><span class="editable-cell" onclick="editCell(this,${realIdx},'other')">${H.fmt(r.other||0,0)}</span></td>
        <td class="col-deduct" style="color:var(--red)"><span class="editable-cell" onclick="editCell(this,${realIdx},'gosi')">${H.fmt(r.gosi||0,0)}</span></td>
        <td class="col-deduct" style="color:var(--red)"><span class="editable-cell" onclick="editCell(this,${realIdx},'saned')">${H.fmt(r.saned||0,0)}</span></td>
        <td class="col-net" style="color:var(--accent)">${H.fmt(r.gross||0,0)}</td>
        <td class="col-net" style="color:var(--green)">${H.fmt(r.net||0,0)}</td>
        ${allCols.map(c => `
          <td class="col-split">
            <span class="editable-cell" onclick="editCell(this,${realIdx},'${c.id}')">${H.fmt(r[c.id]||0,0)}</span>
          </td>`).join('')}
        <td class="col-net" style="color:${(r.after_split||0)>=0?'var(--green)':'var(--red)'}">${H.fmt(r.after_split||0,0)}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteRecord(${realIdx})">ğŸ—‘</button></td>
      </tr>`;
    }).join('') +
    // Totals
    `<tr style="background:var(--bg2);font-weight:700;border-top:2px solid var(--border2)">
      <td colspan="2" style="color:var(--text3);font-size:11px;text-align:center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
      <td class="col-income">${H.fmt(totals.basic,0)}</td>
      <td class="col-income">${H.fmt(totals.housing,0)}</td>
      <td class="col-income">${H.fmt(totals.transport,0)}</td>
      <td class="col-income">${H.fmt(totals.overtime,0)}</td>
      <td class="col-income">${H.fmt(totals.other,0)}</td>
      <td class="col-deduct" style="color:var(--red)">${H.fmt(totals.gosi,0)}</td>
      <td class="col-deduct" style="color:var(--red)">${H.fmt(totals.saned,0)}</td>
      <td class="col-net" style="color:var(--accent)">${H.fmt(totals.gross,0)}</td>
      <td class="col-net" style="color:var(--green)">${H.fmt(totals.net,0)}</td>
      ${allCols.map(c => `<td class="col-split">${H.fmt(totals[c.id]||0,0)}</td>`).join('')}
      <td class="col-net">${H.fmt(totals.after_split,0)}</td>
      <td></td>
    </tr>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Inline Edit Cell
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editCell(span, idx, field) {
  if (span.querySelector('input')) return;
  const input = document.createElement('input');
  input.className = 'cell-input';
  input.type  = 'number';
  input.value = records[idx][field] || 0;
  input.step  = '0.01';
  span.textContent = '';
  span.appendChild(input);
  input.focus(); input.select();

  function commit() {
    const val = parseFloat(input.value);
    if (!isNaN(val)) {
      records[idx][field] = parseFloat(val.toFixed(2));
      // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
      const r = records[idx];
      r.gross       = (r.basic||0)+(r.housing||0)+(r.transport||0)+(r.overtime||0)+(r.other||0);
      r.net         = r.gross - (r.gosi||0) - (r.saned||0);
      const allCols = [...splitCols, { id:'col_invest' }];
      let spent     = allCols.reduce((s,c)=>s+(r[c.id]||0),0);
      r.after_split = parseFloat((r.net - spent).toFixed(2));
    }
    renderTable();
    renderKPIs();
  }
  input.addEventListener('blur', commit);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter')  input.blur();
    if (e.key === 'Escape') renderTable();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Delete Record
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteRecord(idx) {
  const r = records[idx];
  if (!confirm(`Ø­Ø°Ù Ø³Ø¬Ù„ ${MONTHS[r.month]} ${r.year}ØŸ`)) return;
  records.splice(idx, 1);
  renderAll();
  toast('ğŸ—‘ ØªÙ… Ø§Ù„Ø­Ø°Ù', 'warn');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Manage Columns Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showManageColumns() {
  renderColList();
  document.getElementById('colModal').style.display = 'flex';
}

function renderColList() {
  document.getElementById('colList').innerHTML = splitCols.map((c, i) => `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <input class="field-inline" style="flex:1" value="${c.label}"
        onchange="splitCols[${i}].label=this.value">
      <button class="btn btn-danger btn-sm" onclick="removeColumn(${i})">ğŸ—‘</button>
    </div>`).join('');
}

function addColumn() {
  const name = document.getElementById('newColName').value.trim();
  if (!name) return toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯', 'error');
  const id = 'col_' + Date.now();
  splitCols.push({ id, label: name });
  document.getElementById('newColName').value = '';
  renderColList();
  toast('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'success');
}

function removeColumn(i) {
  if (!confirm(`Ø­Ø°Ù Ø¹Ù…ÙˆØ¯ "${splitCols[i].label}"ØŸ`)) return;
  splitCols.splice(i, 1);
  renderColList();
}

function saveColumns() {
  Store.save('salary_cols_v1', splitCols);
  document.getElementById('colModal').style.display = 'none';
  renderSplitFields();
  renderTable();
  toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Export CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const allCols  = [...splitCols, { id:'col_invest', label:'Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯' }];
  const baseH    = ['year','month','basic','housing','transport','overtime','other','gosi','saned','gross','net'];
  const splitH   = allCols.map(c => c.id);
  const headers  = [...baseH, ...splitH, 'after_split'];
  const labelRow = ['Ø§Ù„Ø³Ù†Ø©','Ø§Ù„Ø´Ù‡Ø±','Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ','Ø§Ù„Ø³ÙƒÙ†','Ø§Ù„Ù†Ù‚Ù„','Ø£ÙˆÙØ± ØªØ§ÙŠÙ…','Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰','GOSI','Ø³Ø§Ù†Ø¯','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ','Ø§Ù„ØµØ§ÙÙŠ',...allCols.map(c=>c.label),'Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹'];
  const rows = records.map(r => headers.map(h => r[h]??'').join(','));
  const csv  = '\uFEFF' + [labelRow.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type:'text/csv' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = `salary_records_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  URL.revokeObjectURL(url);
  toast('ğŸ“¥ ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAll() {
  Store.save('salary_v1', records);
  Store.save('salary_cols_v1', splitCols);
  toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render All
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
  renderKPIs();
  renderYearTabs();
  renderTable();
}

// Init
renderSplitFields();
renderAll();
</script>
</body>
</html>
