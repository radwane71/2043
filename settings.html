<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>ุงูุฅุนุฏุงุฏุงุช โ 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
</head>
<body>
<script>initPage('settings');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>โ๏ธ ุงูุฅุนุฏุงุฏุงุช ูุงููุชุบูุฑุงุช</h1>
      <p>ุชุญูู ูุงูู ูู ูู ูุนุงููุงุช ุงููููุน โ ุงูุชุบููุฑุงุช ุชูุนูุณ ููุฑุงู ุนูู ูู ุงูุตูุญุงุช</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-danger  btn-sm" onclick="resetAll()">๐ ุงุณุชุนุงุฏุฉ ุงูุงูุชุฑุงุถู</button>
      <button class="btn btn-primary"        onclick="saveAll()">๐พ ุญูุธ ุงููู</button>
    </div>
  </div>

  <!-- โโ 1. ุฅุนุฏุงุฏุงุช ุนุงูุฉ โโ -->
  <div class="settings-section">
    <div class="settings-section-header">๐ค ุฅุนุฏุงุฏุงุช ุนุงูุฉ</div>
    <div class="settings-section-body">
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุงุณู ุงููุงูู</label>
          <small>ูุธูุฑ ูู ุงูู Sidebar</small>
        </div>
        <input type="text" id="s-ownerName">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุณูุฉ ุงูุชูุงุนุฏ ุงููุณุชูุฏูุฉ</label>
          <small>ุงููุญูุฑ ุงูุฒููู ุงูุฑุฆูุณู</small>
        </div>
        <input type="number" id="s-retirementYear">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุฑุฃุณ ุงููุงู ุงููุณุชูุฏู (SAR)</label>
          <small>ูุฏู ุตุงูู ุงูุซุฑูุฉ ุงููุงูู</small>
        </div>
        <input type="number" id="s-targetCapital">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุนุงุฆุฏ ุงูุชูุฒูุนุงุช ุงููุณุชูุฏู %</label>
          <small>ุงููุณุจุฉ ุงูุณูููุฉ ุงููุทููุจุฉ ุนูู ุฑุฃุณ ุงููุงู</small>
        </div>
        <input type="number" id="s-targetYield" step="0.01">
      </div>
    </div>
  </div>

  <!-- โโ 2. ุงูุนูููุงุช ูุงูุถุฑุงุฆุจ โโ -->
  <div class="settings-section">
    <div class="settings-section-header">๐ธ ุงูุนูููุงุช ูุงูุถุฑุงุฆุจ</div>
    <div class="settings-section-body">
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ูุณุจุฉ ุนูููุฉ ุงูุชุฏุงูู %</label>
          <small>ุชุทุจู ุนูู ูู ุนูููุฉ ุดุฑุงุก ุฃู ุจูุน</small>
        </div>
        <input type="number" id="s-commissionRate" step="0.00001">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ูุณุจุฉ VAT ุนูู ุงูุนูููุฉ %</label>
          <small>ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ</small>
        </div>
        <input type="number" id="s-vatRate" step="0.01">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุงูุญุฏ ุงูุฃุฏูู ููุนูููุฉ (SAR)</label>
          <small>0 = ูุง ููุฌุฏ ุญุฏ ุฃุฏูู</small>
        </div>
        <input type="number" id="s-minCommission" step="0.01">
      </div>
    </div>
  </div>

  <!-- โโ 3. ููุงุนุฏ ุงููุญูุธุฉ โโ -->
  <div class="settings-section">
    <div class="settings-section-header">๐ ููุงุนุฏ ุงููุญูุธุฉ</div>
    <div class="settings-section-body">
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุฃูุตู ุชุฎุตูุต ูุณูู ูุงุญุฏ %</label>
          <small>ุชุฌุงูุฒู ูุนูู ุชุฑููุฒ ูุฑุชูุน</small>
        </div>
        <input type="number" id="s-maxPositionPct" step="0.01">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุฃูุตู ุชุฎุตูุต ููุทุงุน ูุงุญุฏ %</label>
          <small>ููุญูุงูุฉ ูู ุชุฑููุฒ ุงููุทุงุน</small>
        </div>
        <input type="number" id="s-maxSectorPct" step="0.01">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุฃูุตู ุชุฎุตูุต ููุจูู ุดูุจ %</label>
          <small>ุฃุฑุงููู / STC</small>
        </div>
        <input type="number" id="s-blueChipMaxPct" step="0.01">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุงูุญุฏ ุงูุฃุฏูู ูุนุฏุฏ ุงููุฑุงูุฒ</label>
          <small>ุชูููุน ูุงูู</small>
        </div>
        <input type="number" id="s-minPositions">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุงูุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุงููุฑุงูุฒ</label>
          <small>ูุชุฌูุจ ุงูุชุดุชุช</small>
        </div>
        <input type="number" id="s-maxPositions">
      </div>
      <div class="setting-row">
        <div class="setting-row-info">
          <label>ุนุชุจุฉ ุฅุนุงุฏุฉ ุงูุชูุงุฒู %</label>
          <small>ุชูุงูุช ููุจูู ูุจู ุฅุนุงุฏุฉ ุงูุชูุงุฒู</small>
        </div>
        <input type="number" id="s-rebalanceThresh" step="0.01">
      </div>
    </div>
  </div>

  <!-- โโ 4. ุฅุนุฏุงุฏุงุช ุงูุฃุณูู ุงููุฑุฏูุฉ โโ -->
  <div class="settings-section">
    <div class="settings-section-header">๐ ุฅุนุฏุงุฏุงุช ุงูุฃุณูู โ ููุงุทู ุงูุดุฑุงุก ูุงูุจูุน ูุงููุฏู</div>
    <div class="settings-section-body">
      <div class="info-box blue" style="margin-bottom:16px">
        ูุฐู ุงูุจูุงูุงุช ูุฑุจูุทุฉ ูุจุงุดุฑุฉ ุจุตูุญุฉ ุงููุญูุธุฉ. ุงูุชุนุฏูู ููุง ูุญุฏูุซ ุงูุฌุฏูู ุงูุฑุฆูุณู ููุฑุงู ุนูุฏ ุงูุญูุธ.
      </div>
      <div style="overflow:auto">
        <table style="min-width:900px">
          <thead>
            <tr>
              <th>ุงูุณูู</th>
              <th>ุงูุชููุฑ</th>
              <th>ุงููุฏู %</th>
              <th>ุดุฑุงุก &lt;</th>
              <th>ุจูุน ูู</th>
              <th>ุจูุน ุฅูู</th>
              <th>ุงููุฑุงุฑ</th>
              <th>ุงูุชูููู</th>
            </tr>
          </thead>
          <tbody id="stocksSettingsBody"></tbody>
        </table>
      </div>
      <div style="margin-top:12px;text-align:left">
        <button class="btn btn-success" onclick="saveStocksSettings()">๐พ ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุฃุณูู</button>
      </div>
    </div>
  </div>

  <!-- โโ 5. ุจูุงูุงุช ุงูุฌูุณุฉ โโ -->
  <div class="settings-section">
    <div class="settings-section-header">๐๏ธ ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ุงููุญููุธุฉ</div>
    <div class="settings-section-body">
      <div class="info-box yellow" style="margin-bottom:16px">
        โ๏ธ ูุฐู ุงูุจูุงูุงุช ูุญููุธุฉ ูู ุงูุฌูุณุฉ ุงูุญุงููุฉ. ุชููุณุญ ุนูุฏ ุฅุบูุงู ุงููุชุตูุญ ุฅูุง ุฅุฐุง ุญูุธุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
        <button class="btn btn-ghost" onclick="exportBackup()">๐ฆ ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ</button>
        <button class="btn btn-warn"  onclick="document.getElementById('restoreInput').click()">๐ค ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
        <button class="btn btn-danger" onclick="clearSession()">๐ ูุณุญ ูู ุจูุงูุงุช ุงูุฌูุณุฉ</button>
      </div>
      <input id="restoreInput" type="file" accept=".json" style="display:none" onchange="restoreBackup(this)">

      <div style="margin-top:20px">
        <div style="font-size:13px;font-weight:700;color:var(--text2);margin-bottom:10px">ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ุงูุฌูุณุฉ:</div>
        <div id="sessionStatus" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px"></div>
      </div>
    </div>
  </div>

</div>

<script>
// โโ Load settings into fields โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function loadSettings(){
  const s = Store.load('app_settings_v1', APP.settings);
  const f = Store.load('app_fees_v1',     APP.fees);

  document.getElementById('s-ownerName').value       = s.ownerName        || APP.settings.ownerName;
  document.getElementById('s-retirementYear').value  = s.retirementYear   || APP.settings.retirementYear;
  document.getElementById('s-targetCapital').value   = s.targetCapital    || APP.settings.targetCapital;
  document.getElementById('s-targetYield').value     = ((s.targetYield    || APP.settings.targetYield)*100).toFixed(2);
  document.getElementById('s-commissionRate').value  = ((f.commissionRate || APP.fees.commissionRate)*100).toFixed(4);
  document.getElementById('s-vatRate').value         = ((f.vatRate        || APP.fees.vatRate)*100).toFixed(0);
  document.getElementById('s-minCommission').value   = f.minCommission    ?? APP.fees.minCommission;
  document.getElementById('s-maxPositionPct').value  = ((s.maxPositionPct || APP.settings.maxPositionPct)*100).toFixed(0);
  document.getElementById('s-maxSectorPct').value    = ((s.maxSectorPct   || APP.settings.maxSectorPct)*100).toFixed(0);
  document.getElementById('s-blueChipMaxPct').value  = ((s.blueChipMaxPct || APP.settings.blueChipMaxPct)*100).toFixed(0);
  document.getElementById('s-minPositions').value    = s.minPositions     || APP.settings.minPositions;
  document.getElementById('s-maxPositions').value    = s.maxPositions     || APP.settings.maxPositions;
  document.getElementById('s-rebalanceThresh').value = ((s.rebalanceThresh|| APP.settings.rebalanceThresh)*100).toFixed(0);
}

// โโ Stocks settings table โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function loadStocksSettings(){
  const port = Store.load('portfolio_v1', APP.portfolio);
  const decisions = ['ุชุฌููุน','ุงุญุชูุงุธ','ูุฑุงูุจุฉ','ุชุฎููู','ุจูุน'];

  document.getElementById('stocksSettingsBody').innerHTML = port.map((p,i) => `
    <tr>
      <td style="font-weight:600">${p.stock}</td>
      <td class="accent">${p.ticker}</td>
      <td>
        <input class="field-inline" style="width:70px;text-align:center"
          id="sp-goal-${i}" type="number" step="0.1" value="${(p.goal_alloc*100).toFixed(1)}">
      </td>
      <td>
        <input class="field-inline" style="width:80px;text-align:center"
          id="sp-buy-${i}" type="number" step="0.01" value="${p.buy_zone_max}">
      </td>
      <td>
        <input class="field-inline" style="width:80px;text-align:center"
          id="sp-sellL-${i}" type="number" step="0.01" value="${p.sell_zone_low}">
      </td>
      <td>
        <input class="field-inline" style="width:80px;text-align:center"
          id="sp-sellH-${i}" type="number" step="0.01" value="${p.sell_zone_high}">
      </td>
      <td>
        <select class="field-inline" style="width:100px" id="sp-dec-${i}">
          ${decisions.map(d=>`<option ${d===p.decision?'selected':''}>${d}</option>`).join('')}
        </select>
      </td>
      <td>
        <input class="field-inline" style="width:160px" id="sp-eval-${i}" type="text" value="${p.eval}">
      </td>
    </tr>
  `).join('');
}

function saveStocksSettings(){
  const port = Store.load('portfolio_v1', APP.portfolio);
  port.forEach((p,i)=>{
    p.goal_alloc    = parseFloat(document.getElementById(`sp-goal-${i}`).value)/100 || p.goal_alloc;
    p.buy_zone_max  = parseFloat(document.getElementById(`sp-buy-${i}`).value)       || p.buy_zone_max;
    p.sell_zone_low = parseFloat(document.getElementById(`sp-sellL-${i}`).value)     || p.sell_zone_low;
    p.sell_zone_high= parseFloat(document.getElementById(`sp-sellH-${i}`).value)     || p.sell_zone_high;
    p.decision      = document.getElementById(`sp-dec-${i}`).value;
    p.eval          = document.getElementById(`sp-eval-${i}`).value;
  });
  Store.save('portfolio_v1', port);
  toast('โ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุฃุณูู ูุชุญุฏูุซ ุงููุญูุธุฉ','success');
}

// โโ Save all general settings โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function saveAll(){
  const newSettings = {
    ownerName:       document.getElementById('s-ownerName').value,
    retirementYear:  parseInt(document.getElementById('s-retirementYear').value),
    targetCapital:   parseFloat(document.getElementById('s-targetCapital').value),
    targetYield:     parseFloat(document.getElementById('s-targetYield').value)/100,
    maxPositionPct:  parseFloat(document.getElementById('s-maxPositionPct').value)/100,
    maxSectorPct:    parseFloat(document.getElementById('s-maxSectorPct').value)/100,
    blueChipMaxPct:  parseFloat(document.getElementById('s-blueChipMaxPct').value)/100,
    minPositions:    parseInt(document.getElementById('s-minPositions').value),
    maxPositions:    parseInt(document.getElementById('s-maxPositions').value),
    rebalanceThresh: parseFloat(document.getElementById('s-rebalanceThresh').value)/100,
  };
  const newFees = {
    commissionRate:  parseFloat(document.getElementById('s-commissionRate').value)/100,
    vatRate:         parseFloat(document.getElementById('s-vatRate').value)/100,
    minCommission:   parseFloat(document.getElementById('s-minCommission').value)||0,
  };

  // Sync to APP live
  Object.assign(APP.settings, newSettings);
  Object.assign(APP.fees,     newFees);

  Store.save('app_settings_v1', newSettings);
  Store.save('app_fees_v1',     newFees);

  toast('โ ุชู ุงูุญูุธ โ ุงูุฅุนุฏุงุฏุงุช ููุนููุฉ ุงูุขู','success');
  renderSessionStatus();
}

// โโ Reset โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function resetAll(){
  if(!confirm('ุงุณุชุนุงุฏุฉ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉุ')) return;
  Store.save('app_settings_v1', APP.settings);
  Store.save('app_fees_v1',     APP.fees);
  loadSettings();
  toast('๐ ุชูุช ุงูุงุณุชุนุงุฏุฉ','warn');
}

// โโ Backup Export โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function exportBackup(){
  const keys=['portfolio_v1','transactions_v1','dividends_v1',
              'cashinvest_v1','networth_full_v1','properties_v1',
              'app_settings_v1','app_fees_v1'];
  const backup={};
  keys.forEach(k=>{ const v=Store.get(k); if(v) backup[k]=v; });
  backup._exported = new Date().toISOString();
  backup._version  = '2043-v1';

  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(backup,null,2)],{type:'application/json'}));
  a.download=`backup_2043_${H.today()}.json`; a.click();
  toast('๐ฆ ุชู ุชุตุฏูุฑ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุงููุงููุฉ','success');
}

// โโ Backup Restore โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function restoreBackup(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try {
      const data=JSON.parse(e.target.result);
      if(!data._version) return toast('ููู ุบูุฑ ุตุงูุญ','error');
      if(!confirm(`ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ูู ${data._exported?.split('T')[0]||'โ'}ุ ุณูุชู ุงุณุชุจุฏุงู ูู ุงูุจูุงูุงุช ุงูุญุงููุฉ.`)) return;
      Object.entries(data).forEach(([k,v])=>{
        if(!k.startsWith('_')) Store.set(k,v);
      });
      toast('โ ุชูุช ุงูุงุณุชุนุงุฏุฉ โ ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ','success');
      setTimeout(()=>location.reload(), 1500);
    } catch(err){ toast('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู','error'); }
  };
  reader.readAsText(file);
}

// โโ Clear session โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function clearSession(){
  if(!confirm('ูุณุญ ูู ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ุงูุฌูุณุฉุ ูุง ูููู ุงูุชุฑุงุฌุน.')) return;
  try{ sessionStorage.clear(); }catch(e){}
  toast('๐ ุชู ุงููุณุญ โ ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ','warn');
  setTimeout(()=>location.reload(),1200);
}

// โโ Session Status โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function renderSessionStatus(){
  const keys=[
    {k:'portfolio_v1',    label:'ุงููุญูุธุฉ'},
    {k:'transactions_v1', label:'ุงูุนูููุงุช'},
    {k:'dividends_v1',    label:'ุงูุชูุฒูุนุงุช'},
    {k:'cashinvest_v1',   label:'ุงูุณูููุฉ'},
    {k:'networth_full_v1',label:'ุตุงูู ุงูุซุฑูุฉ'},
    {k:'properties_v1',   label:'ุงูุนูุงุฑุงุช'},
    {k:'app_settings_v1', label:'ุงูุฅุนุฏุงุฏุงุช'},
    {k:'app_fees_v1',     label:'ุงูุนูููุงุช'},
  ];
  document.getElementById('sessionStatus').innerHTML=keys.map(({k,label})=>{
    const exists=Store.get(k)!==null;
    return `
      <div style="padding:10px 14px;background:var(--bg2);border:1px solid ${exists?'rgba(34,197,94,.3)':'var(--border)'};border-radius:8px;display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:13px">${label}</span>
        <span style="font-size:11px;font-weight:700;color:${exists?'var(--green)':'var(--text3)'}">${exists?'โ ูุญููุธ':'โฌ ุงูุชุฑุงุถู'}</span>
      </div>`;
  }).join('');
}

// โโ Init โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
loadSettings();
loadStocksSettings();
renderSessionStatus();
</script>
</body>
</html>
