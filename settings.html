<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<link rel="icon" href="data:,">
<title>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â€” 2043</title>
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="assets/tickers.js"></script>
<script src="assets/data.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-sync.js"></script>
<script src="assets/ticker-helper.js"></script>
</head>
<body>
<script>initPage('settings');</script>

<div class="main">

  <div class="page-header">
    <div class="page-header-left">
      <h1>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª</h1>
      <p>ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„ ÙÙŠ ÙƒÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªÙ†Ø¹ÙƒØ³ ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª</p>
    </div>
    <div class="page-header-right">
      <button class="btn btn-danger btn-sm" onclick="resetAll()">ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
      <button class="btn btn-primary"       onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒÙ„</button>
    </div>
  </div>

  <!-- â•â• 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© â•â• -->
  <div class="settings-section">
    <div class="settings-section-header">ğŸ‘¤ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©</div>
    <div class="settings-section-body">
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ</label><small>ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù€ Sidebar</small></div>
        <input type="text" id="s-ownerName">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø³Ù†Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label><small>Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</small></div>
        <input type="number" id="s-retirementYear">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (SAR)</label><small>Ù‡Ø¯Ù ØµØ§ÙÙŠ Ø§Ù„Ø«Ø±ÙˆØ© Ø§Ù„ÙƒØ§Ù…Ù„</small></div>
        <input type="number" id="s-targetCapital">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø¹Ø§Ø¦Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù %</label><small>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</small></div>
        <input type="number" id="s-targetYield" step="0.01">
      </div>
    </div>
  </div>

  <!-- â•â• 2. Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø¶Ø±Ø§Ø¦Ø¨ â•â• -->
  <div class="settings-section">
    <div class="settings-section-header">ğŸ’¸ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø¶Ø±Ø§Ø¦Ø¨</div>
    <div class="settings-section-body">
      <div class="setting-row">
        <div class="setting-row-info"><label>Ù†Ø³Ø¨Ø© Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ %</label><small>ØªØ·Ø¨Ù‚ Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©</small></div>
        <input type="number" id="s-commissionRate" step="0.00001">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ù†Ø³Ø¨Ø© VAT Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© %</label><small>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</small></div>
        <input type="number" id="s-vatRate" step="0.01">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¹Ù…ÙˆÙ„Ø© (SAR)</label><small>0 = Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¯ Ø£Ø¯Ù†Ù‰</small></div>
        <input type="number" id="s-minCommission" step="0.01">
      </div>
    </div>
  </div>

  <!-- â•â• 3. Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© â•â• -->
  <div class="settings-section">
    <div class="settings-section-header">ğŸ“ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
    <div class="settings-section-body">
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø£Ù‚ØµÙ‰ ØªØ®ØµÙŠØµ Ù„Ø³Ù‡Ù… ÙˆØ§Ø­Ø¯ %</label><small>ØªØ¬Ø§ÙˆØ²Ù‡ = ØªØ±ÙƒÙŠØ² Ù…Ø±ØªÙØ¹</small></div>
        <input type="number" id="s-maxPositionPct" step="0.01">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø£Ù‚ØµÙ‰ ØªØ®ØµÙŠØµ Ù„Ù‚Ø·Ø§Ø¹ ÙˆØ§Ø­Ø¯ %</label><small>Ø­Ù…Ø§ÙŠØ© Ù…Ù† ØªØ±ÙƒÙŠØ² Ø§Ù„Ù‚Ø·Ø§Ø¹</small></div>
        <input type="number" id="s-maxSectorPct" step="0.01">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø£Ù‚ØµÙ‰ ØªØ®ØµÙŠØµ Ù„Ù„Ø¨Ù„Ùˆ Ø´ÙŠØ¨ %</label><small>Ø£Ø±Ø§Ù…ÙƒÙˆ / STC</small></div>
        <input type="number" id="s-blueChipMaxPct" step="0.01">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙƒØ²</label><small>ØªÙ†ÙˆÙŠØ¹ ÙƒØ§ÙÙ</small></div>
        <input type="number" id="s-minPositions">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙƒØ²</label><small>Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ´ØªØª</small></div>
        <input type="number" id="s-maxPositions">
      </div>
      <div class="setting-row">
        <div class="setting-row-info"><label>Ø¹ØªØ¨Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ§Ø²Ù† %</label><small>ØªÙØ§ÙˆØª Ù…Ù‚Ø¨ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ§Ø²Ù†</small></div>
        <input type="number" id="s-rebalanceThresh" step="0.01">
      </div>
    </div>
  </div>

  <!-- â•â• 4. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù… â•â• -->
  <div class="settings-section">
    <div class="settings-section-header">ğŸ“‹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù… â€” Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ù‡Ø¯Ù</div>
    <div class="settings-section-body">
      <div class="info-box blue" style="margin-bottom:16px">
        Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ØµÙØ­Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©. Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ ÙŠØ­Ø¯Ù‘Ø« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸.
      </div>
      <div style="overflow:auto">
        <table style="min-width:900px">
          <thead>
            <tr>
              <th>Ø§Ù„Ø³Ù‡Ù…</th><th>Ø§Ù„ØªÙŠÙƒØ±</th><th>Ø§Ù„Ù‡Ø¯Ù %</th>
              <th>Ø´Ø±Ø§Ø¡ &lt;</th><th>Ø¨ÙŠØ¹ Ù…Ù†</th><th>Ø¨ÙŠØ¹ Ø¥Ù„Ù‰</th>
              <th>Ø§Ù„Ù‚Ø±Ø§Ø±</th><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
            </tr>
          </thead>
          <tbody id="stocksSettingsBody"></tbody>
        </table>
      </div>
      <div style="margin-top:12px;text-align:left">
        <button class="btn btn-success" onclick="saveStocksSettings()">ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù…</button>
      </div>
    </div>
  </div>

  <!-- â•â• 5. Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ â€” Ø£Ù‚ØµÙ‰ ØªØºØ·ÙŠØ© â•â• -->
  <div class="settings-section">
    <div class="settings-section-header">ğŸ§° Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ â€” Ø£Ù‚ØµÙ‰ ØªØºØ·ÙŠØ©</div>
    <div class="settings-section-body">

      <div class="info-box blue" style="margin-bottom:16px">
        ğŸ”µ <strong>Ø§Ù„ØªØµØ¯ÙŠØ±:</strong> ÙŠØµÙˆÙ‘Ø± ÙƒÙ„ Ù…ÙØ§ØªÙŠØ­ localStorage Ùˆ sessionStorage (Raw Strings)ØŒ ÙˆÙŠØ£Ø®Ø° Snapshot Ù„Ù„ÙƒÙˆÙƒÙŠØ² Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©ØŒ ÙˆÙŠØ¶ÙŠÙ Ø¨ØµÙ…Ø§Øª SHA-256 Ù„Ù„ØªØ­Ù‚Ù‚.
        <br>
        ğŸŸ¡ <strong>Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:</strong> ÙŠÙ…Ø³Ø­ localStorage Ùˆ sessionStorage Ø«Ù… ÙŠØ¹ÙŠØ¯Ù‡Ø§ Ø­Ø±ÙÙŠØ§Ù‹. Ø«Ù… ÙŠØ³ØªØ¹ÙŠØ¯ Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø¨Ø£ÙØ¶Ù„ Ù…Ø¬Ù‡ÙˆØ¯.
        <br>
        âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©: Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ù‚Ø±Ø§Ø¡Ø©/Ù†Ø³Ø® Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ (Ù…Ø«Ù„ HttpOnly cookies). Ù‡Ø°Ø§ ÙŠÙ‚Ø±Ø¨Ùƒ Ù…Ù† 100% Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ù…Ø§ ÙŠØ³Ù…Ø­ Ø¨Ù‡ Ø§Ù„Ù…ØªØµÙØ­ØŒ Ù„ÙƒÙ†Ù‡ Ù„ÙŠØ³ â€œ100% Ù…Ø·Ù„Ù‚â€ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ÙƒÙ„ Ø§Ù„Ù…ØªØµÙØ­.
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px">
        <button class="btn btn-primary" onclick="exportFullBackup()">
          ğŸ“¦ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø© (JSON)
        </button>
        <label class="btn btn-warn" style="cursor:pointer">
          ğŸ“¤ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
          <input id="restoreInput" type="file" accept=".json" style="display:none"
                 onchange="handleRestoreFile(this)">
        </label>
        <button class="btn btn-ghost btn-sm" onclick="selfCheckNow()">ğŸ” ÙØ­Øµ Ø³Ø±ÙŠØ¹ (Integrity)</button>
        <button class="btn btn-danger btn-sm" onclick="clearSession()">ğŸ—‘ Ù…Ø³Ø­ sessionStorage</button>
        <button class="btn btn-danger btn-sm" onclick="clearLocalStorage()">ğŸ—‘ Ù…Ø³Ø­ localStorage ÙƒØ§Ù…Ù„Ø§Ù‹</button>
      </div>

      <div id="backupFileInfo" style="display:none;margin-bottom:12px;padding:10px 14px;
           background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.25);
           border-radius:8px;font-size:13px">
      </div>

      <div id="restoreBtnWrap" style="display:none;margin-bottom:16px">
        <button class="btn btn-danger" onclick="confirmRestore()">
          â™»ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒØ§Ù…Ù„Ø© (Ù…Ø¹ ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨ØµÙ…Ø§Øª)
        </button>
      </div>

      <div style="font-size:13px;font-weight:700;color:var(--text2);margin-bottom:10px">
        ğŸ“‹ Snapshot Ø³Ø±ÙŠØ¹ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:
      </div>
      <div id="sessionStatus"
           style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
      </div>

    </div>
  </div>

</div>

<script>
let _pendingRestore = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSettings() {
  const s = Store.load('app_settings_v1', APP.settings);
  const f = Store.load('app_fees_v1',     APP.fees);
  document.getElementById('s-ownerName').value       = s.ownerName        || APP.settings.ownerName       || '';
  document.getElementById('s-retirementYear').value  = s.retirementYear   || APP.settings.retirementYear;
  document.getElementById('s-targetCapital').value   = s.targetCapital    || APP.settings.targetCapital;
  document.getElementById('s-targetYield').value     = ((s.targetYield    || APP.settings.targetYield)*100).toFixed(2);
  document.getElementById('s-commissionRate').value  = ((f.commissionRate || APP.fees.commissionRate)*100).toFixed(4);
  document.getElementById('s-vatRate').value         = ((f.vatRate        || APP.fees.vatRate)*100).toFixed(0);
  document.getElementById('s-minCommission').value   = f.minCommission    ?? APP.fees.minCommission;
  document.getElementById('s-maxPositionPct').value  = ((s.maxPositionPct || APP.settings.maxPositionPct)*100).toFixed(0);
  document.getElementById('s-maxSectorPct').value    = ((s.maxSectorPct   || APP.settings.maxSectorPct)*100).toFixed(0);
  document.getElementById('s-blueChipMaxPct').value  = ((s.blueChipMaxPct || APP.settings.blueChipMaxPct)*100).toFixed(0);
  document.getElementById('s-minPositions').value    = s.minPositions     || APP.settings.minPositions;
  document.getElementById('s-maxPositions').value    = s.maxPositions     || APP.settings.maxPositions;
  document.getElementById('s-rebalanceThresh').value = ((s.rebalanceThresh|| APP.settings.rebalanceThresh)*100).toFixed(0);
}

function saveAll() {
  const newSettings = {
    ownerName:       document.getElementById('s-ownerName').value,
    retirementYear:  parseInt(document.getElementById('s-retirementYear').value),
    targetCapital:   parseFloat(document.getElementById('s-targetCapital').value),
    targetYield:     parseFloat(document.getElementById('s-targetYield').value)/100,
    maxPositionPct:  parseFloat(document.getElementById('s-maxPositionPct').value)/100,
    maxSectorPct:    parseFloat(document.getElementById('s-maxSectorPct').value)/100,
    blueChipMaxPct:  parseFloat(document.getElementById('s-blueChipMaxPct').value)/100,
    minPositions:    parseInt(document.getElementById('s-minPositions').value),
    maxPositions:    parseInt(document.getElementById('s-maxPositions').value),
    rebalanceThresh: parseFloat(document.getElementById('s-rebalanceThresh').value)/100,
  };
  const newFees = {
    commissionRate: parseFloat(document.getElementById('s-commissionRate').value)/100,
    vatRate:        parseFloat(document.getElementById('s-vatRate').value)/100,
    minCommission:  parseFloat(document.getElementById('s-minCommission').value)||0,
  };
  Object.assign(APP.settings, newSettings);
  Object.assign(APP.fees,     newFees);
  Store.save('app_settings_v1', newSettings);
  Store.save('app_fees_v1',     newFees);
  toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© â€” Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙØ¹Ù‘Ù„Ø© Ø§Ù„Ø¢Ù†','success');
  renderSessionStatus();

  dataSync.notifyDataChanged('dashboard', { action: 'refresh' });
  dataSync.notifyDataChanged('portfolio', { action: 'refresh' });
  dataSync.notifyDataChanged('transactions', { action: 'refresh' });
}

function resetAll() {
  if (!confirm('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ')) return;
  Store.save('app_settings_v1', APP.settings);
  Store.save('app_fees_v1',     APP.fees);
  loadSettings();
  toast('ğŸ”„ ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©','warn');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadStocksSettings() {
  const port = Store.load('portfolio_v1', APP.portfolio);
  const decisions = ['ØªØ¬Ù…ÙŠØ¹','Ø§Ø­ØªÙØ§Ø¸','Ù…Ø±Ø§Ù‚Ø¨Ø©','ØªØ®ÙÙŠÙ','Ø¨ÙŠØ¹'];
  document.getElementById('stocksSettingsBody').innerHTML = port.map((p,i) => `
    <tr>
      <td style="font-weight:600">${H.tickerName(p.ticker)}</td>
      <td class="accent">${p.ticker}</td>
      <td><input class="field-inline" style="width:70px;text-align:center" id="sp-goal-${i}"  type="number" step="0.1"    value="${(p.goal_alloc*100).toFixed(1)}"></td>
      <td><input class="field-inline" style="width:80px;text-align:center" id="sp-buy-${i}"   type="number" step="0.01"   value="${p.buy_zone_max}"></td>
      <td><input class="field-inline" style="width:80px;text-align:center" id="sp-sellL-${i}" type="number" step="0.01"   value="${p.sell_zone_low}"></td>
      <td><input class="field-inline" style="width:80px;text-align:center" id="sp-sellH-${i}" type="number" step="0.01"   value="${p.sell_zone_high}"></td>
      <td>
        <select class="field-inline" style="width:100px" id="sp-dec-${i}">
          ${decisions.map(d => `<option ${d===p.decision?'selected':''}>${d}</option>`).join('')}
        </select>
      </td>
      <td><input class="field-inline" style="width:160px" id="sp-eval-${i}" type="text" value="${p.eval || ''}"></td>
    </tr>
  `).join('');
}

function saveStocksSettings() {
  const port = Store.load('portfolio_v1', APP.portfolio);
  port.forEach((p,i) => {
    p.goal_alloc     = parseFloat(document.getElementById(`sp-goal-${i}`).value)/100  || p.goal_alloc;
    p.buy_zone_max   = parseFloat(document.getElementById(`sp-buy-${i}`).value)        || p.buy_zone_max;
    p.sell_zone_low  = parseFloat(document.getElementById(`sp-sellL-${i}`).value)      || p.sell_zone_low;
    p.sell_zone_high = parseFloat(document.getElementById(`sp-sellH-${i}`).value)      || p.sell_zone_high;
    p.decision       = document.getElementById(`sp-dec-${i}`).value;
    p.eval           = document.getElementById(`sp-eval-${i}`).value;
  });
  Store.save('portfolio_v1', port);
  toast('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©','success');

  dataSync.notifyDataChanged('dashboard', { action: 'refresh' });
  dataSync.notifyDataChanged('portfolio', { action: 'refresh' });
  dataSync.notifyDataChanged('networth', { action: 'refresh' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  3. Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ + Integrity
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _snapshotStorage(storage) {
  const out = {};
  try {
    for (let i = 0; i < storage.length; i++) {
      const k = storage.key(i);
      out[k] = storage.getItem(k) ?? '';
    }
  } catch (e) {}
  return out;
}

function _parseCookiesRaw(raw) {
  const list = [];
  if (!raw) return list;
  raw.split(';').map(s => s.trim()).filter(Boolean).forEach(pair => {
    const eq = pair.indexOf('=');
    if (eq <= 0) return;
    const name = pair.slice(0, eq).trim();
    const value = pair.slice(eq + 1);
    list.push({ name, value });
  });
  return list;
}

function _setCookieBestEffort(name, value) {
  const secure = location.protocol === 'https:' ? '; Secure' : '';
  // Ù„Ø§ Ù†Ù…Ù„Ùƒ Ø®ØµØ§Ø¦Øµ Path/Domain/Expires Ù…Ù† document.cookieØŒ ÙÙ†Ø¹ÙŠØ¯Ù‡Ø§ Ø¨Ø£Ø¨Ø³Ø· ØµÙŠØºØ© Ù…ÙÙŠØ¯Ø©.
  document.cookie = `${name}=${value}; Path=/; SameSite=Lax${secure}`;
}

function _clearReadableCookiesBestEffort() {
  const now = _parseCookiesRaw(document.cookie);
  now.forEach(c => {
    // Ù…Ø³Ø­ Ø¨Ø£ÙØ¶Ù„ Ù…Ø¬Ù‡ÙˆØ¯. Ù‚Ø¯ Ù„Ø§ ÙŠÙ…Ø³Ø­ ÙƒÙˆÙƒÙŠØ² Ù„Ù‡Ø§ Path/Domain Ù…Ø®ØªÙ„Ù.
    document.cookie = `${c.name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=/`;
  });
}

async function _sha256Hex(str) {
  try {
    if (!window.crypto || !crypto.subtle) return '';
    const enc = new TextEncoder().encode(String(str ?? ''));
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
  } catch (e) {
    return '';
  }
}

async function _hashMapOfRawMap(rawMap) {
  const keys = Object.keys(rawMap || {}).sort();
  const out = {};
  for (const k of keys) {
    out[k] = await _sha256Hex(rawMap[k]);
  }
  return out;
}

function _bytesOfString(str) {
  try { return new Blob([String(str ?? '')]).size; } catch(e) { return 0; }
}

function _sumBytesOfMap(m) {
  let sum = 0;
  Object.keys(m || {}).forEach(k => { sum += _bytesOfString(m[k]); });
  return sum;
}

async function exportFullBackup() {
  const ls = _snapshotStorage(localStorage);
  const ss = _snapshotStorage(sessionStorage);

  const cookiesRaw = String(document.cookie || '');
  const cookiesList = _parseCookiesRaw(cookiesRaw);

  const payload = {
    app: '2043',
    schema: 'raw-storage-snapshot+integrity',
    version: 4,
    exportedAt: new Date().toISOString(),

    localStorage: ls,
    sessionStorage: ss,
    cookiesRaw,

    integrity: {
      algo: 'SHA-256',
      localStorageHashes: await _hashMapOfRawMap(ls),
      sessionStorageHashes: await _hashMapOfRawMap(ss),
      cookiesHash: await _sha256Hex(cookiesRaw),
    },

    stats: {
      localStorageKeys: Object.keys(ls).length,
      sessionStorageKeys: Object.keys(ss).length,
      cookiesCount: cookiesList.length,
      localStorageBytes: _sumBytesOfMap(ls),
      sessionStorageBytes: _sumBytesOfMap(ss),
      cookiesBytes: _bytesOfString(cookiesRaw),
      userAgent: navigator.userAgent,
    }
  };

  const json = JSON.stringify(payload, null, 2);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([json], { type: 'application/json' }));
  a.download = `2043_full_backup_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
  a.click();

  toast(`ğŸ“¦ ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± â€” LS:${payload.stats.localStorageKeys} â€¢ SS:${payload.stats.sessionStorageKeys} â€¢ Cookies:${payload.stats.cookiesCount}`, 'success');
  renderSessionStatus();
}

function handleRestoreFile(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const obj = JSON.parse(reader.result);

      // v4
      if (obj && obj.version === 4 && obj.localStorage && typeof obj.localStorage === 'object') {
        _pendingRestore = { type: 'v4', data: obj };
      }
      // v3
      else if (obj && obj.version === 3 && obj.localStorage && typeof obj.localStorage === 'object') {
        _pendingRestore = { type: 'v3', data: obj };
      }
      // v2
      else if (obj && obj.version === 2 && obj.localStorage && typeof obj.localStorage === 'object') {
        _pendingRestore = { type: 'v2', data: obj };
      }
      // v1 (Ù‚Ø¯ÙŠÙ…)
      else if (obj && !obj.version && typeof obj === 'object') {
        _pendingRestore = { type: 'v1', data: obj };
      }
      else {
        toast('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', 'error');
        return;
      }

      const info = document.getElementById('backupFileInfo');
      info.style.display = 'block';

      const exportedAt = String(obj.exportedAt || obj._exported || 'â€”');
      const lsCount = (_pendingRestore.type === 'v1')
        ? Object.keys(obj).filter(k => !k.startsWith('_')).length
        : Object.keys(obj.localStorage || {}).length;
      const ssCount = (_pendingRestore.type === 'v4' || _pendingRestore.type === 'v3')
        ? Object.keys(obj.sessionStorage || {}).length
        : 0;
      const cookiesCount = (_pendingRestore.type === 'v4')
        ? _parseCookiesRaw(String(obj.cookiesRaw || '')).length
        : 0;

      info.innerHTML = `
        âœ… <strong>Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù…Ù‘Ù„ Ø¨Ù†Ø¬Ø§Ø­</strong><br>
        ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø³Ø®Ø©: <strong>${exportedAt.split('T')[0]}</strong><br>
        ğŸ—‚ localStorage: <strong>${lsCount}</strong><br>
        ğŸ§© sessionStorage: <strong>${ssCount}</strong><br>
        ğŸª cookies (readable): <strong>${cookiesCount}</strong><br>
        ğŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: <strong>${obj.version || 'v1 Ù‚Ø¯ÙŠÙ…'}</strong>
      `;

      document.getElementById('restoreBtnWrap').style.display = 'block';
      toast('âœ… Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©','success');
    } catch (e) {
      toast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù â€” ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ JSON ØµØ§Ù„Ø­','error');
    }
  };
  reader.readAsText(file);
}

async function _verifyAgainst(backup) {
  const report = {
    ok: true,
    ls: { expectedKeys: 0, currentKeys: 0, missing: 0, mismatched: 0 },
    ss: { expectedKeys: 0, currentKeys: 0, missing: 0, mismatched: 0 },
    cookies: { expectedHash: '', currentHash: '', ok: true },
  };

  // localStorage
  const expLS = backup.localStorage || {};
  const curLS = _snapshotStorage(localStorage);
  report.ls.expectedKeys = Object.keys(expLS).length;
  report.ls.currentKeys = Object.keys(curLS).length;

  const expLSHashes = (backup.integrity && backup.integrity.localStorageHashes) || null;
  if (expLSHashes) {
    for (const k of Object.keys(expLSHashes)) {
      if (!(k in curLS)) { report.ok = false; report.ls.missing++; continue; }
      const h = await _sha256Hex(curLS[k]);
      if (h !== expLSHashes[k]) { report.ok = false; report.ls.mismatched++; }
    }
  }

  // sessionStorage
  const expSS = backup.sessionStorage || {};
  const curSS = _snapshotStorage(sessionStorage);
  report.ss.expectedKeys = Object.keys(expSS).length;
  report.ss.currentKeys = Object.keys(curSS).length;

  const expSSHashes = (backup.integrity && backup.integrity.sessionStorageHashes) || null;
  if (expSSHashes) {
    for (const k of Object.keys(expSSHashes)) {
      if (!(k in curSS)) { report.ok = false; report.ss.missing++; continue; }
      const h = await _sha256Hex(curSS[k]);
      if (h !== expSSHashes[k]) { report.ok = false; report.ss.mismatched++; }
    }
  }

  // cookies
  if (backup.integrity && backup.integrity.cookiesHash) {
    report.cookies.expectedHash = backup.integrity.cookiesHash;
    report.cookies.currentHash = await _sha256Hex(String(document.cookie || ''));
    report.cookies.ok = (report.cookies.expectedHash === report.cookies.currentHash);
    if (!report.cookies.ok) report.ok = false;
  }

  return report;
}

async function confirmRestore() {
  if (!_pendingRestore) return toast('Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹','error');
  if (!confirm('âš ï¸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.\nÙ‡Ø°Ø§ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

  try { localStorage.clear(); } catch(e) {}
  try { sessionStorage.clear(); } catch(e) {}

  // cookies (best effort)
  _clearReadableCookiesBestEffort();

  if (_pendingRestore.type === 'v4') {
    const obj = _pendingRestore.data;

    const ls = obj.localStorage || {};
    const ss = obj.sessionStorage || {};
    Object.keys(ls).forEach(k => localStorage.setItem(k, ls[k]));
    Object.keys(ss).forEach(k => sessionStorage.setItem(k, ss[k]));

    const cookiesList = _parseCookiesRaw(String(obj.cookiesRaw || ''));
    cookiesList.forEach(c => _setCookieBestEffort(c.name, c.value));

    const rep = await _verifyAgainst(obj);
    if (rep.ok) {
      toast('âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­ â€” Ù„Ø§ Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ù…ÙƒØªØ´ÙØ©','success');
    } else {
      toast('âš ï¸ ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©ØŒ Ù„ÙƒÙ† ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨ØµÙ…Ø§Øª ÙƒØ´Ù Ø§Ø®ØªÙ„Ø§ÙØ§Øª','warn');
    }

    const info = document.getElementById('backupFileInfo');
    info.style.display = 'block';
    info.style.borderColor = rep.ok ? 'rgba(34,197,94,.25)' : 'rgba(245,158,11,.35)';
    info.style.background = rep.ok ? 'rgba(34,197,94,.07)' : 'rgba(245,158,11,.08)';
    info.innerHTML = `
      ${rep.ok ? 'âœ…' : 'âš ï¸'} <strong>Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù‚Ù‚</strong><br>
      ğŸ—‚ LS: missing ${rep.ls.missing} â€¢ mismatched ${rep.ls.mismatched}<br>
      ğŸ§© SS: missing ${rep.ss.missing} â€¢ mismatched ${rep.ss.mismatched}<br>
      ğŸª Cookies hash: ${rep.cookies.ok ? 'OK' : 'DIFF'}
    `;

  } else if (_pendingRestore.type === 'v3') {
    const ls = _pendingRestore.data.localStorage || {};
    const ss = _pendingRestore.data.sessionStorage || {};
    Object.keys(ls).forEach(k => localStorage.setItem(k, ls[k]));
    Object.keys(ss).forEach(k => sessionStorage.setItem(k, ss[k]));
    toast('â™»ï¸ ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (v3) â€” Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„','success');
  } else if (_pendingRestore.type === 'v2') {
    const ls = _pendingRestore.data.localStorage || {};
    Object.keys(ls).forEach(k => localStorage.setItem(k, ls[k]));
    toast('â™»ï¸ ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (v2) â€” Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„','success');
  } else {
    const obj = _pendingRestore.data;
    Object.keys(obj).forEach(k => {
      if (!k.startsWith('_')) {
        const val = typeof obj[k] === 'string' ? obj[k] : JSON.stringify(obj[k]);
        localStorage.setItem(k, val);
      }
    });
    toast('â™»ï¸ ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (v1) â€” Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„','success');
  }

  renderSessionStatus();
  setTimeout(() => location.reload(), 900);
}

async function selfCheckNow() {
  const ls = _snapshotStorage(localStorage);
  const ss = _snapshotStorage(sessionStorage);
  const cookiesRaw = String(document.cookie || '');

  const payload = {
    localStorage: ls,
    sessionStorage: ss,
    cookiesRaw,
    integrity: {
      algo: 'SHA-256',
      localStorageHashes: await _hashMapOfRawMap(ls),
      sessionStorageHashes: await _hashMapOfRawMap(ss),
      cookiesHash: await _sha256Hex(cookiesRaw),
    },
  };

  const rep = await _verifyAgainst(payload);
  toast(rep.ok ? 'âœ… ÙØ­Øµ Ø³Ø±ÙŠØ¹: ÙƒÙ„ Ø´ÙŠØ¡ Ù…ØªØ·Ø§Ø¨Ù‚' : 'âš ï¸ ÙØ­Øµ Ø³Ø±ÙŠØ¹: ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ø®ØªÙ„Ø§ÙØ§Øª', rep.ok ? 'success' : 'warn');

  const info = document.getElementById('backupFileInfo');
  info.style.display = 'block';
  info.style.borderColor = rep.ok ? 'rgba(34,197,94,.25)' : 'rgba(245,158,11,.35)';
  info.style.background = rep.ok ? 'rgba(34,197,94,.07)' : 'rgba(245,158,11,.08)';
  info.innerHTML = `
    ${rep.ok ? 'âœ…' : 'âš ï¸'} <strong>Integrity Snapshot</strong><br>
    ğŸ—‚ LS keys: <strong>${Object.keys(ls).length}</strong> â€¢ bytes: <strong>${_sumBytesOfMap(ls)}</strong><br>
    ğŸ§© SS keys: <strong>${Object.keys(ss).length}</strong> â€¢ bytes: <strong>${_sumBytesOfMap(ss)}</strong><br>
    ğŸª Cookies (readable): <strong>${_parseCookiesRaw(cookiesRaw).length}</strong>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  4. Ù…Ø³Ø­
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearSession() {
  if (!confirm('Ù…Ø³Ø­ sessionStorageØŸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage Ø³ØªØ¨Ù‚Ù‰.')) return;
  try { sessionStorage.clear(); } catch(e) {}
  toast('ğŸ—‘ ØªÙ… Ù…Ø³Ø­ sessionStorage','warn');
  setTimeout(() => location.reload(), 500);
}

function clearLocalStorage() {
  if (!confirm('âš ï¸ Ù…Ø³Ø­ ÙƒÙ„ localStorageØŸ\n\nØ³ØªÙØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ¹ÙˆØ¯ Ù…Ù† data.js.\nØµØ¯Ù‘Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!')) return;
  try { localStorage.clear(); } catch(e) {}
  toast('ğŸ—‘ ØªÙ… Ù…Ø³Ø­ localStorage â€” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„','warn');
  setTimeout(() => location.reload(), 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  5. Snapshot Ø¹Ø±Ø¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSessionStatus() {
  const container = document.getElementById('sessionStatus');

  const lsKeys = [];
  for (let i = 0; i < localStorage.length; i++) lsKeys.push(localStorage.key(i));
  lsKeys.sort();

  const ssKeys = [];
  try { for (let i = 0; i < sessionStorage.length; i++) ssKeys.push(sessionStorage.key(i)); } catch(e) {}
  ssKeys.sort();

  const cookieCount = _parseCookiesRaw(String(document.cookie || '')).length;

  const labels = {
    'portfolio_v1':     'Ø§Ù„Ù…Ø­ÙØ¸Ø©',
    'transactions_v1':  'Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
    'dividends_v1':     'Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª',
    'cashinvest_v1':    'Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù„Ù„Ø¶Ø®',
    'networth_full_v1': 'ØµØ§ÙÙŠ Ø§Ù„Ø«Ø±ÙˆØ©',
    'properties_v1':    'Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª',
    'app_settings_v1':  'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©',
    'app_fees_v1':      'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª',
    'salary_v1':        'Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨',
    'salary_scale_v1':  'Ø³Ù„Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨',
    'custom_tickers':   'ØªÙŠÙƒØ±Ø§Øª Ù…Ø®ØµØµØ©',
    'forecast_v1':      'Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª',
  };

  const topCards = `
    <div style="padding:10px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px">
      <div style="font-size:13px;font-weight:700">localStorage</div>
      <div style="font-size:11px;color:var(--text3)">${lsKeys.length} keys â€¢ ${_sumBytesOfMap(_snapshotStorage(localStorage))} bytes</div>
    </div>
    <div style="padding:10px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px">
      <div style="font-size:13px;font-weight:700">sessionStorage</div>
      <div style="font-size:11px;color:var(--text3)">${ssKeys.length} keys â€¢ ${_sumBytesOfMap(_snapshotStorage(sessionStorage))} bytes</div>
    </div>
    <div style="padding:10px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px">
      <div style="font-size:13px;font-weight:700">Cookies (readable)</div>
      <div style="font-size:11px;color:var(--text3)">${cookieCount} items</div>
    </div>
  `;

  if (!lsKeys.length) {
    container.innerHTML = topCards + '<div style="grid-column:1/-1"><p style="color:var(--text3);font-size:13px;margin:0">localStorage ÙØ§Ø±Øº â€” ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ£ØªÙŠ Ù…Ù† data.js</p></div>';
    return;
  }

  const keyCards = lsKeys.map(k => {
    const raw = localStorage.getItem(k);
    let sizeKB = (new Blob([raw]).size / 1024).toFixed(1);
    let count  = '';
    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) count = ` â€¢ ${parsed.length} Ø¹Ù†ØµØ±`;
    } catch(e) {}
    return `
      <div style="padding:10px 14px;background:var(--bg2);border:1px solid rgba(34,197,94,.3);
                  border-radius:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-size:13px;font-weight:600">${labels[k] || k}</span>
          <span style="font-size:10px;color:var(--green);font-weight:700">âœ…</span>
        </div>
        <div style="font-size:11px;color:var(--text3)">${sizeKB} KB${count}</div>
        ${k !== (labels[k] || k) ? `<div style="font-size:10px;color:var(--text3);margin-top:2px;font-family:monospace">${k}</div>` : ''}
      </div>`;
  }).join('');

  container.innerHTML = topCards + keyCards;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadSettings();
loadStocksSettings();
renderSessionStatus();
</script>
</body>
</html>
